"use strict";var sa=Object.create;var Fr=Object.defineProperty;var na=Object.getOwnPropertyDescriptor;var oa=Object.getOwnPropertyNames;var ia=Object.getPrototypeOf,aa=Object.prototype.hasOwnProperty;var W=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),la=(t,e)=>{for(var r in e)Fr(t,r,{get:e[r],enumerable:!0})},ca=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of oa(e))!aa.call(t,n)&&n!==r&&Fr(t,n,{get:()=>e[n],enumerable:!(s=na(e,n))||s.enumerable});return t};var Qt=(t,e,r)=>(r=t!=null?sa(ia(t)):{},ca(e||!t||!t.__esModule?Fr(r,"default",{value:t,enumerable:!0}):r,t));var me=W(Sr=>{"use strict";Sr.getBooleanOption=(t,e)=>{let r=!1;if(e in t&&typeof(r=t[e])!="boolean")throw new TypeError(`Expected the "${e}" option to be a boolean`);return r};Sr.cppdb=Symbol();Sr.inspect=Symbol.for("nodejs.util.inspect.custom")});var zs=W((Ap,Wo)=>{"use strict";var Gs={value:"SqliteError",writable:!0,enumerable:!1,configurable:!0};function Ae(t,e){if(new.target!==Ae)return new Ae(t,e);if(typeof e!="string")throw new TypeError("Expected second argument to be a string");Error.call(this,t),Gs.value=""+t,Object.defineProperty(this,"message",Gs),Error.captureStackTrace(this,Ae),this.code=e}Object.setPrototypeOf(Ae,Error);Object.setPrototypeOf(Ae.prototype,Error.prototype);Object.defineProperty(Ae.prototype,"name",Gs);Wo.exports=Ae});var Yo=W((Op,Jo)=>{var Er=require("path").sep||"/";Jo.exports=La;function La(t){if(typeof t!="string"||t.length<=7||t.substring(0,7)!="file://")throw new TypeError("must pass in a file:// URI to convert to a file path");var e=decodeURI(t.substring(7)),r=e.indexOf("/"),s=e.substring(0,r),n=e.substring(r+1);return s=="localhost"&&(s=""),s&&(s=Er+Er+s),n=n.replace(/^(.+)\|/,"$1:"),Er=="\\"&&(n=n.replace(/\//g,"\\")),/^.+\:/.test(n)||(n=Er+n),s+n}});var ti=W((Ye,ei)=>{var Hs=require("fs"),Tr=require("path"),Fa=Yo(),Ir=Tr.join,Da=Tr.dirname,Xo=Hs.accessSync&&function(t){try{Hs.accessSync(t)}catch{return!1}return!0}||Hs.existsSync||Tr.existsSync,Zo={arrow:process.env.NODE_BINDINGS_ARROW||" \u2192 ",compiled:process.env.NODE_BINDINGS_COMPILED_DIR||"compiled",platform:process.platform,arch:process.arch,nodePreGyp:"node-v"+process.versions.modules+"-"+process.platform+"-"+process.arch,version:process.versions.node,bindings:"bindings.node",try:[["module_root","build","bindings"],["module_root","build","Debug","bindings"],["module_root","build","Release","bindings"],["module_root","out","Debug","bindings"],["module_root","Debug","bindings"],["module_root","out","Release","bindings"],["module_root","Release","bindings"],["module_root","build","default","bindings"],["module_root","compiled","version","platform","arch","bindings"],["module_root","addon-build","release","install-root","bindings"],["module_root","addon-build","debug","install-root","bindings"],["module_root","addon-build","default","install-root","bindings"],["module_root","lib","binding","nodePreGyp","bindings"]]};function Qa(t){typeof t=="string"?t={bindings:t}:t||(t={}),Object.keys(Zo).map(function(l){l in t||(t[l]=Zo[l])}),t.module_root||(t.module_root=Ye.getRoot(Ye.getFileName())),Tr.extname(t.bindings)!=".node"&&(t.bindings+=".node");for(var e=typeof __webpack_require__=="function"?__non_webpack_require__:require,r=[],s=0,n=t.try.length,o,i,a;s<n;s++){o=Ir.apply(null,t.try[s].map(function(l){return t[l]||l})),r.push(o);try{return i=t.path?e.resolve(o):e(o),t.path||(i.path=o),i}catch(l){if(l.code!=="MODULE_NOT_FOUND"&&l.code!=="QUALIFIED_PATH_RESOLUTION_FAILED"&&!/not find/i.test(l.message))throw l}}throw a=new Error(`Could not locate the bindings file. Tried:
`+r.map(function(l){return t.arrow+l}).join(`
`)),a.tries=r,a}ei.exports=Ye=Qa;Ye.getFileName=function(e){var r=Error.prepareStackTrace,s=Error.stackTraceLimit,n={},o;Error.stackTraceLimit=10,Error.prepareStackTrace=function(a,l){for(var c=0,d=l.length;c<d;c++)if(o=l[c].getFileName(),o!==__filename)if(e){if(o!==e)return}else return},Error.captureStackTrace(n),n.stack,Error.prepareStackTrace=r,Error.stackTraceLimit=s;var i="file://";return o.indexOf(i)===0&&(o=Fa(o)),o};Ye.getRoot=function(e){for(var r=Da(e),s;;){if(r==="."&&(r=process.cwd()),Xo(Ir(r,"package.json"))||Xo(Ir(r,"node_modules")))return r;if(s===r)throw new Error('Could not find module root given file: "'+e+'". Do you have a `package.json` file? ');s=r,r=Ir(r,"..")}}});var ri=W(Ie=>{"use strict";var{cppdb:ue}=me();Ie.prepare=function(e){return this[ue].prepare(e,this,!1)};Ie.exec=function(e){return this[ue].exec(e),this};Ie.close=function(){return this[ue].close(),this};Ie.loadExtension=function(...e){return this[ue].loadExtension(...e),this};Ie.defaultSafeIntegers=function(...e){return this[ue].defaultSafeIntegers(...e),this};Ie.unsafeMode=function(...e){return this[ue].unsafeMode(...e),this};Ie.getters={name:{get:function(){return this[ue].name},enumerable:!0},open:{get:function(){return this[ue].open},enumerable:!0},inTransaction:{get:function(){return this[ue].inTransaction},enumerable:!0},readonly:{get:function(){return this[ue].readonly},enumerable:!0},memory:{get:function(){return this[ue].memory},enumerable:!0}}});var oi=W((_p,ni)=>{"use strict";var{cppdb:Ua}=me(),si=new WeakMap;ni.exports=function(e){if(typeof e!="function")throw new TypeError("Expected first argument to be a function");let r=this[Ua],s=Ka(r,this),{apply:n}=Function.prototype,o={default:{value:Cr(n,e,r,s.default)},deferred:{value:Cr(n,e,r,s.deferred)},immediate:{value:Cr(n,e,r,s.immediate)},exclusive:{value:Cr(n,e,r,s.exclusive)},database:{value:this,enumerable:!0}};return Object.defineProperties(o.default.value,o),Object.defineProperties(o.deferred.value,o),Object.defineProperties(o.immediate.value,o),Object.defineProperties(o.exclusive.value,o),o.default.value};var Ka=(t,e)=>{let r=si.get(t);if(!r){let s={commit:t.prepare("COMMIT",e,!1),rollback:t.prepare("ROLLBACK",e,!1),savepoint:t.prepare("SAVEPOINT `	_bs3.	`",e,!1),release:t.prepare("RELEASE `	_bs3.	`",e,!1),rollbackTo:t.prepare("ROLLBACK TO `	_bs3.	`",e,!1)};si.set(t,r={default:Object.assign({begin:t.prepare("BEGIN",e,!1)},s),deferred:Object.assign({begin:t.prepare("BEGIN DEFERRED",e,!1)},s),immediate:Object.assign({begin:t.prepare("BEGIN IMMEDIATE",e,!1)},s),exclusive:Object.assign({begin:t.prepare("BEGIN EXCLUSIVE",e,!1)},s)})}return r},Cr=(t,e,r,{begin:s,commit:n,rollback:o,savepoint:i,release:a,rollbackTo:l})=>function(){let d,m,y;r.inTransaction?(d=i,m=a,y=l):(d=s,m=n,y=o),d.run();try{let S=t.call(e,this,arguments);if(S&&typeof S.then=="function")throw new TypeError("Transaction function cannot return a promise");return m.run(),S}catch(S){throw r.inTransaction&&(y.run(),y!==o&&m.run()),S}}});var ai=W((Bp,ii)=>{"use strict";var{getBooleanOption:Ga,cppdb:za}=me();ii.exports=function(e,r){if(r==null&&(r={}),typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof r!="object")throw new TypeError("Expected second argument to be an options object");let s=Ga(r,"simple"),n=this[za].prepare(`PRAGMA ${e}`,this,!0);return s?n.pluck().get():n.all()}});var ui=W((Pp,ci)=>{"use strict";var Ha=require("fs"),Va=require("path"),{promisify:ka}=require("util"),{cppdb:Wa}=me(),li=ka(Ha.access);ci.exports=async function(e,r){if(r==null&&(r={}),typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof r!="object")throw new TypeError("Expected second argument to be an options object");e=e.trim();let s="attached"in r?r.attached:"main",n="progress"in r?r.progress:null;if(!e)throw new TypeError("Backup filename cannot be an empty string");if(e===":memory:")throw new TypeError('Invalid backup filename ":memory:"');if(typeof s!="string")throw new TypeError('Expected the "attached" option to be a string');if(!s)throw new TypeError('The "attached" option cannot be an empty string');if(n!=null&&typeof n!="function")throw new TypeError('Expected the "progress" option to be a function');await li(Va.dirname(e)).catch(()=>{throw new TypeError("Cannot save backup because the directory does not exist")});let o=await li(e).then(()=>!1,()=>!0);return Ja(this[Wa].backup(this,s,e,o),n||null)};var Ja=(t,e)=>{let r=0,s=!0;return new Promise((n,o)=>{setImmediate(function i(){try{let a=t.transfer(r);if(!a.remainingPages){t.close(),n(a);return}if(s&&(s=!1,r=100),e){let l=e(a);if(l!==void 0)if(typeof l=="number"&&l===l)r=Math.max(0,Math.min(2147483647,Math.round(l)));else throw new TypeError("Expected progress callback to return a number or undefined")}setImmediate(i)}catch(a){t.close(),o(a)}})})}});var fi=W((Lp,di)=>{"use strict";var{cppdb:Ya}=me();di.exports=function(e){if(e==null&&(e={}),typeof e!="object")throw new TypeError("Expected first argument to be an options object");let r="attached"in e?e.attached:"main";if(typeof r!="string")throw new TypeError('Expected the "attached" option to be a string');if(!r)throw new TypeError('The "attached" option cannot be an empty string');return this[Ya].serialize(r)}});var mi=W((Fp,pi)=>{"use strict";var{getBooleanOption:jr,cppdb:Xa}=me();pi.exports=function(e,r,s){if(r==null&&(r={}),typeof r=="function"&&(s=r,r={}),typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof s!="function")throw new TypeError("Expected last argument to be a function");if(typeof r!="object")throw new TypeError("Expected second argument to be an options object");if(!e)throw new TypeError("User-defined function name cannot be an empty string");let n="safeIntegers"in r?+jr(r,"safeIntegers"):2,o=jr(r,"deterministic"),i=jr(r,"directOnly"),a=jr(r,"varargs"),l=-1;if(!a){if(l=s.length,!Number.isInteger(l)||l<0)throw new TypeError("Expected function.length to be a positive integer");if(l>100)throw new RangeError("User-defined functions cannot have more than 100 arguments")}return this[Xa].function(s,e,l,n,o,i),this}});var yi=W((Dp,gi)=>{"use strict";var{getBooleanOption:qr,cppdb:Za}=me();gi.exports=function(e,r){if(typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof r!="object"||r===null)throw new TypeError("Expected second argument to be an options object");if(!e)throw new TypeError("User-defined function name cannot be an empty string");let s="start"in r?r.start:null,n=Vs(r,"step",!0),o=Vs(r,"inverse",!1),i=Vs(r,"result",!1),a="safeIntegers"in r?+qr(r,"safeIntegers"):2,l=qr(r,"deterministic"),c=qr(r,"directOnly"),d=qr(r,"varargs"),m=-1;if(!d&&(m=Math.max(hi(n),o?hi(o):0),m>0&&(m-=1),m>100))throw new RangeError("User-defined functions cannot have more than 100 arguments");return this[Za].aggregate(s,n,o,i,e,m,a,l,c),this};var Vs=(t,e,r)=>{let s=e in t?t[e]:null;if(typeof s=="function")return s;if(s!=null)throw new TypeError(`Expected the "${e}" option to be a function`);if(r)throw new TypeError(`Missing required option "${e}"`);return null},hi=({length:t})=>{if(Number.isInteger(t)&&t>=0)return t;throw new TypeError("Expected function.length to be a positive integer")}});var xi=W((Qp,vi)=>{"use strict";var{cppdb:el}=me();vi.exports=function(e,r){if(typeof e!="string")throw new TypeError("Expected first argument to be a string");if(!e)throw new TypeError("Virtual table module name cannot be an empty string");let s=!1;if(typeof r=="object"&&r!==null)s=!0,r=ll(bi(r,"used",e));else{if(typeof r!="function")throw new TypeError("Expected second argument to be a function or a table definition object");r=tl(r)}return this[el].table(r,e,s),this};function tl(t){return function(r,s,n,...o){let i={module:r,database:s,table:n},a=il.call(t,i,o);if(typeof a!="object"||a===null)throw new TypeError(`Virtual table module "${r}" did not return a table definition object`);return bi(a,"returned",r)}}function bi(t,e,r){if(!St.call(t,"rows"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition without a "rows" property`);if(!St.call(t,"columns"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition without a "columns" property`);let s=t.rows;if(typeof s!="function"||Object.getPrototypeOf(s)!==al)throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "rows" property (should be a generator function)`);let n=t.columns;if(!Array.isArray(n)||!(n=[...n]).every(c=>typeof c=="string"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "columns" property (should be an array of strings)`);if(n.length!==new Set(n).size)throw new TypeError(`Virtual table module "${r}" ${e} a table definition with duplicate column names`);if(!n.length)throw new RangeError(`Virtual table module "${r}" ${e} a table definition with zero columns`);let o;if(St.call(t,"parameters")){if(o=t.parameters,!Array.isArray(o)||!(o=[...o]).every(c=>typeof c=="string"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "parameters" property (should be an array of strings)`)}else o=ol(s);if(o.length!==new Set(o).size)throw new TypeError(`Virtual table module "${r}" ${e} a table definition with duplicate parameter names`);if(o.length>32)throw new RangeError(`Virtual table module "${r}" ${e} a table definition with more than the maximum number of 32 parameters`);for(let c of o)if(n.includes(c))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with column "${c}" which was ambiguously defined as both a column and parameter`);let i=2;if(St.call(t,"safeIntegers")){let c=t.safeIntegers;if(typeof c!="boolean")throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "safeIntegers" property (should be a boolean)`);i=+c}let a=!1;if(St.call(t,"directOnly")&&(a=t.directOnly,typeof a!="boolean"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "directOnly" property (should be a boolean)`);return[`CREATE TABLE x(${[...o.map(wi).map(c=>`${c} HIDDEN`),...n.map(wi)].join(", ")});`,rl(s,new Map(n.map((c,d)=>[c,o.length+d])),r),o,i,a]}function rl(t,e,r){return function*(...n){let o=n.map(i=>Buffer.isBuffer(i)?Buffer.from(i):i);for(let i=0;i<e.size;++i)o.push(null);for(let i of t(...n))if(Array.isArray(i))sl(i,o,e.size,r),yield o;else if(typeof i=="object"&&i!==null)nl(i,o,e,r),yield o;else throw new TypeError(`Virtual table module "${r}" yielded something that isn't a valid row object`)}}function sl(t,e,r,s){if(t.length!==r)throw new TypeError(`Virtual table module "${s}" yielded a row with an incorrect number of columns`);let n=e.length-r;for(let o=0;o<r;++o)e[o+n]=t[o]}function nl(t,e,r,s){let n=0;for(let o of Object.keys(t)){let i=r.get(o);if(i===void 0)throw new TypeError(`Virtual table module "${s}" yielded a row with an undeclared column "${o}"`);e[i]=t[o],n+=1}if(n!==r.size)throw new TypeError(`Virtual table module "${s}" yielded a row with missing columns`)}function ol({length:t}){if(!Number.isInteger(t)||t<0)throw new TypeError("Expected function.length to be a positive integer");let e=[];for(let r=0;r<t;++r)e.push(`$${r+1}`);return e}var{hasOwnProperty:St}=Object.prototype,{apply:il}=Function.prototype,al=Object.getPrototypeOf(function*(){}),wi=t=>`"${t.replace(/"/g,'""')}"`,ll=t=>()=>t});var Ei=W((Up,Si)=>{"use strict";var cl=function(){};Si.exports=function(e,r){return Object.assign(new cl,this)}});var ji=W((Kp,Ci)=>{"use strict";var ul=require("fs"),Ii=require("path"),Nr=me(),dl=zs(),Ti;function H(t,e){if(new.target==null)return new H(t,e);let r;if(Buffer.isBuffer(t)&&(r=t,t=":memory:"),t==null&&(t=""),e==null&&(e={}),typeof t!="string")throw new TypeError("Expected first argument to be a string");if(typeof e!="object")throw new TypeError("Expected second argument to be an options object");if("readOnly"in e)throw new TypeError('Misspelled option "readOnly" should be "readonly"');if("memory"in e)throw new TypeError('Option "memory" was removed in v7.0.0 (use ":memory:" filename instead)');let s=t.trim(),n=s===""||s===":memory:",o=Nr.getBooleanOption(e,"readonly"),i=Nr.getBooleanOption(e,"fileMustExist"),a="timeout"in e?e.timeout:5e3,l="verbose"in e?e.verbose:null,c="nativeBinding"in e?e.nativeBinding:null;if(o&&n&&!r)throw new TypeError("In-memory/temporary databases cannot be readonly");if(!Number.isInteger(a)||a<0)throw new TypeError('Expected the "timeout" option to be a positive integer');if(a>2147483647)throw new RangeError('Option "timeout" cannot be greater than 2147483647');if(l!=null&&typeof l!="function")throw new TypeError('Expected the "verbose" option to be a function');if(c!=null&&typeof c!="string"&&typeof c!="object")throw new TypeError('Expected the "nativeBinding" option to be a string or addon object');let d;if(c==null?d=Ti||(Ti=ti()("better_sqlite3.node")):typeof c=="string"?d=(typeof __non_webpack_require__=="function"?__non_webpack_require__:require)(Ii.resolve(c).replace(/(\.node)?$/,".node")):d=c,d.isInitialized||(d.setErrorConstructor(dl),d.isInitialized=!0),!n&&!ul.existsSync(Ii.dirname(s)))throw new TypeError("Cannot open database because the directory does not exist");Object.defineProperties(this,{[Nr.cppdb]:{value:new d.Database(s,t,n,o,i,a,l||null,r||null)},...Oe.getters})}var Oe=ri();H.prototype.prepare=Oe.prepare;H.prototype.transaction=oi();H.prototype.pragma=ai();H.prototype.backup=ui();H.prototype.serialize=fi();H.prototype.function=mi();H.prototype.aggregate=yi();H.prototype.table=xi();H.prototype.loadExtension=Oe.loadExtension;H.prototype.exec=Oe.exec;H.prototype.close=Oe.close;H.prototype.defaultSafeIntegers=Oe.defaultSafeIntegers;H.prototype.unsafeMode=Oe.unsafeMode;H.prototype[Nr.inspect]=Ei();Ci.exports=H});var qi=W((Gp,ks)=>{"use strict";ks.exports=ji();ks.exports.SqliteError=zs()});var Dr=(t,e,r)=>(s,n)=>{let o=-1;return i(0);async function i(a){if(a<=o)throw new Error("next() called multiple times");o=a;let l,c=!1,d;if(t[a]?(d=t[a][0][0],s.req.routeIndex=a):d=a===t.length&&n||void 0,d)try{l=await d(s,()=>i(a+1))}catch(m){if(m instanceof Error&&e)s.error=m,l=await e(m,s),c=!0;else throw m}else s.finalized===!1&&r&&(l=await r(s));return l&&(s.finalized===!1||c)&&(s.res=l),s}};var Mn=Symbol();var $n=async(t,e=Object.create(null))=>{let{all:r=!1,dot:s=!1}=e,o=(t instanceof Ut?t.raw.headers:t.headers).get("Content-Type");return o?.startsWith("multipart/form-data")||o?.startsWith("application/x-www-form-urlencoded")?ua(t,{all:r,dot:s}):{}};async function ua(t,e){let r=await t.formData();return r?da(r,e):{}}function da(t,e){let r=Object.create(null);return t.forEach((s,n)=>{e.all||n.endsWith("[]")?fa(r,n,s):r[n]=s}),e.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(pa(r,s,n),delete r[s])}),r}var fa=(t,e,r)=>{t[e]!==void 0?Array.isArray(t[e])?t[e].push(r):t[e]=[t[e],r]:e.endsWith("[]")?t[e]=[r]:t[e]=r},pa=(t,e,r)=>{let s=t,n=e.split(".");n.forEach((o,i)=>{i===n.length-1?s[o]=r:((!s[o]||typeof s[o]!="object"||Array.isArray(s[o])||s[o]instanceof File)&&(s[o]=Object.create(null)),s=s[o])})};var Ur=t=>{let e=t.split("/");return e[0]===""&&e.shift(),e},An=t=>{let{groups:e,path:r}=ma(t),s=Ur(r);return ha(s,e)},ma=t=>{let e=[];return t=t.replace(/\{[^}]+\}/g,(r,s)=>{let n=`@${s}`;return e.push([n,r]),n}),{groups:e,path:t}},ha=(t,e)=>{for(let r=e.length-1;r>=0;r--){let[s]=e[r];for(let n=t.length-1;n>=0;n--)if(t[n].includes(s)){t[n]=t[n].replace(s,e[r][1]);break}}return t},Kt={},On=(t,e)=>{if(t==="*")return"*";let r=t.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){let s=`${t}#${e}`;return Kt[s]||(r[2]?Kt[s]=e&&e[0]!==":"&&e[0]!=="*"?[s,r[1],new RegExp(`^${r[2]}(?=/${e})`)]:[t,r[1],new RegExp(`^${r[2]}$`)]:Kt[s]=[t,r[1],!0]),Kt[s]}return null},Gt=(t,e)=>{try{return e(t)}catch{return t.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return e(r)}catch{return r}})}},ga=t=>Gt(t,decodeURI),Kr=t=>{let e=t.url,r=e.indexOf("/",e.charCodeAt(9)===58?13:8),s=r;for(;s<e.length;s++){let n=e.charCodeAt(s);if(n===37){let o=e.indexOf("?",s),i=e.slice(r,o===-1?void 0:o);return ga(i.includes("%25")?i.replace(/%25/g,"%2525"):i)}else if(n===63)break}return e.slice(r,s)};var Rn=t=>{let e=Kr(t);return e.length>1&&e.at(-1)==="/"?e.slice(0,-1):e},Te=(t,e,...r)=>(r.length&&(e=Te(e,...r)),`${t?.[0]==="/"?"":"/"}${t}${e==="/"?"":`${t?.at(-1)==="/"?"":"/"}${e?.[0]==="/"?e.slice(1):e}`}`),zt=t=>{if(t.charCodeAt(t.length-1)!==63||!t.includes(":"))return null;let e=t.split("/"),r=[],s="";return e.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);let o=n.replace("?","");s+="/"+o,r.push(s)}else s+="/"+n}),r.filter((n,o,i)=>i.indexOf(n)===o)},Qr=t=>/[%+]/.test(t)?(t.indexOf("+")!==-1&&(t=t.replace(/\+/g," ")),t.indexOf("%")!==-1?Gt(t,Gr):t):t,_n=(t,e,r)=>{let s;if(!r&&e&&!/[%+]/.test(e)){let i=t.indexOf(`?${e}`,8);for(i===-1&&(i=t.indexOf(`&${e}`,8));i!==-1;){let a=t.charCodeAt(i+e.length+1);if(a===61){let l=i+e.length+2,c=t.indexOf("&",l);return Qr(t.slice(l,c===-1?void 0:c))}else if(a==38||isNaN(a))return"";i=t.indexOf(`&${e}`,i+1)}if(s=/[%+]/.test(t),!s)return}let n={};s??=/[%+]/.test(t);let o=t.indexOf("?",8);for(;o!==-1;){let i=t.indexOf("&",o+1),a=t.indexOf("=",o);a>i&&i!==-1&&(a=-1);let l=t.slice(o+1,a===-1?i===-1?void 0:i:a);if(s&&(l=Qr(l)),o=i,l==="")continue;let c;a===-1?c="":(c=t.slice(a+1,i===-1?void 0:i),s&&(c=Qr(c))),r?(n[l]&&Array.isArray(n[l])||(n[l]=[]),n[l].push(c)):n[l]??=c}return e?n[e]:n},Bn=_n,Pn=(t,e)=>_n(t,e,!0),Gr=decodeURIComponent;var Ln=t=>Gt(t,Gr),Ut=class{raw;#t;#e;routeIndex=0;path;bodyCache={};constructor(t,e="/",r=[[]]){this.raw=t,this.path=e,this.#e=r,this.#t={}}param(t){return t?this.#r(t):this.#o()}#r(t){let e=this.#e[0][this.routeIndex][1][t],r=this.#n(e);return r?/\%/.test(r)?Ln(r):r:void 0}#o(){let t={},e=Object.keys(this.#e[0][this.routeIndex][1]);for(let r of e){let s=this.#n(this.#e[0][this.routeIndex][1][r]);s&&typeof s=="string"&&(t[r]=/\%/.test(s)?Ln(s):s)}return t}#n(t){return this.#e[1]?this.#e[1][t]:t}query(t){return Bn(this.url,t)}queries(t){return Pn(this.url,t)}header(t){if(t)return this.raw.headers.get(t)??void 0;let e={};return this.raw.headers.forEach((r,s)=>{e[s]=r}),e}async parseBody(t){return this.bodyCache.parsedBody??=await $n(this,t)}#s=t=>{let{bodyCache:e,raw:r}=this,s=e[t];if(s)return s;let n=Object.keys(e)[0];return n?e[n].then(o=>(n==="json"&&(o=JSON.stringify(o)),new Response(o)[t]())):e[t]=r[t]()};json(){return this.#s("text").then(t=>JSON.parse(t))}text(){return this.#s("text")}arrayBuffer(){return this.#s("arrayBuffer")}blob(){return this.#s("blob")}formData(){return this.#s("formData")}addValidatedData(t,e){this.#t[t]=e}valid(t){return this.#t[t]}get url(){return this.raw.url}get method(){return this.raw.method}get[Mn](){return this.#e}get matchedRoutes(){return this.#e[0].map(([[,t]])=>t)}get routePath(){return this.#e[0].map(([[,t]])=>t)[this.routeIndex].path}};var Fn={Stringify:1,BeforeStream:2,Stream:3},ya=(t,e)=>{let r=new String(t);return r.isEscaped=!0,r.callbacks=e,r};var zr=async(t,e,r,s,n)=>{typeof t=="object"&&!(t instanceof String)&&(t instanceof Promise||(t=t.toString()),t instanceof Promise&&(t=await t));let o=t.callbacks;if(!o?.length)return Promise.resolve(t);n?n[0]+=t:n=[t];let i=Promise.all(o.map(a=>a({phase:e,buffer:n,context:s}))).then(a=>Promise.all(a.filter(Boolean).map(l=>zr(l,e,!1,s,n))).then(()=>n[0]));return r?ya(await i,o):i};var wa="text/plain; charset=UTF-8",Hr=(t,e)=>({"Content-Type":t,...e}),Dn=class{#t;#e;env={};#r;finalized=!1;error;#o;#n;#s;#u;#l;#c;#a;#d;#f;constructor(t,e){this.#t=t,e&&(this.#n=e.executionCtx,this.env=e.env,this.#c=e.notFoundHandler,this.#f=e.path,this.#d=e.matchResult)}get req(){return this.#e??=new Ut(this.#t,this.#f,this.#d),this.#e}get event(){if(this.#n&&"respondWith"in this.#n)return this.#n;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#n)return this.#n;throw Error("This context has no ExecutionContext")}get res(){return this.#s||=new Response(null,{headers:this.#a??=new Headers})}set res(t){if(this.#s&&t){t=new Response(t.body,t);for(let[e,r]of this.#s.headers.entries())if(e!=="content-type")if(e==="set-cookie"){let s=this.#s.headers.getSetCookie();t.headers.delete("set-cookie");for(let n of s)t.headers.append("set-cookie",n)}else t.headers.set(e,r)}this.#s=t,this.finalized=!0}render=(...t)=>(this.#l??=e=>this.html(e),this.#l(...t));setLayout=t=>this.#u=t;getLayout=()=>this.#u;setRenderer=t=>{this.#l=t};header=(t,e,r)=>{this.finalized&&(this.#s=new Response(this.#s.body,this.#s));let s=this.#s?this.#s.headers:this.#a??=new Headers;e===void 0?s.delete(t):r?.append?s.append(t,e):s.set(t,e)};status=t=>{this.#o=t};set=(t,e)=>{this.#r??=new Map,this.#r.set(t,e)};get=t=>this.#r?this.#r.get(t):void 0;get var(){return this.#r?Object.fromEntries(this.#r):{}}#i(t,e,r){let s=this.#s?new Headers(this.#s.headers):this.#a??new Headers;if(typeof e=="object"&&"headers"in e){let o=e.headers instanceof Headers?e.headers:new Headers(e.headers);for(let[i,a]of o)i.toLowerCase()==="set-cookie"?s.append(i,a):s.set(i,a)}if(r)for(let[o,i]of Object.entries(r))if(typeof i=="string")s.set(o,i);else{s.delete(o);for(let a of i)s.append(o,a)}let n=typeof e=="number"?e:e?.status??this.#o;return new Response(t,{status:n,headers:s})}newResponse=(...t)=>this.#i(...t);body=(t,e,r)=>this.#i(t,e,r);text=(t,e,r)=>!this.#a&&!this.#o&&!e&&!r&&!this.finalized?new Response(t):this.#i(t,e,Hr(wa,r));json=(t,e,r)=>this.#i(JSON.stringify(t),e,Hr("application/json",r));html=(t,e,r)=>{let s=n=>this.#i(n,e,Hr("text/html; charset=UTF-8",r));return typeof t=="object"?zr(t,Fn.Stringify,!1,{}).then(s):s(t)};redirect=(t,e)=>{let r=String(t);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,e??302)};notFound=()=>(this.#c??=()=>new Response,this.#c(this))};var B="ALL",Qn="all",Un=["get","post","put","delete","options","patch"],Ht="Can not add a route since the matcher is already built.",Vt=class extends Error{};var Kn="__COMPOSED_HANDLER";var ba=t=>t.text("404 Not Found",404),Gn=(t,e)=>{if("getResponse"in t){let r=t.getResponse();return e.newResponse(r.body,r)}return console.error(t),e.text("Internal Server Error",500)},Vr=class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#t="/";routes=[];constructor(t={}){[...Un,Qn].forEach(n=>{this[n]=(o,...i)=>(typeof o=="string"?this.#t=o:this.#o(n,this.#t,o),i.forEach(a=>{this.#o(n,this.#t,a)}),this)}),this.on=(n,o,...i)=>{for(let a of[o].flat()){this.#t=a;for(let l of[n].flat())i.map(c=>{this.#o(l.toUpperCase(),this.#t,c)})}return this},this.use=(n,...o)=>(typeof n=="string"?this.#t=n:(this.#t="*",o.unshift(n)),o.forEach(i=>{this.#o(B,this.#t,i)}),this);let{strict:r,...s}=t;Object.assign(this,s),this.getPath=r??!0?t.getPath??Kr:Rn}#e(){let t=new Vr({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,t.#r=this.#r,t.routes=this.routes,t}#r=ba;errorHandler=Gn;route(t,e){let r=this.basePath(t);return e.routes.map(s=>{let n;e.errorHandler===Gn?n=s.handler:(n=async(o,i)=>(await Dr([],e.errorHandler)(o,()=>s.handler(o,i))).res,n[Kn]=s.handler),r.#o(s.method,s.path,n)}),this}basePath(t){let e=this.#e();return e._basePath=Te(this._basePath,t),e}onError=t=>(this.errorHandler=t,this);notFound=t=>(this.#r=t,this);mount(t,e,r){let s,n;r&&(typeof r=="function"?n=r:(n=r.optionHandler,r.replaceRequest===!1?s=a=>a:s=r.replaceRequest));let o=n?a=>{let l=n(a);return Array.isArray(l)?l:[l]}:a=>{let l;try{l=a.executionCtx}catch{}return[a.env,l]};s||=(()=>{let a=Te(this._basePath,t),l=a==="/"?0:a.length;return c=>{let d=new URL(c.url);return d.pathname=d.pathname.slice(l)||"/",new Request(d,c)}})();let i=async(a,l)=>{let c=await e(s(a.req.raw),...o(a));if(c)return c;await l()};return this.#o(B,Te(t,"*"),i),this}#o(t,e,r){t=t.toUpperCase(),e=Te(this._basePath,e);let s={basePath:this._basePath,path:e,method:t,handler:r};this.router.add(t,e,[r,s]),this.routes.push(s)}#n(t,e){if(t instanceof Error)return this.errorHandler(t,e);throw t}#s(t,e,r,s){if(s==="HEAD")return(async()=>new Response(null,await this.#s(t,e,r,"GET")))();let n=this.getPath(t,{env:r}),o=this.router.match(s,n),i=new Dn(t,{path:n,matchResult:o,env:r,executionCtx:e,notFoundHandler:this.#r});if(o[0].length===1){let l;try{l=o[0][0][0][0](i,async()=>{i.res=await this.#r(i)})}catch(c){return this.#n(c,i)}return l instanceof Promise?l.then(c=>c||(i.finalized?i.res:this.#r(i))).catch(c=>this.#n(c,i)):l??this.#r(i)}let a=Dr(o[0],this.errorHandler,this.#r);return(async()=>{try{let l=await a(i);if(!l.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return l.res}catch(l){return this.#n(l,i)}})()}fetch=(t,...e)=>this.#s(t,e[1],e[0],t.method);request=(t,e,r,s)=>t instanceof Request?this.fetch(e?new Request(t,e):t,r,s):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${Te("/",t)}`,e),r,s));fire=()=>{addEventListener("fetch",t=>{t.respondWith(this.#s(t.request,t,void 0,t.request.method))})}};var kt="[^/]+",it=".*",at="(?:|/.*)",Ce=Symbol(),va=new Set(".\\+*[^]$()");function xa(t,e){return t.length===1?e.length===1?t<e?-1:1:-1:e.length===1||t===it||t===at?1:e===it||e===at?-1:t===kt?1:e===kt?-1:t.length===e.length?t<e?-1:1:e.length-t.length}var Wt=class{#t;#e;#r=Object.create(null);insert(t,e,r,s,n){if(t.length===0){if(this.#t!==void 0)throw Ce;if(n)return;this.#t=e;return}let[o,...i]=t,a=o==="*"?i.length===0?["","",it]:["","",kt]:o==="/*"?["","",at]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),l;if(a){let c=a[1],d=a[2]||kt;if(c&&a[2]&&(d===".*"||(d=d.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(d))))throw Ce;if(l=this.#r[d],!l){if(Object.keys(this.#r).some(m=>m!==it&&m!==at))throw Ce;if(n)return;l=this.#r[d]=new Wt,c!==""&&(l.#e=s.varIndex++)}!n&&c!==""&&r.push([c,l.#e])}else if(l=this.#r[o],!l){if(Object.keys(this.#r).some(c=>c.length>1&&c!==it&&c!==at))throw Ce;if(n)return;l=this.#r[o]=new Wt}l.insert(i,e,r,s,n)}buildRegExpStr(){let e=Object.keys(this.#r).sort(xa).map(r=>{let s=this.#r[r];return(typeof s.#e=="number"?`(${r})@${s.#e}`:va.has(r)?`\\${r}`:r)+s.buildRegExpStr()});return typeof this.#t=="number"&&e.unshift(`#${this.#t}`),e.length===0?"":e.length===1?e[0]:"(?:"+e.join("|")+")"}};var zn=class{#t={varIndex:0};#e=new Wt;insert(t,e,r){let s=[],n=[];for(let i=0;;){let a=!1;if(t=t.replace(/\{[^}]+\}/g,l=>{let c=`@\\${i}`;return n[i]=[c,l],i++,a=!0,c}),!a)break}let o=t.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=n.length-1;i>=0;i--){let[a]=n[i];for(let l=o.length-1;l>=0;l--)if(o[l].indexOf(a)!==-1){o[l]=o[l].replace(a,n[i][1]);break}}return this.#e.insert(o,e,s,this.#t,r),s}buildRegExp(){let t=this.#e.buildRegExpStr();if(t==="")return[/^$/,[],[]];let e=0,r=[],s=[];return t=t.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,o,i)=>o!==void 0?(r[++e]=Number(o),"$()"):(i!==void 0&&(s[Number(i)]=++e),"")),[new RegExp(`^${t}`),r,s]}};var Hn=[],Sa=[/^$/,[],Object.create(null)],Vn=Object.create(null);function kn(t){return Vn[t]??=new RegExp(t==="*"?"":`^${t.replace(/\/\*$|([.\\+*[^\]$()])/g,(e,r)=>r?`\\${r}`:"(?:|/.*)")}$`)}function Ea(){Vn=Object.create(null)}function Ia(t){let e=new zn,r=[];if(t.length===0)return Sa;let s=t.map(c=>[!/\*|\/:/.test(c[0]),...c]).sort(([c,d],[m,y])=>c?1:m?-1:d.length-y.length),n=Object.create(null);for(let c=0,d=-1,m=s.length;c<m;c++){let[y,S,v]=s[c];y?n[S]=[v.map(([T])=>[T,Object.create(null)]),Hn]:d++;let E;try{E=e.insert(S,d,y)}catch(T){throw T===Ce?new Vt(S):T}y||(r[d]=v.map(([T,A])=>{let q=Object.create(null);for(A-=1;A>=0;A--){let[N,$]=E[A];q[N]=$}return[T,q]}))}let[o,i,a]=e.buildRegExp();for(let c=0,d=r.length;c<d;c++)for(let m=0,y=r[c].length;m<y;m++){let S=r[c][m]?.[1];if(!S)continue;let v=Object.keys(S);for(let E=0,T=v.length;E<T;E++)S[v[E]]=a[S[v[E]]]}let l=[];for(let c in i)l[c]=r[i[c]];return[o,l,n]}function Ke(t,e){if(t){for(let r of Object.keys(t).sort((s,n)=>n.length-s.length))if(kn(r).test(e))return[...t[r]]}}var kr=class{name="RegExpRouter";#t;#e;constructor(){this.#t={[B]:Object.create(null)},this.#e={[B]:Object.create(null)}}add(t,e,r){let s=this.#t,n=this.#e;if(!s||!n)throw new Error(Ht);s[t]||[s,n].forEach(a=>{a[t]=Object.create(null),Object.keys(a[B]).forEach(l=>{a[t][l]=[...a[B][l]]})}),e==="/*"&&(e="*");let o=(e.match(/\/:/g)||[]).length;if(/\*$/.test(e)){let a=kn(e);t===B?Object.keys(s).forEach(l=>{s[l][e]||=Ke(s[l],e)||Ke(s[B],e)||[]}):s[t][e]||=Ke(s[t],e)||Ke(s[B],e)||[],Object.keys(s).forEach(l=>{(t===B||t===l)&&Object.keys(s[l]).forEach(c=>{a.test(c)&&s[l][c].push([r,o])})}),Object.keys(n).forEach(l=>{(t===B||t===l)&&Object.keys(n[l]).forEach(c=>a.test(c)&&n[l][c].push([r,o]))});return}let i=zt(e)||[e];for(let a=0,l=i.length;a<l;a++){let c=i[a];Object.keys(n).forEach(d=>{(t===B||t===d)&&(n[d][c]||=[...Ke(s[d],c)||Ke(s[B],c)||[]],n[d][c].push([r,o-l+a+1]))})}}match(t,e){Ea();let r=this.#r();return this.match=(s,n)=>{let o=r[s]||r[B],i=o[2][n];if(i)return i;let a=n.match(o[0]);if(!a)return[[],Hn];let l=a.indexOf("",1);return[o[1][l],a]},this.match(t,e)}#r(){let t=Object.create(null);return Object.keys(this.#e).concat(Object.keys(this.#t)).forEach(e=>{t[e]||=this.#o(e)}),this.#t=this.#e=void 0,t}#o(t){let e=[],r=t===B;return[this.#t,this.#e].forEach(s=>{let n=s[t]?Object.keys(s[t]).map(o=>[o,s[t][o]]):[];n.length!==0?(r||=!0,e.push(...n)):t!==B&&e.push(...Object.keys(s[B]).map(o=>[o,s[B][o]]))}),r?Ia(e):null}};var Wr=class{name="SmartRouter";#t=[];#e=[];constructor(t){this.#t=t.routers}add(t,e,r){if(!this.#e)throw new Error(Ht);this.#e.push([t,e,r])}match(t,e){if(!this.#e)throw new Error("Fatal error");let r=this.#t,s=this.#e,n=r.length,o=0,i;for(;o<n;o++){let a=r[o];try{for(let l=0,c=s.length;l<c;l++)a.add(...s[l]);i=a.match(t,e)}catch(l){if(l instanceof Vt)continue;throw l}this.match=a.match.bind(a),this.#t=[a],this.#e=void 0;break}if(o===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(this.#e||this.#t.length!==1)throw new Error("No active router has been determined yet.");return this.#t[0]}};var lt=Object.create(null),Jr=class{#t;#e;#r;#o=0;#n=lt;constructor(t,e,r){if(this.#e=r||Object.create(null),this.#t=[],t&&e){let s=Object.create(null);s[t]={handler:e,possibleKeys:[],score:0},this.#t=[s]}this.#r=[]}insert(t,e,r){this.#o=++this.#o;let s=this,n=An(e),o=[];for(let i=0,a=n.length;i<a;i++){let l=n[i],c=n[i+1],d=On(l,c),m=Array.isArray(d)?d[0]:l;if(m in s.#e){s=s.#e[m],d&&o.push(d[1]);continue}s.#e[m]=new Jr,d&&(s.#r.push(d),o.push(d[1])),s=s.#e[m]}return s.#t.push({[t]:{handler:r,possibleKeys:o.filter((i,a,l)=>l.indexOf(i)===a),score:this.#o}}),s}#s(t,e,r,s){let n=[];for(let o=0,i=t.#t.length;o<i;o++){let a=t.#t[o],l=a[e]||a[B],c={};if(l!==void 0&&(l.params=Object.create(null),n.push(l),r!==lt||s&&s!==lt))for(let d=0,m=l.possibleKeys.length;d<m;d++){let y=l.possibleKeys[d],S=c[l.score];l.params[y]=s?.[y]&&!S?s[y]:r[y]??s?.[y],c[l.score]=!0}}return n}search(t,e){let r=[];this.#n=lt;let n=[this],o=Ur(e),i=[];for(let a=0,l=o.length;a<l;a++){let c=o[a],d=a===l-1,m=[];for(let y=0,S=n.length;y<S;y++){let v=n[y],E=v.#e[c];E&&(E.#n=v.#n,d?(E.#e["*"]&&r.push(...this.#s(E.#e["*"],t,v.#n)),r.push(...this.#s(E,t,v.#n))):m.push(E));for(let T=0,A=v.#r.length;T<A;T++){let q=v.#r[T],N=v.#n===lt?{}:{...v.#n};if(q==="*"){let P=v.#e["*"];P&&(r.push(...this.#s(P,t,v.#n)),P.#n=N,m.push(P));continue}let[$,k,se]=q;if(!c&&!(se instanceof RegExp))continue;let x=v.#e[$],C=o.slice(a).join("/");if(se instanceof RegExp){let P=se.exec(C);if(P){if(N[k]=P[0],r.push(...this.#s(x,t,v.#n,N)),Object.keys(x.#e).length){x.#n=N;let Ue=P[0].match(/\//)?.length??0;(i[Ue]||=[]).push(x)}continue}}(se===!0||se.test(c))&&(N[k]=c,d?(r.push(...this.#s(x,t,N,v.#n)),x.#e["*"]&&r.push(...this.#s(x.#e["*"],t,N,v.#n))):(x.#n=N,m.push(x)))}}n=m.concat(i.shift()??[])}return r.length>1&&r.sort((a,l)=>a.score-l.score),[r.map(({handler:a,params:l})=>[a,l])]}};var Yr=class{name="TrieRouter";#t;constructor(){this.#t=new Jr}add(t,e,r){let s=zt(e);if(s){for(let n=0,o=s.length;n<o;n++)this.#t.insert(t,s[n],r);return}this.#t.insert(t,e,r)}match(t,e){return this.#t.search(t,e)}};var Q=class extends Vr{constructor(t={}){super(t),this.router=t.router??new Wr({routers:[new kr,new Yr]})}};var Wn=t=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...t},s=(o=>typeof o=="string"?o==="*"?()=>o:i=>o===i?i:null:typeof o=="function"?o:i=>o.includes(i)?i:null)(r.origin),n=(o=>typeof o=="function"?o:Array.isArray(o)?()=>o:()=>[])(r.allowMethods);return async function(i,a){function l(d,m){i.res.headers.set(d,m)}let c=s(i.req.header("origin")||"",i);if(c&&l("Access-Control-Allow-Origin",c),r.origin!=="*"){let d=i.req.header("Vary");d?l("Vary",d):l("Vary","Origin")}if(r.credentials&&l("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&l("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),i.req.method==="OPTIONS"){r.maxAge!=null&&l("Access-Control-Max-Age",r.maxAge.toString());let d=n(i.req.header("origin")||"",i);d.length&&l("Access-Control-Allow-Methods",d.join(","));let m=r.allowHeaders;if(!m?.length){let y=i.req.header("Access-Control-Request-Headers");y&&(m=y.split(/\s*,\s*/))}return m?.length&&(l("Access-Control-Allow-Headers",m.join(",")),i.res.headers.append("Vary","Access-Control-Request-Headers")),i.res.headers.delete("Content-Length"),i.res.headers.delete("Content-Type"),new Response(null,{headers:i.res.headers,status:204,statusText:"No Content"})}await a()}};function Ta(){let{process:t,Deno:e}=globalThis;return!(typeof e?.noColor=="boolean"?e.noColor:t!==void 0?"NO_COLOR"in t?.env:!1)}async function Jn(){let{navigator:t}=globalThis,e="cloudflare:workers";return!(t!==void 0&&t.userAgent==="Cloudflare-Workers"?await(async()=>{try{return"NO_COLOR"in((await import(e)).env??{})}catch{return!1}})():!Ta())}var Ca=t=>{let[e,r]=[",","."];return t.map(n=>n.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+e)).join(r)},ja=t=>{let e=Date.now()-t;return Ca([e<1e3?e+"ms":Math.round(e/1e3)+"s"])},qa=async t=>{if(await Jn())switch(t/100|0){case 5:return`\x1B[31m${t}\x1B[0m`;case 4:return`\x1B[33m${t}\x1B[0m`;case 3:return`\x1B[36m${t}\x1B[0m`;case 2:return`\x1B[32m${t}\x1B[0m`}return`${t}`};async function Yn(t,e,r,s,n=0,o){let i=e==="<--"?`${e} ${r} ${s}`:`${e} ${r} ${s} ${await qa(n)} ${o}`;t(i)}var Xn=(t=console.log)=>async function(r,s){let{method:n,url:o}=r.req,i=o.slice(o.indexOf("/",8));await Yn(t,"<--",n,i);let a=Date.now();await s(),await Yn(t,"-->",n,i,r.res.status,ja(a))};var Zn=async(t,e)=>{let r=Date.now();console.log(`--> ${t.req.method} ${t.req.url}`),await e();let s=Date.now()-r;console.log(`<-- ${t.req.method} ${t.req.url} ${t.res.status} ${s}ms`)};var f=Symbol.for("drizzle:entityKind"),Uc=Symbol.for("drizzle:hasOwnEntityKind");function p(t,e){if(!t||typeof t!="object")return!1;if(t instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,f))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let r=t.constructor;if(r)for(;r;){if(f in r&&r[f]===e[f])return!0;r=Object.getPrototypeOf(r)}return!1}var j=class{constructor(e,r){this.table=e,this.config=r,this.name=r.name,this.notNull=r.notNull,this.default=r.default,this.defaultFn=r.defaultFn,this.onUpdateFn=r.onUpdateFn,this.hasDefault=r.hasDefault,this.primary=r.primaryKey,this.isUnique=r.isUnique,this.uniqueName=r.uniqueName,this.uniqueType=r.uniqueType,this.dataType=r.dataType,this.columnType=r.columnType}static[f]="Column";name;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}};var Ge=class{static[f]="ColumnBuilder";config;constructor(e,r,s){this.config={name:e,notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:r,columnType:s}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(e){return this.config.onUpdateFn=e,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}};var ct=Symbol.for("drizzle:Name"),Jt=Symbol.for("drizzle:Schema"),eo=Symbol.for("drizzle:Columns"),to=Symbol.for("drizzle:ExtraConfigColumns"),Xr=Symbol.for("drizzle:OriginalName"),Zr=Symbol.for("drizzle:BaseName"),ro=Symbol.for("drizzle:IsAlias"),so=Symbol.for("drizzle:ExtraConfigBuilder"),Wc=Symbol.for("drizzle:IsDrizzleTable"),h=class{static[f]="Table";static Symbol={Name:ct,Schema:Jt,OriginalName:Xr,Columns:eo,ExtraConfigColumns:to,BaseName:Zr,IsAlias:ro,ExtraConfigBuilder:so};[ct];[Xr];[Jt];[eo];[to];[Zr];[ro]=!1;[so]=void 0;constructor(e,r,s){this[ct]=this[Xr]=e,this[Jt]=r,this[Zr]=s}};function Se(t){return t[ct]}function je(t){return`${t[Jt]??"public"}.${t[ct]}`}var no=Symbol.for("drizzle:PgInlineForeignKeys"),ye=class extends h{static[f]="PgTable";static Symbol=Object.assign({},h.Symbol,{InlineForeignKeys:no});[no]=[];[h.Symbol.ExtraConfigBuilder]=void 0};var Yt=class{static[f]="PgForeignKeyBuilder";reference;_onUpdate="no action";_onDelete="no action";constructor(e,r){this.reference=()=>{let{name:s,columns:n,foreignColumns:o}=e();return{name:s,columns:n,foreignTable:o[0].table,foreignColumns:o}},r&&(this._onUpdate=r.onUpdate,this._onDelete=r.onDelete)}onUpdate(e){return this._onUpdate=e===void 0?"no action":e,this}onDelete(e){return this._onDelete=e===void 0?"no action":e,this}build(e){return new es(e,this)}},es=class{constructor(e,r){this.table=e,this.reference=r.reference,this.onUpdate=r._onUpdate,this.onDelete=r._onDelete}static[f]="PgForeignKey";reference;onUpdate;onDelete;getName(){let{name:e,columns:r,foreignColumns:s}=this.reference(),n=r.map(a=>a.name),o=s.map(a=>a.name),i=[this.table[ye.Symbol.Name],...n,s[0].table[ye.Symbol.Name],...o];return e??`${i.join("_")}_fk`}};function Xt(t,...e){return t(...e)}function ss(t,e){return`${t[ye.Symbol.Name]}_${e.join("_")}_unique`}var ts=class{constructor(e,r){this.name=r,this.columns=e}static[f]="PgUniqueConstraintBuilder";columns;nullsNotDistinctConfig=!1;nullsNotDistinct(){return this.nullsNotDistinctConfig=!0,this}build(e){return new rs(e,this.columns,this.nullsNotDistinctConfig,this.name)}},oo=class{static[f]="PgUniqueOnConstraintBuilder";name;constructor(e){this.name=e}on(...e){return new ts(e,this.name)}},rs=class{constructor(e,r,s,n){this.table=e,this.columns=r,this.name=n??ss(this.table,this.columns.map(o=>o.name)),this.nullsNotDistinct=s}static[f]="PgUniqueConstraint";columns;name;nullsNotDistinct=!1;getName(){return this.name}};function io(t,e,r){for(let s=e;s<t.length;s++){let n=t[s];if(n==="\\"){s++;continue}if(n==='"')return[t.slice(e,s).replace(/\\/g,""),s+1];if(!r&&(n===","||n==="}"))return[t.slice(e,s).replace(/\\/g,""),s]}return[t.slice(e).replace(/\\/g,""),t.length]}function ao(t,e=0){let r=[],s=e,n=!1;for(;s<t.length;){let o=t[s];if(o===","){(n||s===e)&&r.push(""),n=!0,s++;continue}if(n=!1,o==="\\"){s+=2;continue}if(o==='"'){let[l,c]=io(t,s+1,!0);r.push(l),s=c;continue}if(o==="}")return[r,s+1];if(o==="{"){let[l,c]=ao(t,s+1);r.push(l),s=c;continue}let[i,a]=io(t,s,!1);r.push(i),s=a}return[r,s]}function lo(t){let[e]=ao(t,1);return e}function ns(t){return`{${t.map(e=>Array.isArray(e)?ns(e):typeof e=="string"?`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:`${e}`).join(",")}}`}var ut=class extends Ge{foreignKeyConfigs=[];static[f]="PgColumnBuilder";array(e){return new is(this.config.name,this,e)}references(e,r={}){return this.foreignKeyConfigs.push({ref:e,actions:r}),this}unique(e,r){return this.config.isUnique=!0,this.config.uniqueName=e,this.config.uniqueType=r?.nulls,this}buildForeignKeys(e,r){return this.foreignKeyConfigs.map(({ref:s,actions:n})=>Xt((o,i)=>{let a=new Yt(()=>{let l=o();return{columns:[e],foreignColumns:[l]}});return i.onUpdate&&a.onUpdate(i.onUpdate),i.onDelete&&a.onDelete(i.onDelete),a.build(r)},s,n))}buildExtraConfigColumn(e){return new os(e,this.config)}},ze=class extends j{constructor(e,r){r.uniqueName||(r.uniqueName=ss(e,[r.name])),super(e,r),this.table=e}static[f]="PgColumn"},os=class extends ze{static[f]="ExtraConfigColumn";getSQLType(){return this.getSQLType()}indexConfig={order:this.config.order??"asc",nulls:this.config.nulls??"last",opClass:this.config.opClass};defaultConfig={order:"asc",nulls:"last",opClass:void 0};asc(){return this.indexConfig.order="asc",this}desc(){return this.indexConfig.order="desc",this}nullsFirst(){return this.indexConfig.nulls="first",this}nullsLast(){return this.indexConfig.nulls="last",this}op(e){return this.indexConfig.opClass=e,this}},co=class{static[f]="IndexedColumn";constructor(e,r,s){this.name=e,this.type=r,this.indexConfig=s}name;type;indexConfig},is=class extends ut{static[f]="PgArrayBuilder";constructor(e,r,s){super(e,"array","PgArray"),this.config.baseBuilder=r,this.config.size=s}build(e){let r=this.config.baseBuilder.build(e);return new as(e,this.config,r)}},as=class t extends ze{constructor(e,r,s,n){super(e,r),this.baseColumn=s,this.range=n,this.size=r.size}size;static[f]="PgArray";getSQLType(){return`${this.baseColumn.getSQLType()}[${typeof this.size=="number"?this.size:""}]`}mapFromDriverValue(e){return typeof e=="string"&&(e=lo(e)),e.map(r=>this.baseColumn.mapFromDriverValue(r))}mapToDriverValue(e,r=!1){let s=e.map(n=>n===null?null:p(this.baseColumn,t)?this.baseColumn.mapToDriverValue(n,!0):this.baseColumn.mapToDriverValue(n));return r?s:ns(s)}};var uo=Symbol.for("drizzle:isPgEnum");function po(t){return!!t&&typeof t=="function"&&uo in t&&t[uo]===!0}var fo=class extends ut{static[f]="PgEnumColumnBuilder";constructor(e,r){super(e,"string","PgEnumColumn"),this.config.enum=r}build(e){return new ls(e,this.config)}},ls=class extends ze{static[f]="PgEnumColumn";enum=this.config.enum;enumValues=this.config.enum.enumValues;constructor(e,r){super(e,r),this.enum=r.enum}getSQLType(){return this.enum.enumName}};var U=class{static[f]="Subquery";constructor(e,r,s,n=!1){this._={brand:"Subquery",sql:e,selectedFields:r,alias:s,isWith:n}}},He=class extends U{static[f]="WithSubquery"};var mo="0.31.4";var cs,us,ho={startActiveSpan(t,e){return cs?(us||(us=cs.trace.getTracer("drizzle-orm",mo)),Xt((r,s)=>s.startActiveSpan(t,n=>{try{return e(n)}catch(o){throw n.setStatus({code:r.SpanStatusCode.ERROR,message:o instanceof Error?o.message:"Unknown error"}),o}finally{n.end()}}),cs,us)):e()}};var L=Symbol.for("drizzle:ViewBaseConfig");var go=class{static[f]="FakePrimitiveParam"};function ds(t){return t!=null&&typeof t.getSQL=="function"}function Na(t){let e={sql:"",params:[]};for(let r of t)e.sql+=r.sql,e.params.push(...r.params),r.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...r.typings));return e}var F=class{static[f]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new g([this])}},g=class t{constructor(e){this.queryChunks=e}static[f]="SQL";decoder=wo;shouldInlineParams=!1;append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return ho.startActiveSpan("drizzle.buildSQL",r=>{let s=this.buildQueryFromSourceParams(this.queryChunks,e);return r?.setAttributes({"drizzle.query.text":s.sql,"drizzle.query.params":JSON.stringify(s.params)}),s})}buildQueryFromSourceParams(e,r){let s=Object.assign({},r,{inlineParams:r.inlineParams||this.shouldInlineParams,paramStartIndex:r.paramStartIndex||{value:0}}),{escapeName:n,escapeParam:o,prepareTyping:i,inlineParams:a,paramStartIndex:l}=s;return Na(e.map(c=>{if(p(c,F))return{sql:c.value.join(""),params:[]};if(p(c,dt))return{sql:n(c.value),params:[]};if(c===void 0)return{sql:"",params:[]};if(Array.isArray(c)){let d=[new F("(")];for(let[m,y]of c.entries())d.push(y),m<c.length-1&&d.push(new F(", "));return d.push(new F(")")),this.buildQueryFromSourceParams(d,s)}if(p(c,t))return this.buildQueryFromSourceParams(c.queryChunks,{...s,inlineParams:a||c.shouldInlineParams});if(p(c,h)){let d=c[h.Symbol.Schema],m=c[h.Symbol.Name];return{sql:d===void 0?n(m):n(d)+"."+n(m),params:[]}}if(p(c,j))return r.invokeSource==="indexes"?{sql:n(c.name),params:[]}:{sql:n(c.table[h.Symbol.Name])+"."+n(c.name),params:[]};if(p(c,te)){let d=c[L].schema,m=c[L].name;return{sql:d===void 0?n(m):n(d)+"."+n(m),params:[]}}if(p(c,ee)){let d=c.value===null?null:c.encoder.mapToDriverValue(c.value);if(p(d,t))return this.buildQueryFromSourceParams([d],s);if(a)return{sql:this.mapInlineParam(d,s),params:[]};let m;return i&&(m=[i(c.encoder)]),{sql:o(l.value++,d),params:[d],typings:m}}return p(c,qe)?{sql:o(l.value++,c),params:[c],typings:["none"]}:p(c,t.Aliased)&&c.fieldAlias!==void 0?{sql:n(c.fieldAlias),params:[]}:p(c,U)?c._.isWith?{sql:n(c._.alias),params:[]}:this.buildQueryFromSourceParams([new F("("),c._.sql,new F(") "),new dt(c._.alias)],s):po(c)?c.schema?{sql:n(c.schema)+"."+n(c.enumName),params:[]}:{sql:n(c.enumName),params:[]}:ds(c)?c.shouldOmitSQLParens?.()?this.buildQueryFromSourceParams([c.getSQL()],s):this.buildQueryFromSourceParams([new F("("),c.getSQL(),new F(")")],s):a?{sql:this.mapInlineParam(c,s),params:[]}:{sql:o(l.value++,c),params:[c]}}))}mapInlineParam(e,{escapeString:r}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return r(e);if(typeof e=="object"){let s=e.toString();return r(s==="[object Object]"?JSON.stringify(e):s)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new t.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}if(e){return e?this:void 0}},dt=class{constructor(e){this.value=e}static[f]="Name";brand;getSQL(){return new g([this])}};function yo(t){return typeof t=="object"&&t!==null&&"mapToDriverValue"in t&&typeof t.mapToDriverValue=="function"}var wo={mapFromDriverValue:t=>t},bo={mapToDriverValue:t=>t},Ou={...wo,...bo},ee=class{constructor(e,r=bo){this.value=e,this.encoder=r}static[f]="Param";brand;getSQL(){return new g([this])}};function u(t,...e){let r=[];(e.length>0||t.length>0&&t[0]!=="")&&r.push(new F(t[0]));for(let[s,n]of e.entries())r.push(n,new F(t[s+1]));return new g(r)}(t=>{function e(){return new g([])}t.empty=e;function r(l){return new g(l)}t.fromList=r;function s(l){return new g([new F(l)])}t.raw=s;function n(l,c){let d=[];for(let[m,y]of l.entries())m>0&&c!==void 0&&d.push(c),d.push(y);return new g(d)}t.join=n;function o(l){return new dt(l)}t.identifier=o;function i(l){return new qe(l)}t.placeholder=i;function a(l,c){return new ee(l,c)}t.param=a})(u||(u={}));(t=>{class e{constructor(s,n){this.sql=s,this.fieldAlias=n}static[f]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}t.Aliased=e})(g||(g={}));var qe=class{constructor(e){this.name=e}static[f]="Placeholder";getSQL(){return new g([this])}};function ft(t,e){return t.map(r=>{if(p(r,qe)){if(!(r.name in e))throw new Error(`No value for placeholder "${r.name}" was provided`);return e[r.name]}return r})}var te=class{static[f]="View";[L];constructor({name:e,schema:r,selectedFields:s,query:n}){this[L]={name:e,originalName:e,schema:r,selectedFields:s,query:n,isExisting:!n,isAlias:!1}}getSQL(){return new g([this])}};j.prototype.getSQL=function(){return new g([this])};h.prototype.getSQL=function(){return new g([this])};U.prototype.getSQL=function(){return new g([this])};var Ne=class{constructor(e){this.table=e}static[f]="ColumnAliasProxyHandler";get(e,r){return r==="table"?this.table:e[r]}},Ve=class{constructor(e,r){this.alias=e,this.replaceOriginalName=r}static[f]="TableAliasProxyHandler";get(e,r){if(r===h.Symbol.IsAlias)return!0;if(r===h.Symbol.Name)return this.alias;if(this.replaceOriginalName&&r===h.Symbol.OriginalName)return this.alias;if(r===L)return{...e[L],name:this.alias,isAlias:!0};if(r===h.Symbol.Columns){let n=e[h.Symbol.Columns];if(!n)return n;let o={};return Object.keys(n).map(i=>{o[i]=new Proxy(n[i],new Ne(new Proxy(e,this)))}),o}let s=e[r];return p(s,j)?new Proxy(s,new Ne(new Proxy(e,this))):s}},vo=class{constructor(e){this.alias=e}static[f]="RelationTableAliasProxyHandler";get(e,r){return r==="sourceTable"?pt(e.sourceTable,this.alias):e[r]}};function pt(t,e){return new Proxy(t,new Ve(e,!1))}function pe(t,e){return new Proxy(t,new Ne(new Proxy(t.table,new Ve(e,!1))))}function fs(t,e){return new g.Aliased(mt(t.sql,e),t.fieldAlias)}function mt(t,e){return u.join(t.queryChunks.map(r=>p(r,j)?pe(r,e):p(r,g)?mt(r,e):p(r,g.Aliased)?fs(r,e):r))}var Me=class extends Error{static[f]="DrizzleError";constructor({message:e,cause:r}){super(e),this.name="DrizzleError",this.cause=r}},Zt=class extends Me{static[f]="TransactionRollbackError";constructor(){super({message:"Rollback"})}};function Y(t,e){return yo(e)&&!ds(t)&&!p(t,ee)&&!p(t,qe)&&!p(t,j)&&!p(t,h)&&!p(t,te)?new ee(t,e):t}var b=(t,e)=>u`${t} = ${Y(e,t)}`,xo=(t,e)=>u`${t} <> ${Y(e,t)}`;function ae(...t){let e=t.filter(r=>r!==void 0);if(e.length!==0)return e.length===1?new g(e):new g([new F("("),u.join(e,new F(" and ")),new F(")")])}function So(...t){let e=t.filter(r=>r!==void 0);if(e.length!==0)return e.length===1?new g(e):new g([new F("("),u.join(e,new F(" or ")),new F(")")])}function Eo(t){return u`not ${t}`}var Io=(t,e)=>u`${t} > ${Y(e,t)}`,To=(t,e)=>u`${t} >= ${Y(e,t)}`,er=(t,e)=>u`${t} < ${Y(e,t)}`,Co=(t,e)=>u`${t} <= ${Y(e,t)}`;function jo(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("inArray requires at least one value");return u`${t} in ${e.map(r=>Y(r,t))}`}return u`${t} in ${Y(e,t)}`}function qo(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("notInArray requires at least one value");return u`${t} not in ${e.map(r=>Y(r,t))}`}return u`${t} not in ${Y(e,t)}`}function No(t){return u`${t} is null`}function Mo(t){return u`${t} is not null`}function $o(t){return u`exists ${t}`}function Ao(t){return u`not exists ${t}`}function Oo(t,e,r){return u`${t} between ${Y(e,t)} and ${Y(r,t)}`}function Ro(t,e,r){return u`${t} not between ${Y(e,t)} and ${Y(r,t)}`}function _o(t,e){return u`${t} like ${e}`}function Bo(t,e){return u`${t} not like ${e}`}function Po(t,e){return u`${t} ilike ${e}`}function Lo(t,e){return u`${t} not ilike ${e}`}function tr(t){return u`${t} asc`}function le(t){return u`${t} desc`}var ps=class{static[f]="ConsoleLogWriter";write(e){console.log(e)}},rr=class{static[f]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new ps}logQuery(e,r){let s=r.map(o=>{try{return JSON.stringify(o)}catch{return String(o)}}),n=s.length?` -- params: [${s.join(", ")}]`:"";this.writer.write(`Query: ${e}${n}`)}},sr=class{static[f]="NoopLogger";logQuery(){}};var z=class{static[f]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}then(e,r){return this.execute().then(e,r)}};var nr=class{static[f]="PgPrimaryKeyBuilder";columns;name;constructor(e,r){this.columns=e,this.name=r}build(e){return new ms(e,this.columns,this.name)}},ms=class{constructor(e,r,s){this.table=e,this.columns=r,this.name=s}static[f]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[ye.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}};var or=class{constructor(e,r,s){this.sourceTable=e,this.referencedTable=r,this.relationName=s,this.referencedTableName=r[h.Symbol.Name]}static[f]="Relation";referencedTableName;fieldName},hs=class{constructor(e,r){this.table=e,this.config=r}static[f]="Relations"},Ee=class t extends or{constructor(e,r,s,n){super(e,r,s?.relationName),this.config=s,this.isNullable=n}static[f]="One";withFieldName(e){let r=new t(this.sourceTable,this.referencedTable,this.config,this.isNullable);return r.fieldName=e,r}},ht=class t extends or{constructor(e,r,s){super(e,r,s?.relationName),this.config=s}static[f]="Many";withFieldName(e){let r=new t(this.sourceTable,this.referencedTable,this.config);return r.fieldName=e,r}};function Fo(){return{and:ae,between:Oo,eq:b,exists:$o,gt:Io,gte:To,ilike:Po,inArray:jo,isNull:No,isNotNull:Mo,like:_o,lt:er,lte:Co,ne:xo,not:Eo,notBetween:Ro,notExists:Ao,notLike:Bo,notIlike:Lo,notInArray:qo,or:So,sql:u}}function Do(){return{sql:u,asc:tr,desc:le}}function Qo(t,e){Object.keys(t).length===1&&"default"in t&&!p(t.default,h)&&(t=t.default);let r={},s={},n={};for(let[o,i]of Object.entries(t))if(p(i,h)){let a=je(i),l=s[a];r[a]=o,n[o]={tsName:o,dbName:i[h.Symbol.Name],schema:i[h.Symbol.Schema],columns:i[h.Symbol.Columns],relations:l?.relations??{},primaryKey:l?.primaryKey??[]};for(let d of Object.values(i[h.Symbol.Columns]))d.primary&&n[o].primaryKey.push(d);let c=i[h.Symbol.ExtraConfigBuilder]?.(i[h.Symbol.ExtraConfigColumns]);if(c)for(let d of Object.values(c))p(d,nr)&&n[o].primaryKey.push(...d.columns)}else if(p(i,hs)){let a=je(i.table),l=r[a],c=i.config(e(i.table)),d;for(let[m,y]of Object.entries(c))if(l){let S=n[l];S.relations[m]=y,d&&S.primaryKey.push(...d)}else a in s||(s[a]={relations:{},primaryKey:d}),s[a].relations[m]=y}return{tables:n,tableNamesMap:r}}function Ma(t){return function(r,s){return new Ee(t,r,s,s?.fields.reduce((n,o)=>n&&o.notNull,!0)??!1)}}function $a(t){return function(r,s){return new ht(t,r,s)}}function Uo(t,e,r){if(p(r,Ee)&&r.config)return{fields:r.config.fields,references:r.config.references};let s=e[je(r.referencedTable)];if(!s)throw new Error(`Table "${r.referencedTable[h.Symbol.Name]}" not found in schema`);let n=t[s];if(!n)throw new Error(`Table "${s}" not found in schema`);let o=r.sourceTable,i=e[je(o)];if(!i)throw new Error(`Table "${o[h.Symbol.Name]}" not found in schema`);let a=[];for(let l of Object.values(n.relations))(r.relationName&&r!==l&&l.relationName===r.relationName||!r.relationName&&l.referencedTable===r.sourceTable)&&a.push(l);if(a.length>1)throw r.relationName?new Error(`There are multiple relations with name "${r.relationName}" in table "${s}"`):new Error(`There are multiple relations between "${s}" and "${r.sourceTable[h.Symbol.Name]}". Please specify relation name`);if(a[0]&&p(a[0],Ee)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${i}.${r.fieldName}"`)}function Ko(t){return{one:Ma(t),many:$a(t)}}function ir(t,e,r,s,n=o=>o){let o={};for(let[i,a]of s.entries())if(a.isJson){let l=e.relations[a.tsKey],c=r[i],d=typeof c=="string"?JSON.parse(c):c;o[a.tsKey]=p(l,Ee)?d&&ir(t,t[a.relationTableTsKey],d,a.selection,n):d.map(m=>ir(t,t[a.relationTableTsKey],m,a.selection,n))}else{let l=n(r[i]),c=a.field,d;p(c,j)?d=c:p(c,g)?d=c.decoder:d=c.sql.decoder,o[a.tsKey]=l===null?null:d.mapFromDriverValue(l)}return o}function gs(t,e,r){let s={},n=t.reduce((o,{path:i,field:a},l)=>{let c;p(a,j)?c=a:p(a,g)?c=a.decoder:c=a.sql.decoder;let d=o;for(let[m,y]of i.entries())if(m<i.length-1)y in d||(d[y]={}),d=d[y];else{let S=e[l],v=d[y]=S===null?null:c.mapFromDriverValue(S);if(r&&p(a,j)&&i.length===2){let E=i[0];E in s?typeof s[E]=="string"&&s[E]!==Se(a.table)&&(s[E]=!1):s[E]=v===null?Se(a.table):!1}}return o},{});if(r&&Object.keys(s).length>0)for(let[o,i]of Object.entries(s))typeof i=="string"&&!r[i]&&(n[o]=null);return n}function ne(t,e){return Object.entries(t).reduce((r,[s,n])=>{if(typeof s!="string")return r;let o=e?[...e,s]:[s];return p(n,j)||p(n,g)||p(n,g.Aliased)?r.push({path:o,field:n}):p(n,h)?r.push(...ne(n[h.Symbol.Columns],o)):r.push(...ne(n,o)),r},[])}function ys(t,e){let r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(let[n,o]of r.entries())if(o!==s[n])return!1;return!0}function ar(t,e){let r=Object.entries(e).filter(([,s])=>s!==void 0).map(([s,n])=>p(n,g)?[s,n]:[s,new ee(n,t[h.Symbol.Columns][s])]);if(r.length===0)throw new Error("No values to set");return Object.fromEntries(r)}function Go(t,e){for(let r of e)for(let s of Object.getOwnPropertyNames(r.prototype))s!=="constructor"&&Object.defineProperty(t.prototype,s,Object.getOwnPropertyDescriptor(r.prototype,s)||Object.create(null))}function zo(t){return t[h.Symbol.Columns]}function ws(t){return p(t,U)?t._.alias:p(t,te)?t[L].name:p(t,g)?void 0:t[h.Symbol.IsAlias]?t[h.Symbol.Name]:t[h.Symbol.BaseName]}var X=class t{static[f]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,r){if(r==="_")return{...e._,selectedFields:new Proxy(e._.selectedFields,this)};if(r===L)return{...e[L],selectedFields:new Proxy(e[L].selectedFields,this)};if(typeof r=="symbol")return e[r];let n=(p(e,U)?e._.selectedFields:p(e,te)?e[L].selectedFields:e)[r];if(p(n,g.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!n.isSelectionField)return n.sql;let o=n.clone();return o.isSelectionField=!0,o}if(p(n,g)){if(this.config.sqlBehavior==="sql")return n;throw new Error(`You tried to reference "${r}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return p(n,j)?this.config.alias?new Proxy(n,new Ne(new Proxy(n.table,new Ve(this.config.alias,this.config.replaceOriginalName??!1)))):n:typeof n!="object"||n===null?n:new Proxy(n,new t(this.config))}};var bs=Symbol.for("drizzle:SQLiteInlineForeignKeys"),R=class extends h{static[f]="SQLiteTable";static Symbol=Object.assign({},h.Symbol,{InlineForeignKeys:bs});[h.Symbol.Columns];[bs]=[];[h.Symbol.ExtraConfigBuilder]=void 0};function Aa(t,e,r,s,n=t){let o=new R(t,s,n),i=Object.fromEntries(Object.entries(e).map(([l,c])=>{let d=c,m=d.build(o);return o[bs].push(...d.buildForeignKeys(m,o)),[l,m]})),a=Object.assign(o,i);return a[h.Symbol.Columns]=i,a[h.Symbol.ExtraConfigColumns]=i,r&&(a[R.Symbol.ExtraConfigBuilder]=r),a}var ce=(t,e,r)=>Aa(t,e,r);var gt=class extends z{constructor(e,r,s,n){super(),this.table=e,this.session=r,this.dialect=s,this.config={table:e,withList:n}}static[f]="SQLiteDelete";config;where(e){return this.config.where=e,this}returning(e=this.table[R.Symbol.Columns]){return this.config.returning=ne(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(e){return this._prepare().execute(e)}$dynamic(){return this}};var yt=class{constructor(e,r,s,n){this.table=e,this.session=r,this.dialect=s,this.withList=n}static[f]="SQLiteInsertBuilder";values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");let r=e.map(s=>{let n={},o=this.table[h.Symbol.Columns];for(let i of Object.keys(s)){let a=s[i];n[i]=p(a,g)?a:new ee(a,o[i])}return n});return new vs(this.table,r,this.session,this.dialect,this.withList)}},vs=class extends z{constructor(e,r,s,n,o){super(),this.session=s,this.dialect=n,this.config={table:e,values:r,withList:o}}static[f]="SQLiteInsert";config;returning(e=this.config.table[R.Symbol.Columns]){return this.config.returning=ne(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=u`do nothing`;else{let r=Array.isArray(e.target)?u`${e.target}`:u`${[e.target]}`,s=e.where?u` where ${e.where}`:u``;this.config.onConflict=u`${r} do nothing${s}`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');let r=e.where?u` where ${e.where}`:void 0,s=e.targetWhere?u` where ${e.targetWhere}`:void 0,n=e.setWhere?u` where ${e.setWhere}`:void 0,o=Array.isArray(e.target)?u`${e.target}`:u`${[e.target]}`,i=this.dialect.buildUpdateSet(this.config.table,ar(this.config.table,e.set));return this.config.onConflict=u`${o}${s} do update set ${i}${r}${n}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}};var lr=class{static[f]="SQLiteForeignKeyBuilder";reference;_onUpdate;_onDelete;constructor(e,r){this.reference=()=>{let{name:s,columns:n,foreignColumns:o}=e();return{name:s,columns:n,foreignTable:o[0].table,foreignColumns:o}},r&&(this._onUpdate=r.onUpdate,this._onDelete=r.onDelete)}onUpdate(e){return this._onUpdate=e,this}onDelete(e){return this._onDelete=e,this}build(e){return new xs(e,this)}},xs=class{constructor(e,r){this.table=e,this.reference=r.reference,this.onUpdate=r._onUpdate,this.onDelete=r._onDelete}static[f]="SQLiteForeignKey";reference;onUpdate;onDelete;getName(){let{name:e,columns:r,foreignColumns:s}=this.reference(),n=r.map(a=>a.name),o=s.map(a=>a.name),i=[this.table[R.Symbol.Name],...n,s[0].table[R.Symbol.Name],...o];return e??`${i.join("_")}_fk`}};function Is(t,e){return`${t[R.Symbol.Name]}_${e.join("_")}_unique`}var Ss=class{constructor(e,r){this.name=r,this.columns=e}static[f]="SQLiteUniqueConstraintBuilder";columns;build(e){return new Es(e,this.columns,this.name)}},Ho=class{static[f]="SQLiteUniqueOnConstraintBuilder";name;constructor(e){this.name=e}on(...e){return new Ss(e,this.name)}},Es=class{constructor(e,r,s){this.table=e,this.columns=r,this.name=s??Is(this.table,this.columns.map(n=>n.name))}static[f]="SQLiteUniqueConstraint";columns;name;getName(){return this.name}};var we=class extends Ge{static[f]="SQLiteColumnBuilder";foreignKeyConfigs=[];references(e,r={}){return this.foreignKeyConfigs.push({ref:e,actions:r}),this}unique(e){return this.config.isUnique=!0,this.config.uniqueName=e,this}buildForeignKeys(e,r){return this.foreignKeyConfigs.map(({ref:s,actions:n})=>((o,i)=>{let a=new lr(()=>{let l=o();return{columns:[e],foreignColumns:[l]}});return i.onUpdate&&a.onUpdate(i.onUpdate),i.onDelete&&a.onDelete(i.onDelete),a.build(r)})(s,n))}},re=class extends j{constructor(e,r){r.uniqueName||(r.uniqueName=Is(e,[r.name])),super(e,r),this.table=e}static[f]="SQLiteColumn"};var wt=class extends we{static[f]="SQLiteBaseIntegerBuilder";constructor(e,r,s){super(e,r,s),this.config.autoIncrement=!1}primaryKey(e){return e?.autoIncrement&&(this.config.autoIncrement=!0),this.config.hasDefault=!0,super.primaryKey()}},bt=class extends re{static[f]="SQLiteBaseInteger";autoIncrement=this.config.autoIncrement;getSQLType(){return"integer"}},Ts=class extends wt{static[f]="SQLiteIntegerBuilder";constructor(e){super(e,"number","SQLiteInteger")}build(e){return new Cs(e,this.config)}},Cs=class extends bt{static[f]="SQLiteInteger"},js=class extends wt{static[f]="SQLiteTimestampBuilder";constructor(e,r){super(e,"date","SQLiteTimestamp"),this.config.mode=r}defaultNow(){return this.default(u`(cast((julianday('now') - 2440587.5)*86400000 as integer))`)}build(e){return new qs(e,this.config)}},qs=class extends bt{static[f]="SQLiteTimestamp";mode=this.config.mode;mapFromDriverValue(e){return this.config.mode==="timestamp"?new Date(e*1e3):new Date(e)}mapToDriverValue(e){let r=e.getTime();return this.config.mode==="timestamp"?Math.floor(r/1e3):r}},Ns=class extends wt{static[f]="SQLiteBooleanBuilder";constructor(e,r){super(e,"boolean","SQLiteBoolean"),this.config.mode=r}build(e){return new Ms(e,this.config)}},Ms=class extends bt{static[f]="SQLiteBoolean";mode=this.config.mode;mapFromDriverValue(e){return Number(e)===1}mapToDriverValue(e){return e?1:0}};function _(t,e){return e?.mode==="timestamp"||e?.mode==="timestamp_ms"?new js(t,e.mode):e?.mode==="boolean"?new Ns(t,e.mode):new Ts(t)}var $s=class extends we{static[f]="SQLiteNumericBuilder";constructor(e){super(e,"string","SQLiteNumeric")}build(e){return new As(e,this.config)}},As=class extends re{static[f]="SQLiteNumeric";getSQLType(){return"numeric"}};function cr(t){return new $s(t)}var Os=class extends we{static[f]="SQLiteTextBuilder";constructor(e,r){super(e,"string","SQLiteText"),this.config.enumValues=r.enum,this.config.length=r.length}build(e){return new Rs(e,this.config)}},Rs=class extends re{static[f]="SQLiteText";enumValues=this.config.enumValues;length=this.config.length;constructor(e,r){super(e,r)}getSQLType(){return`text${this.config.length?`(${this.config.length})`:""}`}},_s=class extends we{static[f]="SQLiteTextJsonBuilder";constructor(e){super(e,"json","SQLiteTextJson")}build(e){return new Bs(e,this.config)}},Bs=class extends re{static[f]="SQLiteTextJson";getSQLType(){return"text"}mapFromDriverValue(e){return JSON.parse(e)}mapToDriverValue(e){return JSON.stringify(e)}};function M(t,e={}){return e.mode==="json"?new _s(t):new Os(t,e)}var ke=class extends te{static[f]="SQLiteViewBase"};var ur=class{static[f]="SQLiteDialect";escapeName(e){return`"${e}"`}escapeParam(e){return"?"}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;let r=[u`with `];for(let[s,n]of e.entries())r.push(u`${u.identifier(n._.alias)} as (${n._.sql})`),s<e.length-1&&r.push(u`, `);return r.push(u` `),u.join(r)}buildDeleteQuery({table:e,where:r,returning:s,withList:n}){let o=this.buildWithCTE(n),i=s?u` returning ${this.buildSelection(s,{isSingleTable:!0})}`:void 0,a=r?u` where ${r}`:void 0;return u`${o}delete from ${e}${a}${i}`}buildUpdateSet(e,r){let s=e[h.Symbol.Columns],n=Object.keys(s).filter(i=>r[i]!==void 0||s[i]?.onUpdateFn!==void 0),o=n.length;return u.join(n.flatMap((i,a)=>{let l=s[i],c=r[i]??u.param(l.onUpdateFn(),l),d=u`${u.identifier(l.name)} = ${c}`;return a<o-1?[d,u.raw(", ")]:[d]}))}buildUpdateQuery({table:e,set:r,where:s,returning:n,withList:o}){let i=this.buildWithCTE(o),a=this.buildUpdateSet(e,r),l=n?u` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,c=s?u` where ${s}`:void 0;return u`${i}update ${e} set ${a}${c}${l}`}buildSelection(e,{isSingleTable:r=!1}={}){let s=e.length,n=e.flatMap(({field:o},i)=>{let a=[];if(p(o,g.Aliased)&&o.isSelectionField)a.push(u.identifier(o.fieldAlias));else if(p(o,g.Aliased)||p(o,g)){let l=p(o,g.Aliased)?o.sql:o;r?a.push(new g(l.queryChunks.map(c=>p(c,j)?u.identifier(c.name):c))):a.push(l),p(o,g.Aliased)&&a.push(u` as ${u.identifier(o.fieldAlias)}`)}else if(p(o,j)){let l=o.table[h.Symbol.Name],c=o.name;r?a.push(u.identifier(c)):a.push(u`${u.identifier(l)}.${u.identifier(c)}`)}return i<s-1&&a.push(u`, `),a});return u.join(n)}buildSelectQuery({withList:e,fields:r,fieldsFlat:s,where:n,having:o,table:i,joins:a,orderBy:l,groupBy:c,limit:d,offset:m,distinct:y,setOperators:S}){let v=s??ne(r);for(let G of v)if(p(G.field,j)&&Se(G.field.table)!==(p(i,U)?i._.alias:p(i,ke)?i[L].name:p(i,g)?void 0:Se(i))&&!(D=>a?.some(({alias:ge})=>ge===(D[h.Symbol.IsAlias]?Se(D):D[h.Symbol.BaseName])))(G.field.table)){let D=Se(G.field.table);throw new Error(`Your "${G.path.join("->")}" field references a column "${D}"."${G.field.name}", but the table "${D}" is not part of the query! Did you forget to join it?`)}let E=!a||a.length===0,T=this.buildWithCTE(e),A=y?u` distinct`:void 0,q=this.buildSelection(v,{isSingleTable:E}),N=p(i,h)&&i[h.Symbol.OriginalName]!==i[h.Symbol.Name]?u`${u.identifier(i[h.Symbol.OriginalName])} ${u.identifier(i[h.Symbol.Name])}`:i,$=[];if(a)for(let[G,D]of a.entries()){G===0&&$.push(u` `);let ge=D.table;if(p(ge,R)){let Lr=ge[R.Symbol.Name],jn=ge[R.Symbol.Schema],qn=ge[R.Symbol.OriginalName],Nn=Lr===qn?void 0:D.alias;$.push(u`${u.raw(D.joinType)} join ${jn?u`${u.identifier(jn)}.`:void 0}${u.identifier(qn)}${Nn&&u` ${u.identifier(Nn)}`} on ${D.on}`)}else $.push(u`${u.raw(D.joinType)} join ${ge} on ${D.on}`);G<a.length-1&&$.push(u` `)}let k=u.join($),se=n?u` where ${n}`:void 0,x=o?u` having ${o}`:void 0,C=[];if(l)for(let[G,D]of l.entries())C.push(D),G<l.length-1&&C.push(u`, `);let P=[];if(c)for(let[G,D]of c.entries())P.push(D),G<c.length-1&&P.push(u`, `);let Ue=P.length>0?u` group by ${u.join(P)}`:void 0,Lt=C.length>0?u` order by ${u.join(C)}`:void 0,ot=d?u` limit ${d}`:void 0,Ft=m?u` offset ${m}`:void 0,Dt=u`${T}select${A} ${q} from ${N}${k}${se}${Ue}${x}${Lt}${ot}${Ft}`;return S.length>0?this.buildSetOperations(Dt,S):Dt}buildSetOperations(e,r){let[s,...n]=r;if(!s)throw new Error("Cannot pass undefined values to any set operator");return n.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:s}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:s}),n)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:s,rightSelect:n,limit:o,orderBy:i,offset:a}}){let l=u`${e.getSQL()} `,c=u`${n.getSQL()}`,d;if(i&&i.length>0){let v=[];for(let E of i)if(p(E,re))v.push(u.identifier(E.name));else if(p(E,g)){for(let T=0;T<E.queryChunks.length;T++){let A=E.queryChunks[T];p(A,re)&&(E.queryChunks[T]=u.identifier(A.name))}v.push(u`${E}`)}else v.push(u`${E}`);d=u` order by ${u.join(v,u`, `)}`}let m=o?u` limit ${o}`:void 0,y=u.raw(`${r} ${s?"all ":""}`),S=a?u` offset ${a}`:void 0;return u`${l}${y}${c}${d}${m}${S}`}buildInsertQuery({table:e,values:r,onConflict:s,returning:n,withList:o}){let i=[],a=e[h.Symbol.Columns],l=Object.entries(a),c=l.map(([,v])=>u.identifier(v.name));for(let[v,E]of r.entries()){let T=[];for(let[A,q]of l){let N=E[A];if(N===void 0||p(N,ee)&&N.value===void 0){let $;if(q.default!==null&&q.default!==void 0)$=p(q.default,g)?q.default:u.param(q.default,q);else if(q.defaultFn!==void 0){let k=q.defaultFn();$=p(k,g)?k:u.param(k,q)}else if(!q.default&&q.onUpdateFn!==void 0){let k=q.onUpdateFn();$=p(k,g)?k:u.param(k,q)}else $=u`null`;T.push($)}else T.push(N)}i.push(T),v<r.length-1&&i.push(u`, `)}let d=this.buildWithCTE(o),m=u.join(i),y=n?u` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,S=s?u` on conflict ${s}`:void 0;return u`${d}insert into ${e} ${c} values ${m}${S}${y}`}sqlToQuery(e,r){return e.toQuery({escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,invokeSource:r})}buildRelationalQuery({fullSchema:e,schema:r,tableNamesMap:s,table:n,tableConfig:o,queryConfig:i,tableAlias:a,nestedQueryRelation:l,joinOn:c}){let d=[],m,y,S=[],v,E=[];if(i===!0)d=Object.entries(o.columns).map(([q,N])=>({dbKey:N.name,tsKey:q,field:pe(N,a),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let A=Object.fromEntries(Object.entries(o.columns).map(([x,C])=>[x,pe(C,a)]));if(i.where){let x=typeof i.where=="function"?i.where(A,Fo()):i.where;v=x&&mt(x,a)}let q=[],N=[];if(i.columns){let x=!1;for(let[C,P]of Object.entries(i.columns))P!==void 0&&C in o.columns&&(!x&&P===!0&&(x=!0),N.push(C));N.length>0&&(N=x?N.filter(C=>i.columns?.[C]===!0):Object.keys(o.columns).filter(C=>!N.includes(C)))}else N=Object.keys(o.columns);for(let x of N){let C=o.columns[x];q.push({tsKey:x,value:C})}let $=[];i.with&&($=Object.entries(i.with).filter(x=>!!x[1]).map(([x,C])=>({tsKey:x,queryConfig:C,relation:o.relations[x]})));let k;if(i.extras){k=typeof i.extras=="function"?i.extras(A,{sql:u}):i.extras;for(let[x,C]of Object.entries(k))q.push({tsKey:x,value:fs(C,a)})}for(let{tsKey:x,value:C}of q)d.push({dbKey:p(C,g.Aliased)?C.fieldAlias:o.columns[x].name,tsKey:x,field:p(C,j)?pe(C,a):C,relationTableTsKey:void 0,isJson:!1,selection:[]});let se=typeof i.orderBy=="function"?i.orderBy(A,Do()):i.orderBy??[];Array.isArray(se)||(se=[se]),S=se.map(x=>p(x,j)?pe(x,a):mt(x,a)),m=i.limit,y=i.offset;for(let{tsKey:x,queryConfig:C,relation:P}of $){let Ue=Uo(r,s,P),Lt=je(P.referencedTable),ot=s[Lt],Ft=`${a}_${x}`,Dt=ae(...Ue.fields.map((ge,Lr)=>b(pe(Ue.references[Lr],Ft),pe(ge,a)))),G=this.buildRelationalQuery({fullSchema:e,schema:r,tableNamesMap:s,table:e[ot],tableConfig:r[ot],queryConfig:p(P,Ee)?C===!0?{limit:1}:{...C,limit:1}:C,tableAlias:Ft,joinOn:Dt,nestedQueryRelation:P}),D=u`(${G.sql})`.as(x);d.push({dbKey:x,tsKey:x,field:D,relationTableTsKey:ot,isJson:!0,selection:G.selection})}}if(d.length===0)throw new Me({message:`No fields selected for table "${o.tsName}" ("${a}"). You need to have at least one item in "columns", "with" or "extras". If you need to select all columns, omit the "columns" key or set it to undefined.`});let T;if(v=ae(c,v),l){let A=u`json_array(${u.join(d.map(({field:$})=>p($,re)?u.identifier($.name):p($,g.Aliased)?$.sql:$),u`, `)})`;p(l,ht)&&(A=u`coalesce(json_group_array(${A}), json_array())`);let q=[{dbKey:"data",tsKey:"data",field:A.as("data"),isJson:!0,relationTableTsKey:o.tsName,selection:d}];m!==void 0||y!==void 0||S.length>0?(T=this.buildSelectQuery({table:pt(n,a),fields:{},fieldsFlat:[{path:[],field:u.raw("*")}],where:v,limit:m,offset:y,orderBy:S,setOperators:[]}),v=void 0,m=void 0,y=void 0,S=void 0):T=pt(n,a),T=this.buildSelectQuery({table:p(T,R)?T:new U(T,{},a),fields:{},fieldsFlat:q.map(({field:$})=>({path:[],field:p($,j)?pe($,a):$})),joins:E,where:v,limit:m,offset:y,orderBy:S,setOperators:[]})}else T=this.buildSelectQuery({table:pt(n,a),fields:{},fieldsFlat:d.map(({field:A})=>({path:[],field:p(A,j)?pe(A,a):A})),joins:E,where:v,limit:m,offset:y,orderBy:S,setOperators:[]});return{tableTsKey:o.tsName,sql:T,selection:d}}},We=class extends ur{static[f]="SQLiteSyncDialect";migrate(e,r,s){let n=s===void 0||typeof s=="string"?"__drizzle_migrations":s.migrationsTable??"__drizzle_migrations",o=u`
			CREATE TABLE IF NOT EXISTS ${u.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;r.run(o);let a=r.values(u`SELECT id, hash, created_at FROM ${u.identifier(n)} ORDER BY created_at DESC LIMIT 1`)[0]??void 0;r.run(u`BEGIN`);try{for(let l of e)if(!a||Number(a[2])<l.folderMillis){for(let c of l.sql)r.run(u.raw(c));r.run(u`INSERT INTO ${u.identifier(n)} ("hash", "created_at") VALUES(${l.hash}, ${l.folderMillis})`)}r.run(u`COMMIT`)}catch(l){throw r.run(u`ROLLBACK`),l}}},Vo=class extends ur{static[f]="SQLiteAsyncDialect";async migrate(e,r,s){let n=s===void 0||typeof s=="string"?"__drizzle_migrations":s.migrationsTable??"__drizzle_migrations",o=u`
			CREATE TABLE IF NOT EXISTS ${u.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;await r.run(o);let a=(await r.values(u`SELECT id, hash, created_at FROM ${u.identifier(n)} ORDER BY created_at DESC LIMIT 1`))[0]??void 0;await r.transaction(async l=>{for(let c of e)if(!a||Number(a[2])<c.folderMillis){for(let d of c.sql)await l.run(u.raw(d));await l.run(u`INSERT INTO ${u.identifier(n)} ("hash", "created_at") VALUES(${c.hash}, ${c.folderMillis})`)}})}};var dr=class{static[f]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}};var oe=class{static[f]="SQLiteSelectBuilder";fields;session;dialect;withList;distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,this.withList=e.withList,this.distinct=e.distinct}from(e){let r=!!this.fields,s;return this.fields?s=this.fields:p(e,U)?s=Object.fromEntries(Object.keys(e._.selectedFields).map(n=>[n,e[n]])):p(e,ke)?s=e[L].selectedFields:p(e,g)?s={}:s=zo(e),new fr({table:e,fields:s,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct})}},Ps=class extends dr{static[f]="SQLiteSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:s,session:n,dialect:o,withList:i,distinct:a}){super(),this.config={withList:i,table:e,fields:{...r},distinct:a,setOperators:[]},this.isPartialSelect=s,this.session=n,this.dialect=o,this._={selectedFields:r},this.tableName=ws(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}createJoin(e){return(r,s)=>{let n=this.tableName,o=ws(r);if(typeof o=="string"&&this.config.joins?.some(i=>i.alias===o))throw new Error(`Alias "${o}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof n=="string"&&(this.config.fields={[n]:this.config.fields}),typeof o=="string"&&!p(r,g))){let i=p(r,U)?r._.selectedFields:p(r,te)?r[L].selectedFields:r[h.Symbol.Columns];this.config.fields[o]=i}if(typeof s=="function"&&(s=s(new Proxy(this.config.fields,new X({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:s,table:r,joinType:e,alias:o}),typeof o=="string")switch(e){case"left":{this.joinsNotNullableMap[o]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([i])=>[i,!1])),this.joinsNotNullableMap[o]=!0;break}case"inner":{this.joinsNotNullableMap[o]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([i])=>[i,!1])),this.joinsNotNullableMap[o]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");createSetOperator(e,r){return s=>{let n=typeof s=="function"?s(Oa()):s;if(!ys(this.getSelectedFields(),n.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:r,rightSelect:n}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);except=this.createSetOperator("except",!1);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new X({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new X({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){let r=e[0](new Proxy(this.config.fields,new X({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){let r=e[0](new Proxy(this.config.fields,new X({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),s=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=s:this.config.orderBy=s}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new U(this.getSQL(),this.config.fields,e),new X({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new X({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}},fr=class extends Ps{static[f]="SQLiteSelect";_prepare(e=!0){if(!this.session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");let r=ne(this.config.fields),s=this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),r,"all",!0);return s.joinsNotNullableMap=this.joinsNotNullableMap,s}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.all()}};Go(fr,[z]);function pr(t,e){return(r,s,...n)=>{let o=[s,...n].map(i=>({type:t,isAll:e,rightSelect:i}));for(let i of o)if(!ys(r.getSelectedFields(),i.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return r.addSetOperators(o)}}var Oa=()=>({union:Ra,unionAll:_a,intersect:Ba,except:Pa}),Ra=pr("union",!1),_a=pr("union",!0),Ba=pr("intersect",!1),Pa=pr("except",!1);var mr=class{static[f]="SQLiteQueryBuilder";dialect;$with(e){let r=this;return{as(s){return typeof s=="function"&&(s=s(r)),new Proxy(new He(s.getSQL(),s.getSelectedFields(),e,!0),new X({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){let r=this;function s(o){return new oe({fields:o??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function n(o){return new oe({fields:o??void 0,session:void 0,dialect:r.getDialect(),withList:e,distinct:!0})}return{select:s,selectDistinct:n}}select(e){return new oe({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new oe({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}getDialect(){return this.dialect||(this.dialect=new We),this.dialect}};var vt=class{constructor(e,r,s,n){this.table=e,this.session=r,this.dialect=s,this.withList=n}static[f]="SQLiteUpdateBuilder";set(e){return new Ls(this.table,ar(this.table,e),this.session,this.dialect,this.withList)}},Ls=class extends z{constructor(e,r,s,n,o){super(),this.session=s,this.dialect=n,this.config={set:r,table:e,withList:o}}static[f]="SQLiteUpdate";config;where(e){return this.config.where=e,this}returning(e=this.config.table[R.Symbol.Columns]){return this.config.returning=ne(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}};var hr=class{constructor(e,r,s,n,o,i,a,l){this.mode=e,this.fullSchema=r,this.schema=s,this.tableNamesMap=n,this.table=o,this.tableConfig=i,this.dialect=a,this.session=l}static[f]="SQLiteAsyncRelationalQueryBuilder";findMany(e){return this.mode==="sync"?new gr(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many"):new xt(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return this.mode==="sync"?new gr(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first"):new xt(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}},xt=class extends z{constructor(e,r,s,n,o,i,a,l,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=s,this.table=n,this.tableConfig=o,this.dialect=i,this.session=a,this.config=l,this.mode=c}static[f]="SQLiteAsyncRelationalQuery";mode;getSQL(){return this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}).sql}_prepare(e=!1){let{query:r,builtQuery:s}=this._toSQL();return this.session[e?"prepareOneTimeQuery":"prepareQuery"](s,void 0,this.mode==="first"?"get":"all",!0,(n,o)=>{let i=n.map(a=>ir(this.schema,this.tableConfig,a,r.selection,o));return this.mode==="first"?i[0]:i})}prepare(){return this._prepare(!1)}_toSQL(){let e=this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}executeRaw(){return this.mode==="first"?this._prepare(!1).get():this._prepare(!1).all()}async execute(){return this.executeRaw()}},gr=class extends xt{static[f]="SQLiteSyncRelationalQuery";sync(){return this.executeRaw()}};var $e=class extends z{constructor(e,r,s,n,o){super(),this.execute=e,this.getSQL=r,this.dialect=n,this.mapBatchResult=o,this.config={action:s}}static[f]="SQLiteRaw";config;getQuery(){return{...this.dialect.sqlToQuery(this.getSQL()),method:this.config.action}}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Je=class{constructor(e,r,s,n){this.resultKind=e,this.dialect=r,this.session=s,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap}:{schema:void 0,fullSchema:{},tableNamesMap:{}},this.query={};let o=this.query;if(this._.schema)for(let[i,a]of Object.entries(this._.schema))o[i]=new hr(e,n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,r,s)}static[f]="BaseSQLiteDatabase";query;$with(e){return{as(r){return typeof r=="function"&&(r=r(new mr)),new Proxy(new He(r.getSQL(),r.getSelectedFields(),e,!0),new X({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){let r=this;function s(l){return new oe({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e})}function n(l){return new oe({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function o(l){return new vt(l,r.session,r.dialect,e)}function i(l){return new yt(l,r.session,r.dialect,e)}function a(l){return new gt(l,r.session,r.dialect,e)}return{select:s,selectDistinct:n,update:o,insert:i,delete:a}}select(e){return new oe({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new oe({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}update(e){return new vt(e,this.session,this.dialect)}insert(e){return new yt(e,this.session,this.dialect)}delete(e){return new gt(e,this.session,this.dialect)}run(e){let r=e.getSQL();return this.resultKind==="async"?new $e(async()=>this.session.run(r),()=>r,"run",this.dialect,this.session.extractRawRunValueFromBatchResult.bind(this.session)):this.session.run(r)}all(e){let r=e.getSQL();return this.resultKind==="async"?new $e(async()=>this.session.all(r),()=>r,"all",this.dialect,this.session.extractRawAllValueFromBatchResult.bind(this.session)):this.session.all(r)}get(e){let r=e.getSQL();return this.resultKind==="async"?new $e(async()=>this.session.get(r),()=>r,"get",this.dialect,this.session.extractRawGetValueFromBatchResult.bind(this.session)):this.session.get(r)}values(e){let r=e.getSQL();return this.resultKind==="async"?new $e(async()=>this.session.values(r),()=>r,"values",this.dialect,this.session.extractRawValuesValueFromBatchResult.bind(this.session)):this.session.values(r)}transaction(e,r){return this.session.transaction(e,r)}};function Ds(...t){return t[0].columns?new yr(t[0].columns,t[0].name):new yr(t)}var yr=class{static[f]="SQLitePrimaryKeyBuilder";columns;name;constructor(e,r){this.columns=e,this.name=r}build(e){return new Fs(e,this.columns,this.name)}},Fs=class{constructor(e,r,s){this.table=e,this.columns=r,this.name=s}static[f]="SQLitePrimaryKey";columns;name;getName(){return this.name??`${this.table[R.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}};var Qs=class extends z{constructor(e){super(),this.resultCb=e}static[f]="ExecuteResultSync";async execute(){return this.resultCb()}sync(){return this.resultCb()}},wr=class{constructor(e,r,s){this.mode=e,this.executeMethod=r,this.query=s}static[f]="PreparedQuery";joinsNotNullableMap;getQuery(){return this.query}mapRunResult(e,r){return e}mapAllResult(e,r){throw new Error("Not implemented")}mapGetResult(e,r){throw new Error("Not implemented")}execute(e){return this.mode==="async"?this[this.executeMethod](e):new Qs(()=>this[this.executeMethod](e))}mapResult(e,r){switch(this.executeMethod){case"run":return this.mapRunResult(e,r);case"all":return this.mapAllResult(e,r);case"get":return this.mapGetResult(e,r)}}},br=class{constructor(e){this.dialect=e}static[f]="SQLiteSession";prepareOneTimeQuery(e,r,s,n){return this.prepareQuery(e,r,s,n)}run(e){let r=this.dialect.sqlToQuery(e);try{return this.prepareOneTimeQuery(r,void 0,"run",!1).run()}catch(s){throw new Me({cause:s,message:`Failed to run the query '${r.sql}'`})}}extractRawRunValueFromBatchResult(e){return e}all(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).all()}extractRawAllValueFromBatchResult(e){throw new Error("Not implemented")}get(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).get()}extractRawGetValueFromBatchResult(e){throw new Error("Not implemented")}values(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).values()}extractRawValuesValueFromBatchResult(e){throw new Error("Not implemented")}},vr=class extends Je{constructor(e,r,s,n,o=0){super(e,r,s,n),this.schema=n,this.nestedIndex=o}static[f]="SQLiteTransaction";rollback(){throw new Zt}};var xr=class extends br{constructor(e,r,s,n={}){super(r),this.client=e,this.schema=s,this.logger=n.logger??new sr}static[f]="BetterSQLiteSession";logger;prepareQuery(e,r,s,n,o){let i=this.client.prepare(e.sql);return new Ks(i,e,this.logger,r,s,n,o)}transaction(e,r={}){let s=new Us("sync",this.dialect,this,this.schema);return this.client.transaction(e)[r.behavior??"deferred"](s)}},Us=class t extends vr{static[f]="BetterSQLiteTransaction";transaction(e){let r=`sp${this.nestedIndex}`,s=new t("sync",this.dialect,this.session,this.schema,this.nestedIndex+1);this.session.run(u.raw(`savepoint ${r}`));try{let n=e(s);return this.session.run(u.raw(`release savepoint ${r}`)),n}catch(n){throw this.session.run(u.raw(`rollback to savepoint ${r}`)),n}}},Ks=class extends wr{constructor(e,r,s,n,o,i,a){super("sync",o,r),this.stmt=e,this.logger=s,this.fields=n,this._isResponseInArrayMode=i,this.customResultMapper=a}static[f]="BetterSQLitePreparedQuery";run(e){let r=ft(this.query.params,e??{});return this.logger.logQuery(this.query.sql,r),this.stmt.run(...r)}all(e){let{fields:r,joinsNotNullableMap:s,query:n,logger:o,stmt:i,customResultMapper:a}=this;if(!r&&!a){let c=ft(n.params,e??{});return o.logQuery(n.sql,c),i.all(...c)}let l=this.values(e);return a?a(l):l.map(c=>gs(r,c,s))}get(e){let r=ft(this.query.params,e??{});this.logger.logQuery(this.query.sql,r);let{fields:s,stmt:n,joinsNotNullableMap:o,customResultMapper:i}=this;if(!s&&!i)return n.get(...r);let a=n.raw().get(...r);if(a)return i?i([a]):gs(s,a,o)}values(e){let r=ft(this.query.params,e??{});return this.logger.logQuery(this.query.sql,r),this.stmt.raw().all(...r)}isResponseInArrayMode(){return this._isResponseInArrayMode}};function ko(t,e={}){let r=new We,s;e.logger===!0?s=new rr:e.logger!==!1&&(s=e.logger);let n;if(e.schema){let i=Qo(e.schema,Ko);n={fullSchema:e.schema,schema:i.tables,tableNamesMap:i.tableNamesMap}}let o=new xr(t,r,n,{logger:s});return new Je("sync",r,o,n)}var Ni=Qt(qi());var Ws={};la(Ws,{attachments:()=>de,conversationMembers:()=>be,conversations:()=>I,folders:()=>ie,messageGroupMessages:()=>J,messageGroups:()=>V,messages:()=>O,participants:()=>Z,sessions:()=>It,users:()=>Et});var Z=ce("participants",{id:_("id").primaryKey({autoIncrement:!0}),username:M("username").notNull().unique(),role:M("role").notNull().default("member"),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),ie=ce("folders",{id:M("id").primaryKey(),name:M("name").notNull(),description:M("description"),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),I=ce("conversations",{id:M("id").primaryKey(),title:M("title").notNull(),systemMessage:M("system_message").default(""),userId:_("user_id").default(1),enableSystemMessage:cr("enable_system_message").default("1"),folderId:M("folder_id").references(()=>ie.id),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),O=ce("messages",{id:M("id").primaryKey(),conversationId:M("conversation_id").notNull().references(()=>I.id),participantId:_("participant_id").notNull().references(()=>Z.id),content:M("content").notNull(),parentId:M("parent_id"),reasoningContent:M("reasoning_content"),collapsed:cr("collapsed").default("0"),hasError:cr("has_error").default("0"),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),Et=ce("users",{id:_("id").primaryKey({autoIncrement:!0}),username:M("username").notNull().unique(),email:M("email").notNull().unique(),fullname:M("fullname").notNull(),passwd:M("passwd").notNull(),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),be=ce("conversation_members",{conversationId:M("conversation_id").notNull().references(()=>I.id),participantId:_("participant_id").notNull().references(()=>Z.id)},t=>({pk:Ds({columns:[t.conversationId,t.participantId]})})),V=ce("message_groups",{id:M("id").primaryKey(),conversationId:M("conversation_id").notNull().references(()=>I.id),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),J=ce("message_group_messages",{messageId:M("message_id").notNull().references(()=>O.id),messageGroupId:M("message_group_id").notNull().references(()=>V.id)},t=>({pk:Ds({columns:[t.messageId,t.messageGroupId]})})),de=ce("attachments",{id:M("id").primaryKey(),filename:M("filename").notNull(),mimetype:M("mimetype").notNull(),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),It=ce("sessions",{id:M("id").primaryKey(),userId:_("user_id").notNull().references(()=>Et.id),sessionToken:M("session_token").notNull().unique(),expiresAt:_("expires_at",{mode:"timestamp"}).notNull(),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)});var fl=new Ni.default("sqlite.db"),w=ko(fl,{schema:Ws});var Xe=async t=>await w.insert(Z).values(t).returning(),Js=async t=>await w.select().from(Z).where(b(Z.id,t)).get(),Ys=async t=>await w.select().from(Z).where(b(Z.username,t)).get();var Mi=Qt(require("crypto")),$r=new Uint8Array(256),Mr=$r.length;function Xs(){return Mr>$r.length-16&&(Mi.default.randomFillSync($r),Mr=0),$r.slice(Mr,Mr+=16)}var K=[];for(let t=0;t<256;++t)K.push((t+256).toString(16).slice(1));function $i(t,e=0){return K[t[e+0]]+K[t[e+1]]+K[t[e+2]]+K[t[e+3]]+"-"+K[t[e+4]]+K[t[e+5]]+"-"+K[t[e+6]]+K[t[e+7]]+"-"+K[t[e+8]]+K[t[e+9]]+"-"+K[t[e+10]]+K[t[e+11]]+K[t[e+12]]+K[t[e+13]]+K[t[e+14]]+K[t[e+15]]}var Ai=Qt(require("crypto")),Zs={randomUUID:Ai.default.randomUUID};function pl(t,e,r){if(Zs.randomUUID&&!e&&!t)return Zs.randomUUID();t=t||{};let s=t.random||(t.rng||Xs)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){r=r||0;for(let n=0;n<16;++n)e[r+n]=s[n];return e}return $i(s)}var Re=pl;var Tt=async t=>{let e={...t,id:t.id||Re()};return await w.insert(I).values(e).returning()},fe=async t=>await w.select().from(I).where(b(I.id,t)).get(),en=async()=>await w.select({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt}).from(I).orderBy(le(I.updatedAt)).all(),Oi=async t=>await w.select({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt}).from(I).where(b(I.userId,t)).orderBy(le(I.updatedAt)).all(),tn=async(t,e)=>{let r={...e,updatedAt:new Date};return await w.update(I).set(r).where(b(I.id,t)).returning({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt})},rn=async t=>(await w.delete(O).where(b(O.conversationId,t)),await w.delete(be).where(b(be.conversationId,t)),await w.delete(I).where(b(I.id,t)).returning({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt}));var Ct=async t=>await w.insert(O).values(t).returning();var sn=async t=>await w.select().from(O).where(b(O.id,t)).orderBy(le(O.createdAt)).all(),jt=async t=>{console.log(`Attempting to delete message with ID: ${t}`);let e=await w.delete(O).where(b(O.id,t.toString())).returning();return console.log("Delete message result:",e),e},nn=async t=>{console.log(`Attempting to delete message with conversation ID: ${t}`);let e=await w.delete(O).where(b(O.conversationId,t)).returning();return console.log("Delete message result:",e),e},on=async(t,e)=>{console.log(`Attempting to update message with ID: ${t}`,e);let r=await w.update(O).set(e).where(b(O.id,t)).returning();return console.log("Update message result:",r),r},qt=async t=>await w.select({id:O.id,content:O.content,username:Z.username,role:Z.role,createdAt:O.createdAt,parentId:O.parentId,collapsed:O.collapsed,groupId:J.messageGroupId,replyCount:u`(SELECT COUNT(*) FROM messages AS replies WHERE replies.parent_id = messages.id)`.as("replyCount")}).from(O).innerJoin(Z,b(O.participantId,Z.id)).leftJoin(J,b(O.id,J.messageId)).where(b(O.conversationId,t)).orderBy(tr(O.createdAt)).all();var an=async t=>await w.insert(be).values(t).returning();var Ar=async(t,e)=>!!await w.select().from(be).where(ae(b(be.conversationId,t),b(be.participantId,e))).get();var ln=async t=>{let e={...t,id:t.id||Re()};return await w.insert(ie).values(e).returning()},Nt=async t=>await w.select().from(ie).where(b(ie.id,t)).get(),cn=async()=>await w.select().from(ie).orderBy(le(ie.updatedAt)).all(),un=async(t,e)=>{let r={...e,updatedAt:new Date};return await w.update(ie).set(r).where(b(ie.id,t)).returning()},dn=async t=>(await w.delete(I).where(b(I.folderId,t)),await w.delete(ie).where(b(ie.id,t)).returning());var fn=async t=>{let e={...t,id:t.id||Re()},[r]=await w.insert(V).values(e).returning();return r},pn=async()=>await w.select().from(V).all(),he=async t=>await w.select().from(V).where(b(V.id,t)).get(),Ze=async t=>await w.select().from(V).where(b(V.conversationId,t)).all(),mn=async t=>!!await w.select({id:V.id}).from(V).where(b(V.id,t)).get(),hn=async(t,e)=>{let r={...e,updatedAt:new Date};return await w.update(V).set(r).where(b(V.id,t)).returning()},Mt=async t=>(await w.delete(J).where(b(J.messageGroupId,t)),await w.delete(V).where(b(V.id,t)).returning());var $t=async t=>await w.insert(J).values(t).returning(),At=async t=>await w.select().from(J).where(b(J.messageGroupId,t)).all();var Ot=async(t,e)=>await w.delete(J).where(ae(b(J.messageId,t),b(J.messageGroupId,e))).returning();var Or=async t=>await w.insert(de).values(t).returning(),Rt=async t=>await w.select().from(de).where(b(de.id,t)).all(),gn=async()=>await w.select().from(de).orderBy(le(de.createdAt)).all(),yn=async(t,e)=>await w.update(de).set(e).where(b(de.id,t)).returning(),wn=async t=>await w.delete(de).where(b(de.id,t)).returning();var bn=async t=>await w.select().from(Et).where(b(Et.id,t)).get();var vn=async t=>{let e=new Date;return await w.select().from(It).where(ae(b(It.sessionToken,t),er(It.expiresAt,e))).get()};var _e=async(t,e)=>{let r=t.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return t.json({success:!1,error:"Missing or invalid authorization token"},401);let s=r.substring(7);if(!s)return t.json({success:!1,error:"Invalid authorization token"},401);let n=await vn(s);if(!n)return t.json({success:!1,error:"Invalid or expired session"},401);let o=await bn(n.userId);if(!o)return t.json({success:!1,error:"User not found"},401);t.set("user",{id:o.id,username:o.username}),await e()};var ve=new Q;ve.post("/participants",async t=>{try{let e=await t.req.json(),r=await Xe(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create participant"},400)}});ve.get("/participants/:id",async t=>{try{let e=parseInt(t.req.param("id")),r=await Js(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Participant not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch participant"},500)}});ve.post("/conversations",_e,async t=>{try{let e=await t.req.json(),r=await Tt(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create conversation"},400)}});ve.get("/conversations",_e,async t=>{try{let e=await en();return t.json({success:!0,data:e})}catch{return t.json({success:!1,error:"Failed to fetch conversations"},500)}});ve.get("/conversations/:id",_e,async t=>{try{let e=t.req.param("id"),r=await fe(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Conversation not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch conversation"},500)}});ve.post("/conversations/:conversationId/messages",_e,async t=>{try{let e=t.req.param("conversationId"),r=await t.req.json();if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let n=t.get("user");if(!await Ar(e,n.id))return t.json({success:!1,error:"You are not a member of this conversation"},403);let i=await Ct({...r,conversationId:e,participantId:n.id});return t.json({success:!0,data:i})}catch{return t.json({success:!1,error:"Failed to create message"},400)}});ve.get("/conversations/:conversationId/messages",_e,async t=>{try{let e=t.req.param("conversationId");if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let s=t.get("user");if(!await Ar(e,s.id))return t.json({success:!1,error:"You are not a member of this conversation"},403);let o=await qt(e);return t.json({success:!0,data:o})}catch{return t.json({success:!1,error:"Failed to fetch messages"},500)}});ve.post("/conversations/:conversationId/members",_e,async t=>{try{let e=t.req.param("conversationId"),r=await t.req.json();if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let n=t.get("user"),o=await an({...r,conversationId:e,participantId:n.id});return t.json({success:!0,data:o})}catch{return t.json({success:!1,error:"Failed to add member"},400)}});var Ri=ve;var et=new Q;et.post("/",async t=>{try{let e=await t.req.json(),r=await ln(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create folder"},400)}});et.get("/",async t=>{try{let e=await cn();return t.json({success:!0,data:e})}catch(e){return console.error("Error fetching folders:",e),t.json({success:!1,error:"Failed to fetch folders"},500)}});et.get("/:id",async t=>{try{let e=t.req.param("id"),r=await Nt(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Folder not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch folder"},500)}});et.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if(!await Nt(e))return t.json({success:!1,error:"Folder not found"},404);let n=await un(e,r);return n.length===0?t.json({success:!1,error:"Failed to update folder"},500):t.json({success:!0,data:n[0],message:"Folder updated successfully"})}catch(e){return console.error("Error updating folder:",e),t.json({success:!1,error:"Failed to update folder"},500)}});et.delete("/:id",async t=>{try{let e=t.req.param("id");return await Nt(e)?(await dn(e)).length===0?t.json({success:!1,error:"Failed to delete folder"},500):t.json({success:!0,message:"Folder deleted successfully"}):t.json({success:!1,error:"Folder not found"},404)}catch(e){return console.error("Error deleting folder:",e),t.json({success:!1,error:"Failed to delete folder"},500)}});var _i=et;var Be=new Q;Be.post("/",async t=>{try{let e=await t.req.json(),r=await Tt(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create conversation"},400)}});Be.get("/users/:userId",async t=>{try{let e=parseInt(t.req.param("userId")),r=await Oi(e);return t.json({success:!0,data:r})}catch(e){return console.error("Error fetching conversations:",e),t.json({success:!1,error:"Failed to fetch conversations"},500)}});Be.get("/:id",async t=>{try{let e=t.req.param("id"),r=await fe(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Conversation not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch conversation"},500)}});Be.get("/:id/message-groups",async t=>{try{let e=t.req.param("id");if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let s=await Ze(e);return t.json({success:!0,data:s})}catch(e){return console.error("Error fetching message groups:",e),t.json({success:!1,error:"Failed to fetch message groups"},500)}});Be.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let n=await tn(e,r);return n.length===0?t.json({success:!1,error:"Failed to update conversation"},500):t.json({success:!0,data:n[0],message:"Conversation updated successfully"})}catch(e){return console.error("Error updating conversation:",e),t.json({success:!1,error:"Failed to update conversation"},500)}});Be.delete("/:id",async t=>{try{let e=t.req.param("id"),r=await fe(e);if(!r)return t.json({success:!1,error:"Conversation not found"},404);let s=await Ze(e);for(let o of s){let i=o.id,a=await At(i);for(let l of a){let{messageId:c}=l;await Ot(c,i);try{await jt(c)}catch(d){console.error(d)}}console.log({messageGroupMessages:a}),await Mt(i)}console.log({messageGroups:s});let n=await nn(e);return n=await rn(e),n.length===0?t.json({success:!1,error:"Failed to delete conversation"},500):t.json({success:!0,message:"Conversation deleted successfully",data:r})}catch(e){return console.error("Error deleting conversation:",e),t.json({success:!1,error:"Failed to delete conversation"},500)}});var Bi=Be;var _t=new Q;_t.post("/conversations/:conversationId",async t=>{try{let e=t.req.param("conversationId"),r=await t.req.json(),s;if(r.username){if(s=await Ys(r.username),!s){let c={username:r.username,role:r.role||"user"};console.log("Create participant",c);let[d]=await Xe(c);s=d}}else{let c={username:r.username||`participant_${Date.now()}`,role:r.role||"user"},[d]=await Xe(c);s=d}console.log("Using participant",s);let{groupId:n,...o}=r,i={id:o.id?.toString()||Math.floor(Math.random()*1e6).toString(),content:o.content,conversationId:e,participantId:s.id,parentId:o.parentId},[a]=await sn(i.id);if(!a){let[c]=await Ct(i);a=c}if(n&&a){let c=await mn(n);if(console.log({groupExists:c}),c){let d=await $t({messageId:a.id,messageGroupId:n});console.log({messageGroupMessage:d})}}let l={...a,groupId:r.groupId||null};return t.json({success:!0,data:[l]})}catch(e){return console.error("Error creating message:",e),t.json({success:!1,error:"Failed to create message"},400)}});_t.get("/conversations/:conversationId",async t=>{try{let e=t.req.param("conversationId"),r=await qt(e);return t.json({success:!0,data:r})}catch(e){return console.error("Error fetching messages:",e),t.json({success:!1,error:"Failed to fetch messages"},500)}});_t.delete("/conversations/:conversationId/:messageId",async t=>{try{let e=t.req.param("messageId");return console.log(`Delete message request - Message ID: ${e}`),(await jt(e)).length===0?(console.log(`Message not found for ID: ${e}`),t.json({success:!1,error:"Message not found"},404)):(console.log(`Message deleted successfully - ID: ${e}`),t.json({success:!0,message:"Message deleted successfully"}))}catch(e){return console.error("Error deleting message:",e),t.json({success:!1,error:"Failed to delete message"},500)}});_t.put("/conversations/:conversationId/:messageId",async t=>{try{let e=t.req.param("messageId"),r=await t.req.json();console.log(`Update message request - Message ID: ${e}`,r);let{id:s,conversationId:n,participantId:o,...i}=r,{groupId:a}=r,l=await sn(r.id);console.log({existing:l});let c=await on(e,i);return c.length===0?(console.log(`Message not found for ID: ${e}`),t.json({success:!1,error:"Message not found"},404)):(console.log(`Message updated successfully - ID: ${e}`),t.json({success:!0,data:c.map(d=>(d.id===e&&(d.groupId=a),d))}))}catch(e){return console.error("Error updating message:",e),t.json({success:!1,error:"Failed to update message"},500)}});var Pi=_t;var Pe=new Q;Pe.post("/",async t=>{try{let e=await t.req.json(),{id:r}=e,s=await he(r);return s||(s=await fn(e)),t.json({success:!0,data:s})}catch(e){return console.error("Error creating message group:",e),t.json({success:!1,error:"Failed to create message group"},400)}});Pe.get("/",async t=>{try{let e=await pn();return t.json({success:!0,data:e})}catch(e){return console.error("Error fetching message groups:",e),t.json({success:!1,error:"Failed to fetch message groups"},500)}});Pe.get("/conversation/:conversationId",async t=>{try{let e=t.req.param("conversationId"),r=await Ze(e);return t.json({success:!0,data:r})}catch(e){return console.error("Error fetching message groups by conversation ID:",e),t.json({success:!1,error:"Failed to fetch message groups by conversation ID"},500)}});Pe.get("/:id",async t=>{try{let e=t.req.param("id"),r=await he(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Message group not found"},404)}catch(e){return console.error("Error fetching message group:",e),t.json({success:!1,error:"Failed to fetch message group"},500)}});Pe.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if(!await he(e))return t.json({success:!1,error:"Message group not found"},404);let n=await hn(e,r);return n.length===0?t.json({success:!1,error:"Failed to update message group"},500):t.json({success:!0,data:n[0],message:"Message group updated successfully"})}catch(e){return console.error("Error updating message group:",e),t.json({success:!1,error:"Failed to update message group"},500)}});Pe.delete("/:id",async t=>{try{let e=t.req.param("id");return await he(e)?(await Mt(e)).length===0?t.json({success:!1,error:"Failed to delete message group"},500):t.json({success:!0,message:"Message group deleted successfully"}):t.json({success:!1,error:"Message group not found"},404)}catch(e){return console.error("Error deleting message group:",e),t.json({success:!1,error:"Failed to delete message group"},500)}});var Li=Pe;var Rr=new Q;Rr.post("/:messageGroupId",async t=>{try{let e=t.req.param("messageGroupId"),r=await t.req.json();if(!await he(e))return t.json({success:!1,error:"Message group not found"},404);let n=await $t({messageId:r.messageId,messageGroupId:e});return t.json({success:!0,data:n})}catch(e){return console.error("Error creating message group message:",e),t.json({success:!1,error:"Failed to create message group message"},400)}});Rr.get("/:messageGroupId",async t=>{try{let e=t.req.param("messageGroupId");if(!await he(e))return t.json({success:!1,error:"Message group not found"},404);let s=await At(e);return t.json({success:!0,data:s})}catch(e){return console.error("Error fetching message group messages:",e),t.json({success:!1,error:"Failed to fetch message group messages"},500)}});Rr.delete("/:messageGroupId/:messageId",async t=>{try{let e=t.req.param("messageGroupId"),r=t.req.param("messageId");return await he(e)?(await Ot(r,e)).length===0?t.json({success:!1,error:"Message group message not found"},404):t.json({success:!0,message:"Message group message deleted successfully"}):t.json({success:!1,error:"Message group not found"},404)}catch(e){return console.error("Error deleting message group message:",e),t.json({success:!1,error:"Failed to delete message group message"},500)}});var Fi=Rr;var tt=require("fs"),xn=require("path"),Di=require("crypto"),ml=t=>({"image/jpeg":".jpg","image/png":".png","image/gif":".gif","image/svg+xml":".svg","image/webp":".webp","text/plain":".txt","text/html":".html","text/css":".css","text/csv":".csv","application/json":".json","application/pdf":".pdf","application/zip":".zip","application/x-tar":".tar","application/javascript":".js","application/xml":".xml","application/msword":".doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":".docx","application/vnd.ms-excel":".xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":".xlsx","application/vnd.ms-powerpoint":".ppt","application/vnd.openxmlformats-officedocument.presentationml.presentation":".pptx"})[t]||"",Le=new Q;Le.post("/",async t=>{try{let e=await t.req.json();if(!e.filename)return t.json({success:!1,error:"Filename is required"},400);if(!e.mimetype)return t.json({success:!1,error:"Mimetype is required"},400);let r={id:e.id||Math.floor(Math.random()*1e6).toString(),filename:e.filename,mimetype:e.mimetype},[s]=await Or(r);return t.json({success:!0,data:[s]})}catch(e){return console.error("Error creating attachment:",e),t.json({success:!1,error:"Failed to create attachment"},500)}});Le.post("/download",async t=>{try{let e=await t.req.json();if(!e.url)return t.json({success:!1,error:"URL is required"},400);let r=(0,xn.join)(process.cwd(),"file_attachments");(0,tt.existsSync)(r)||(0,tt.mkdirSync)(r,{recursive:!0});let s=(0,Di.randomUUID)(),n=(0,xn.join)(r,s),o=await fetch(e.url);if(!o.ok)return t.json({success:!1,error:"Failed to download file from URL"},400);let i=(0,tt.createWriteStream)(n),a=await o.arrayBuffer(),l=Buffer.from(a);i.write(l),i.end();let c=e.url.split("/").pop()||"downloaded_file",d=e.filename||c,m=o.headers.get("content-type")||"application/octet-stream",y=ml(m);y&&!d.endsWith(y)&&(d=`${d}${y}`);let S={id:s,filename:d,mimetype:m},[v]=await Or(S);return t.json({success:!0,data:[v]})}catch(e){return console.error("Error downloading attachment:",e),t.json({success:!1,error:"Failed to download attachment"},500)}});Le.get("/",async t=>{try{let e=await gn();return t.json({success:!0,data:e})}catch(e){return console.error("Error fetching attachments:",e),t.json({success:!1,error:"Failed to fetch attachments"},500)}});Le.get("/:id",async t=>{try{let e=t.req.param("id"),r=await Rt(e);return r.length===0?t.json({success:!1,error:"Attachment not found"},404):t.json({success:!0,data:r})}catch(e){return console.error("Error fetching attachment:",e),t.json({success:!1,error:"Failed to fetch attachment"},500)}});Le.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if((await Rt(e)).length===0)return t.json({success:!1,error:"Attachment not found"},404);let{id:n,...o}=r,i=await yn(e,o);return t.json({success:!0,data:i})}catch(e){return console.error("Error updating attachment:",e),t.json({success:!1,error:"Failed to update attachment"},500)}});Le.delete("/:id",async t=>{try{let e=t.req.param("id");if((await Rt(e)).length===0)return t.json({success:!1,error:"Attachment not found"},404);let s=await wn(e);return t.json({success:!0,message:"Attachment deleted successfully"})}catch(e){return console.error("Error deleting attachment:",e),t.json({success:!1,error:"Failed to delete attachment"},500)}});var Qi=Le;var Fe=new Q;Fe.route("/folders",_i);Fe.route("/conversations",Bi);Fe.route("/messages",Pi);Fe.route("/message-groups",Li);Fe.route("/message-group-messages",Fi);Fe.route("/attachments",Qi);var Ui=Fe;var xe=new Q;xe.use("*",Xn());xe.use("*",Zn);xe.use("*",Wn());xe.route("/api",Ri);xe.route("/api/llm",Ui);xe.get("/",t=>t.json({success:!0,message:"Chat Backend API is running!",timestamp:new Date().toISOString()}));xe.notFound(t=>t.json({success:!1,error:"Route not found"},404));xe.onError((t,e)=>(console.error("Error:",t),e.json({success:!1,error:"Internal server error"},500)));var Ki=xe;var zi=require("http"),Hi=require("http2"),_r=require("http2"),Sn=require("stream"),Yi=Qt(require("crypto"),1),De=class extends Error{constructor(t,e){super(t,e),this.name="RequestError"}},hl=t=>t instanceof De?t:new De(t.message,{cause:t}),gl=global.Request,Bt=class extends gl{constructor(t,e){typeof t=="object"&&nt in t&&(t=t[nt]()),typeof e?.body?.getReader<"u"&&(e.duplex??="half"),super(t,e)}},Vi=Symbol("wrapBodyStream"),yl=(t,e,r,s)=>{let n=[],o=r.rawHeaders;for(let a=0;a<o.length;a+=2){let{[a]:l,[a+1]:c}=o;l.charCodeAt(0)!==58&&n.push([l,c])}let i={method:t,headers:n,signal:s.signal};if(t==="TRACE"){i.method="GET";let a=new Bt(e,i);return Object.defineProperty(a,"method",{get(){return"TRACE"}}),a}if(!(t==="GET"||t==="HEAD"))if("rawBody"in r&&r.rawBody instanceof Buffer)i.body=new ReadableStream({start(a){a.enqueue(r.rawBody),a.close()}});else if(r[Vi]){let a;i.body=new ReadableStream({async pull(l){try{a||=Sn.Readable.toWeb(r).getReader();let{done:c,value:d}=await a.read();c?l.close():l.enqueue(d)}catch(c){l.error(c)}}})}else i.body=Sn.Readable.toWeb(r);return new Bt(e,i)},nt=Symbol("getRequestCache"),wl=Symbol("requestCache"),En=Symbol("incomingKey"),Br=Symbol("urlKey"),st=Symbol("abortControllerKey"),bl=Symbol("getAbortController"),Pr={get method(){return this[En].method||"GET"},get url(){return this[Br]},[bl](){return this[nt](),this[st]},[nt](){return this[st]||=new AbortController,this[wl]||=yl(this.method,this[Br],this[En],this[st])}};["body","bodyUsed","cache","credentials","destination","headers","integrity","mode","redirect","referrer","referrerPolicy","signal","keepalive"].forEach(t=>{Object.defineProperty(Pr,t,{get(){return this[nt]()[t]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(t=>{Object.defineProperty(Pr,t,{value:function(){return this[nt]()[t]()}})});Object.setPrototypeOf(Pr,Bt.prototype);var vl=(t,e)=>{let r=Object.create(Pr);r[En]=t;let s=t.url||"";if(s[0]!=="/"&&(s.startsWith("http://")||s.startsWith("https://"))){if(t instanceof _r.Http2ServerRequest)throw new De("Absolute URL for :path is not allowed in HTTP/2");try{let a=new URL(s);r[Br]=a.href}catch(a){throw new De("Invalid absolute URL",{cause:a})}return r}let n=(t instanceof _r.Http2ServerRequest?t.authority:t.headers.host)||e;if(!n)throw new De("Missing host header");let o;if(t instanceof _r.Http2ServerRequest){if(o=t.scheme,!(o==="http"||o==="https"))throw new De("Unsupported scheme")}else o=t.socket&&t.socket.encrypted?"https":"http";let i=new URL(`${o}://${n}${s}`);if(i.hostname.length!==n.length&&i.hostname!==n.replace(/:\d+$/,""))throw new De("Invalid host header");return r[Br]=i.href,r},Gi=Symbol("responseCache"),rt=Symbol("getResponseCache"),Qe=Symbol("cache"),Tn=global.Response,Pt=class ki{#t;#e;[rt](){return delete this[Qe],this[Gi]||=new Tn(this.#t,this.#e)}constructor(e,r){let s;if(this.#t=e,r instanceof ki){let n=r[Gi];if(n){this.#e=n,this[rt]();return}else this.#e=r.#e,s=new Headers(r.#e.headers)}else this.#e=r;(typeof e=="string"||typeof e?.getReader<"u"||e instanceof Blob||e instanceof Uint8Array)&&(s||=r?.headers||{"content-type":"text/plain; charset=UTF-8"},this[Qe]=[r?.status||200,e,s])}get headers(){let e=this[Qe];return e?(e[2]instanceof Headers||(e[2]=new Headers(e[2])),e[2]):this[rt]().headers}get status(){return this[Qe]?.[0]??this[rt]().status}get ok(){let e=this.status;return e>=200&&e<300}};["body","bodyUsed","redirected","statusText","trailers","type","url"].forEach(t=>{Object.defineProperty(Pt.prototype,t,{get(){return this[rt]()[t]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(t=>{Object.defineProperty(Pt.prototype,t,{value:function(){return this[rt]()[t]()}})});Object.setPrototypeOf(Pt,Tn);Object.setPrototypeOf(Pt.prototype,Tn.prototype);async function xl(t){return Promise.race([t,Promise.resolve().then(()=>Promise.resolve(void 0))])}function Wi(t,e,r){let s=()=>{};return e.on("error",s),(r??t.read()).then(i,n),t.closed.finally(()=>{e.off("error",s)});function n(a){a&&e.destroy(a)}function o(){t.read().then(i,n)}function i({done:a,value:l}){try{if(a)e.end();else if(!e.write(l))e.once("drain",o);else return t.read().then(i,n)}catch(c){n(c)}}}function Sl(t,e){if(t.locked)throw new TypeError("ReadableStream is locked.");return e.destroyed?void 0:Wi(t.getReader(),e)}var Ji=t=>{let e={};t instanceof Headers||(t=new Headers(t??void 0));let r=[];for(let[s,n]of t)s==="set-cookie"?r.push(n):e[s]=n;return r.length>0&&(e["set-cookie"]=r),e["content-type"]??="text/plain; charset=UTF-8",e},El="x-hono-already-sent",Il=global.fetch;typeof global.crypto>"u"&&(global.crypto=Yi.default);global.fetch=(t,e)=>(e={compress:!1,...e},Il(t,e));var Cn=Symbol("outgoingEnded"),Tl=()=>new Response(null,{status:400}),Xi=t=>new Response(null,{status:t instanceof Error&&(t.name==="TimeoutError"||t.constructor.name==="TimeoutError")?504:500}),In=(t,e)=>{let r=t instanceof Error?t:new Error("unknown error",{cause:t});r.code==="ERR_STREAM_PREMATURE_CLOSE"?console.info("The user aborted a request."):(console.error(t),e.headersSent||e.writeHead(500,{"Content-Type":"text/plain"}),e.end(`Error: ${r.message}`),e.destroy(r))},Zi=t=>{"flushHeaders"in t&&t.writable&&t.flushHeaders()},ea=async(t,e)=>{let[r,s,n]=t[Qe];n instanceof Headers&&(n=Ji(n)),typeof s=="string"?n["Content-Length"]=Buffer.byteLength(s):s instanceof Uint8Array?n["Content-Length"]=s.byteLength:s instanceof Blob&&(n["Content-Length"]=s.size),e.writeHead(r,n),typeof s=="string"||s instanceof Uint8Array?e.end(s):s instanceof Blob?e.end(new Uint8Array(await s.arrayBuffer())):(Zi(e),await Sl(s,e)?.catch(o=>In(o,e))),e[Cn]?.()},Cl=async(t,e,r={})=>{if(t instanceof Promise)if(r.errorHandler)try{t=await t}catch(n){let o=await r.errorHandler(n);if(!o)return;t=o}else t=await t.catch(Xi);if(Qe in t)return ea(t,e);let s=Ji(t.headers);if(t.body){let n=t.body.getReader(),o=[],i=!1,a,l=2;for(let c=0;c<l;c++){a||=n.read();let d=await xl(a).catch(m=>{console.error(m),i=!0});if(!d){if(c===1&&s["transfer-encoding"]!=="chunked"){await new Promise(m=>setTimeout(m)),l=3;continue}break}if(a=void 0,d.value&&o.push(d.value),d.done){i=!0;break}}i&&!("content-length"in s)&&(s["content-length"]=o.reduce((c,d)=>c+d.length,0)),e.writeHead(t.status,s),o.forEach(c=>{e.write(c)}),i?e.end():(o.length===0&&Zi(e),await Wi(n,e,a))}else s[El]||(e.writeHead(t.status,s),e.end());e[Cn]?.()},jl=(t,e={})=>{let r=e.autoCleanupIncoming??!0;return e.overrideGlobalObjects!==!1&&global.Request!==Bt&&(Object.defineProperty(global,"Request",{value:Bt}),Object.defineProperty(global,"Response",{value:Pt})),async(s,n)=>{let o,i;try{i=vl(s,e.hostname);let a=!r||s.method==="GET"||s.method==="HEAD";if(a||(s[Vi]=!0,s.on("end",()=>{a=!0}),s instanceof Hi.Http2ServerRequest&&(n[Cn]=()=>{a||setTimeout(()=>{a||setTimeout(()=>{s.destroy(),n.destroy()})})})),n.on("close",()=>{i[st]&&(s.errored?i[st].abort(s.errored.toString()):n.writableFinished||i[st].abort("Client connection prematurely closed.")),a||setTimeout(()=>{a||setTimeout(()=>{s.destroy()})})}),o=t(i,{incoming:s,outgoing:n}),Qe in o)return ea(o,n)}catch(a){if(o)return In(a,n);if(e.errorHandler){if(o=await e.errorHandler(i?a:hl(a)),!o)return}else i?o=Xi(a):o=Tl()}try{return await Cl(o,n,e)}catch(a){return In(a,n)}}},ql=t=>{let e=t.fetch,r=jl(e,{hostname:t.hostname,overrideGlobalObjects:t.overrideGlobalObjects,autoCleanupIncoming:t.autoCleanupIncoming});return(t.createServer||zi.createServer)(t.serverOptions||{},r)},ta=(t,e)=>{let r=ql(t);return r.listen(t?.port??3e3,t.hostname,()=>{let s=r.address();e&&e(s)}),r};var ra=parseInt(process.env.PORT||"5007");console.log(`Server is running on port ${ra}`);ta({fetch:Ki.fetch,port:ra});
