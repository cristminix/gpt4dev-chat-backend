"use strict";var ca=Object.create;var Ur=Object.defineProperty;var ua=Object.getOwnPropertyDescriptor;var da=Object.getOwnPropertyNames;var fa=Object.getPrototypeOf,pa=Object.prototype.hasOwnProperty;var W=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ma=(t,e)=>{for(var r in e)Ur(t,r,{get:e[r],enumerable:!0})},ha=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of da(e))!pa.call(t,n)&&n!==r&&Ur(t,n,{get:()=>e[n],enumerable:!(s=ua(e,n))||s.enumerable});return t};var Ut=(t,e,r)=>(r=t!=null?ca(fa(t)):{},ha(e||!t||!t.__esModule?Ur(r,"default",{value:t,enumerable:!0}):r,t));var me=W(Ir=>{"use strict";Ir.getBooleanOption=(t,e)=>{let r=!1;if(e in t&&typeof(r=t[e])!="boolean")throw new TypeError(`Expected the "${e}" option to be a boolean`);return r};Ir.cppdb=Symbol();Ir.inspect=Symbol.for("nodejs.util.inspect.custom")});var Hs=W((Gp,Zo)=>{"use strict";var ks={value:"SqliteError",writable:!0,enumerable:!1,configurable:!0};function Ae(t,e){if(new.target!==Ae)return new Ae(t,e);if(typeof e!="string")throw new TypeError("Expected second argument to be a string");Error.call(this,t),ks.value=""+t,Object.defineProperty(this,"message",ks),Error.captureStackTrace(this,Ae),this.code=e}Object.setPrototypeOf(Ae,Error);Object.setPrototypeOf(Ae.prototype,Error.prototype);Object.defineProperty(Ae.prototype,"name",ks);Zo.exports=Ae});var ti=W((zp,ei)=>{var Tr=require("path").sep||"/";ei.exports=Ka;function Ka(t){if(typeof t!="string"||t.length<=7||t.substring(0,7)!="file://")throw new TypeError("must pass in a file:// URI to convert to a file path");var e=decodeURI(t.substring(7)),r=e.indexOf("/"),s=e.substring(0,r),n=e.substring(r+1);return s=="localhost"&&(s=""),s&&(s=Tr+Tr+s),n=n.replace(/^(.+)\|/,"$1:"),Tr=="\\"&&(n=n.replace(/\//g,"\\")),/^.+\:/.test(n)||(n=Tr+n),s+n}});var oi=W((Ye,ni)=>{var Vs=require("fs"),jr=require("path"),Ga=ti(),Cr=jr.join,za=jr.dirname,ri=Vs.accessSync&&function(t){try{Vs.accessSync(t)}catch{return!1}return!0}||Vs.existsSync||jr.existsSync,si={arrow:process.env.NODE_BINDINGS_ARROW||" \u2192 ",compiled:process.env.NODE_BINDINGS_COMPILED_DIR||"compiled",platform:process.platform,arch:process.arch,nodePreGyp:"node-v"+process.versions.modules+"-"+process.platform+"-"+process.arch,version:process.versions.node,bindings:"bindings.node",try:[["module_root","build","bindings"],["module_root","build","Debug","bindings"],["module_root","build","Release","bindings"],["module_root","out","Debug","bindings"],["module_root","Debug","bindings"],["module_root","out","Release","bindings"],["module_root","Release","bindings"],["module_root","build","default","bindings"],["module_root","compiled","version","platform","arch","bindings"],["module_root","addon-build","release","install-root","bindings"],["module_root","addon-build","debug","install-root","bindings"],["module_root","addon-build","default","install-root","bindings"],["module_root","lib","binding","nodePreGyp","bindings"]]};function ka(t){typeof t=="string"?t={bindings:t}:t||(t={}),Object.keys(si).map(function(l){l in t||(t[l]=si[l])}),t.module_root||(t.module_root=Ye.getRoot(Ye.getFileName())),jr.extname(t.bindings)!=".node"&&(t.bindings+=".node");for(var e=typeof __webpack_require__=="function"?__non_webpack_require__:require,r=[],s=0,n=t.try.length,o,i,a;s<n;s++){o=Cr.apply(null,t.try[s].map(function(l){return t[l]||l})),r.push(o);try{return i=t.path?e.resolve(o):e(o),t.path||(i.path=o),i}catch(l){if(l.code!=="MODULE_NOT_FOUND"&&l.code!=="QUALIFIED_PATH_RESOLUTION_FAILED"&&!/not find/i.test(l.message))throw l}}throw a=new Error(`Could not locate the bindings file. Tried:
`+r.map(function(l){return t.arrow+l}).join(`
`)),a.tries=r,a}ni.exports=Ye=ka;Ye.getFileName=function(e){var r=Error.prepareStackTrace,s=Error.stackTraceLimit,n={},o;Error.stackTraceLimit=10,Error.prepareStackTrace=function(a,l){for(var c=0,d=l.length;c<d;c++)if(o=l[c].getFileName(),o!==__filename)if(e){if(o!==e)return}else return},Error.captureStackTrace(n),n.stack,Error.prepareStackTrace=r,Error.stackTraceLimit=s;var i="file://";return o.indexOf(i)===0&&(o=Ga(o)),o};Ye.getRoot=function(e){for(var r=za(e),s;;){if(r==="."&&(r=process.cwd()),ri(Cr(r,"package.json"))||ri(Cr(r,"node_modules")))return r;if(s===r)throw new Error('Could not find module root given file: "'+e+'". Do you have a `package.json` file? ');s=r,r=Cr(r,"..")}}});var ii=W(Ie=>{"use strict";var{cppdb:ue}=me();Ie.prepare=function(e){return this[ue].prepare(e,this,!1)};Ie.exec=function(e){return this[ue].exec(e),this};Ie.close=function(){return this[ue].close(),this};Ie.loadExtension=function(...e){return this[ue].loadExtension(...e),this};Ie.defaultSafeIntegers=function(...e){return this[ue].defaultSafeIntegers(...e),this};Ie.unsafeMode=function(...e){return this[ue].unsafeMode(...e),this};Ie.getters={name:{get:function(){return this[ue].name},enumerable:!0},open:{get:function(){return this[ue].open},enumerable:!0},inTransaction:{get:function(){return this[ue].inTransaction},enumerable:!0},readonly:{get:function(){return this[ue].readonly},enumerable:!0},memory:{get:function(){return this[ue].memory},enumerable:!0}}});var ci=W((Hp,li)=>{"use strict";var{cppdb:Ha}=me(),ai=new WeakMap;li.exports=function(e){if(typeof e!="function")throw new TypeError("Expected first argument to be a function");let r=this[Ha],s=Va(r,this),{apply:n}=Function.prototype,o={default:{value:qr(n,e,r,s.default)},deferred:{value:qr(n,e,r,s.deferred)},immediate:{value:qr(n,e,r,s.immediate)},exclusive:{value:qr(n,e,r,s.exclusive)},database:{value:this,enumerable:!0}};return Object.defineProperties(o.default.value,o),Object.defineProperties(o.deferred.value,o),Object.defineProperties(o.immediate.value,o),Object.defineProperties(o.exclusive.value,o),o.default.value};var Va=(t,e)=>{let r=ai.get(t);if(!r){let s={commit:t.prepare("COMMIT",e,!1),rollback:t.prepare("ROLLBACK",e,!1),savepoint:t.prepare("SAVEPOINT `	_bs3.	`",e,!1),release:t.prepare("RELEASE `	_bs3.	`",e,!1),rollbackTo:t.prepare("ROLLBACK TO `	_bs3.	`",e,!1)};ai.set(t,r={default:Object.assign({begin:t.prepare("BEGIN",e,!1)},s),deferred:Object.assign({begin:t.prepare("BEGIN DEFERRED",e,!1)},s),immediate:Object.assign({begin:t.prepare("BEGIN IMMEDIATE",e,!1)},s),exclusive:Object.assign({begin:t.prepare("BEGIN EXCLUSIVE",e,!1)},s)})}return r},qr=(t,e,r,{begin:s,commit:n,rollback:o,savepoint:i,release:a,rollbackTo:l})=>function(){let d,m,y;r.inTransaction?(d=i,m=a,y=l):(d=s,m=n,y=o),d.run();try{let S=t.call(e,this,arguments);if(S&&typeof S.then=="function")throw new TypeError("Transaction function cannot return a promise");return m.run(),S}catch(S){throw r.inTransaction&&(y.run(),y!==o&&m.run()),S}}});var di=W((Vp,ui)=>{"use strict";var{getBooleanOption:Wa,cppdb:Ja}=me();ui.exports=function(e,r){if(r==null&&(r={}),typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof r!="object")throw new TypeError("Expected second argument to be an options object");let s=Wa(r,"simple"),n=this[Ja].prepare(`PRAGMA ${e}`,this,!0);return s?n.pluck().get():n.all()}});var mi=W((Wp,pi)=>{"use strict";var Ya=require("fs"),Xa=require("path"),{promisify:Za}=require("util"),{cppdb:el}=me(),fi=Za(Ya.access);pi.exports=async function(e,r){if(r==null&&(r={}),typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof r!="object")throw new TypeError("Expected second argument to be an options object");e=e.trim();let s="attached"in r?r.attached:"main",n="progress"in r?r.progress:null;if(!e)throw new TypeError("Backup filename cannot be an empty string");if(e===":memory:")throw new TypeError('Invalid backup filename ":memory:"');if(typeof s!="string")throw new TypeError('Expected the "attached" option to be a string');if(!s)throw new TypeError('The "attached" option cannot be an empty string');if(n!=null&&typeof n!="function")throw new TypeError('Expected the "progress" option to be a function');await fi(Xa.dirname(e)).catch(()=>{throw new TypeError("Cannot save backup because the directory does not exist")});let o=await fi(e).then(()=>!1,()=>!0);return tl(this[el].backup(this,s,e,o),n||null)};var tl=(t,e)=>{let r=0,s=!0;return new Promise((n,o)=>{setImmediate(function i(){try{let a=t.transfer(r);if(!a.remainingPages){t.close(),n(a);return}if(s&&(s=!1,r=100),e){let l=e(a);if(l!==void 0)if(typeof l=="number"&&l===l)r=Math.max(0,Math.min(2147483647,Math.round(l)));else throw new TypeError("Expected progress callback to return a number or undefined")}setImmediate(i)}catch(a){t.close(),o(a)}})})}});var gi=W((Jp,hi)=>{"use strict";var{cppdb:rl}=me();hi.exports=function(e){if(e==null&&(e={}),typeof e!="object")throw new TypeError("Expected first argument to be an options object");let r="attached"in e?e.attached:"main";if(typeof r!="string")throw new TypeError('Expected the "attached" option to be a string');if(!r)throw new TypeError('The "attached" option cannot be an empty string');return this[rl].serialize(r)}});var wi=W((Yp,yi)=>{"use strict";var{getBooleanOption:Nr,cppdb:sl}=me();yi.exports=function(e,r,s){if(r==null&&(r={}),typeof r=="function"&&(s=r,r={}),typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof s!="function")throw new TypeError("Expected last argument to be a function");if(typeof r!="object")throw new TypeError("Expected second argument to be an options object");if(!e)throw new TypeError("User-defined function name cannot be an empty string");let n="safeIntegers"in r?+Nr(r,"safeIntegers"):2,o=Nr(r,"deterministic"),i=Nr(r,"directOnly"),a=Nr(r,"varargs"),l=-1;if(!a){if(l=s.length,!Number.isInteger(l)||l<0)throw new TypeError("Expected function.length to be a positive integer");if(l>100)throw new RangeError("User-defined functions cannot have more than 100 arguments")}return this[sl].function(s,e,l,n,o,i),this}});var xi=W((Xp,vi)=>{"use strict";var{getBooleanOption:$r,cppdb:nl}=me();vi.exports=function(e,r){if(typeof e!="string")throw new TypeError("Expected first argument to be a string");if(typeof r!="object"||r===null)throw new TypeError("Expected second argument to be an options object");if(!e)throw new TypeError("User-defined function name cannot be an empty string");let s="start"in r?r.start:null,n=Ws(r,"step",!0),o=Ws(r,"inverse",!1),i=Ws(r,"result",!1),a="safeIntegers"in r?+$r(r,"safeIntegers"):2,l=$r(r,"deterministic"),c=$r(r,"directOnly"),d=$r(r,"varargs"),m=-1;if(!d&&(m=Math.max(bi(n),o?bi(o):0),m>0&&(m-=1),m>100))throw new RangeError("User-defined functions cannot have more than 100 arguments");return this[nl].aggregate(s,n,o,i,e,m,a,l,c),this};var Ws=(t,e,r)=>{let s=e in t?t[e]:null;if(typeof s=="function")return s;if(s!=null)throw new TypeError(`Expected the "${e}" option to be a function`);if(r)throw new TypeError(`Missing required option "${e}"`);return null},bi=({length:t})=>{if(Number.isInteger(t)&&t>=0)return t;throw new TypeError("Expected function.length to be a positive integer")}});var Ti=W((Zp,Ii)=>{"use strict";var{cppdb:ol}=me();Ii.exports=function(e,r){if(typeof e!="string")throw new TypeError("Expected first argument to be a string");if(!e)throw new TypeError("Virtual table module name cannot be an empty string");let s=!1;if(typeof r=="object"&&r!==null)s=!0,r=pl(Ei(r,"used",e));else{if(typeof r!="function")throw new TypeError("Expected second argument to be a function or a table definition object");r=il(r)}return this[ol].table(r,e,s),this};function il(t){return function(r,s,n,...o){let i={module:r,database:s,table:n},a=dl.call(t,i,o);if(typeof a!="object"||a===null)throw new TypeError(`Virtual table module "${r}" did not return a table definition object`);return Ei(a,"returned",r)}}function Ei(t,e,r){if(!Et.call(t,"rows"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition without a "rows" property`);if(!Et.call(t,"columns"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition without a "columns" property`);let s=t.rows;if(typeof s!="function"||Object.getPrototypeOf(s)!==fl)throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "rows" property (should be a generator function)`);let n=t.columns;if(!Array.isArray(n)||!(n=[...n]).every(c=>typeof c=="string"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "columns" property (should be an array of strings)`);if(n.length!==new Set(n).size)throw new TypeError(`Virtual table module "${r}" ${e} a table definition with duplicate column names`);if(!n.length)throw new RangeError(`Virtual table module "${r}" ${e} a table definition with zero columns`);let o;if(Et.call(t,"parameters")){if(o=t.parameters,!Array.isArray(o)||!(o=[...o]).every(c=>typeof c=="string"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "parameters" property (should be an array of strings)`)}else o=ul(s);if(o.length!==new Set(o).size)throw new TypeError(`Virtual table module "${r}" ${e} a table definition with duplicate parameter names`);if(o.length>32)throw new RangeError(`Virtual table module "${r}" ${e} a table definition with more than the maximum number of 32 parameters`);for(let c of o)if(n.includes(c))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with column "${c}" which was ambiguously defined as both a column and parameter`);let i=2;if(Et.call(t,"safeIntegers")){let c=t.safeIntegers;if(typeof c!="boolean")throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "safeIntegers" property (should be a boolean)`);i=+c}let a=!1;if(Et.call(t,"directOnly")&&(a=t.directOnly,typeof a!="boolean"))throw new TypeError(`Virtual table module "${r}" ${e} a table definition with an invalid "directOnly" property (should be a boolean)`);return[`CREATE TABLE x(${[...o.map(Si).map(c=>`${c} HIDDEN`),...n.map(Si)].join(", ")});`,al(s,new Map(n.map((c,d)=>[c,o.length+d])),r),o,i,a]}function al(t,e,r){return function*(...n){let o=n.map(i=>Buffer.isBuffer(i)?Buffer.from(i):i);for(let i=0;i<e.size;++i)o.push(null);for(let i of t(...n))if(Array.isArray(i))ll(i,o,e.size,r),yield o;else if(typeof i=="object"&&i!==null)cl(i,o,e,r),yield o;else throw new TypeError(`Virtual table module "${r}" yielded something that isn't a valid row object`)}}function ll(t,e,r,s){if(t.length!==r)throw new TypeError(`Virtual table module "${s}" yielded a row with an incorrect number of columns`);let n=e.length-r;for(let o=0;o<r;++o)e[o+n]=t[o]}function cl(t,e,r,s){let n=0;for(let o of Object.keys(t)){let i=r.get(o);if(i===void 0)throw new TypeError(`Virtual table module "${s}" yielded a row with an undeclared column "${o}"`);e[i]=t[o],n+=1}if(n!==r.size)throw new TypeError(`Virtual table module "${s}" yielded a row with missing columns`)}function ul({length:t}){if(!Number.isInteger(t)||t<0)throw new TypeError("Expected function.length to be a positive integer");let e=[];for(let r=0;r<t;++r)e.push(`$${r+1}`);return e}var{hasOwnProperty:Et}=Object.prototype,{apply:dl}=Function.prototype,fl=Object.getPrototypeOf(function*(){}),Si=t=>`"${t.replace(/"/g,'""')}"`,pl=t=>()=>t});var ji=W((em,Ci)=>{"use strict";var ml=function(){};Ci.exports=function(e,r){return Object.assign(new ml,this)}});var Mi=W((tm,$i)=>{"use strict";var hl=require("fs"),qi=require("path"),Mr=me(),gl=Hs(),Ni;function k(t,e){if(new.target==null)return new k(t,e);let r;if(Buffer.isBuffer(t)&&(r=t,t=":memory:"),t==null&&(t=""),e==null&&(e={}),typeof t!="string")throw new TypeError("Expected first argument to be a string");if(typeof e!="object")throw new TypeError("Expected second argument to be an options object");if("readOnly"in e)throw new TypeError('Misspelled option "readOnly" should be "readonly"');if("memory"in e)throw new TypeError('Option "memory" was removed in v7.0.0 (use ":memory:" filename instead)');let s=t.trim(),n=s===""||s===":memory:",o=Mr.getBooleanOption(e,"readonly"),i=Mr.getBooleanOption(e,"fileMustExist"),a="timeout"in e?e.timeout:5e3,l="verbose"in e?e.verbose:null,c="nativeBinding"in e?e.nativeBinding:null;if(o&&n&&!r)throw new TypeError("In-memory/temporary databases cannot be readonly");if(!Number.isInteger(a)||a<0)throw new TypeError('Expected the "timeout" option to be a positive integer');if(a>2147483647)throw new RangeError('Option "timeout" cannot be greater than 2147483647');if(l!=null&&typeof l!="function")throw new TypeError('Expected the "verbose" option to be a function');if(c!=null&&typeof c!="string"&&typeof c!="object")throw new TypeError('Expected the "nativeBinding" option to be a string or addon object');let d;if(c==null?d=Ni||(Ni=oi()("better_sqlite3.node")):typeof c=="string"?d=(typeof __non_webpack_require__=="function"?__non_webpack_require__:require)(qi.resolve(c).replace(/(\.node)?$/,".node")):d=c,d.isInitialized||(d.setErrorConstructor(gl),d.isInitialized=!0),!n&&!hl.existsSync(qi.dirname(s)))throw new TypeError("Cannot open database because the directory does not exist");Object.defineProperties(this,{[Mr.cppdb]:{value:new d.Database(s,t,n,o,i,a,l||null,r||null)},...Oe.getters})}var Oe=ii();k.prototype.prepare=Oe.prepare;k.prototype.transaction=ci();k.prototype.pragma=di();k.prototype.backup=mi();k.prototype.serialize=gi();k.prototype.function=wi();k.prototype.aggregate=xi();k.prototype.table=Ti();k.prototype.loadExtension=Oe.loadExtension;k.prototype.exec=Oe.exec;k.prototype.close=Oe.close;k.prototype.defaultSafeIntegers=Oe.defaultSafeIntegers;k.prototype.unsafeMode=Oe.unsafeMode;k.prototype[Mr.inspect]=ji();$i.exports=k});var Ai=W((rm,Js)=>{"use strict";Js.exports=Mi();Js.exports.SqliteError=Hs()});var Kr=(t,e,r)=>(s,n)=>{let o=-1;return i(0);async function i(a){if(a<=o)throw new Error("next() called multiple times");o=a;let l,c=!1,d;if(t[a]?(d=t[a][0][0],s.req.routeIndex=a):d=a===t.length&&n||void 0,d)try{l=await d(s,()=>i(a+1))}catch(m){if(m instanceof Error&&e)s.error=m,l=await e(m,s),c=!0;else throw m}else s.finalized===!1&&r&&(l=await r(s));return l&&(s.finalized===!1||c)&&(s.res=l),s}};var Rn=Symbol();var _n=async(t,e=Object.create(null))=>{let{all:r=!1,dot:s=!1}=e,o=(t instanceof Kt?t.raw.headers:t.headers).get("Content-Type");return o?.startsWith("multipart/form-data")||o?.startsWith("application/x-www-form-urlencoded")?ga(t,{all:r,dot:s}):{}};async function ga(t,e){let r=await t.formData();return r?ya(r,e):{}}function ya(t,e){let r=Object.create(null);return t.forEach((s,n)=>{e.all||n.endsWith("[]")?wa(r,n,s):r[n]=s}),e.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(ba(r,s,n),delete r[s])}),r}var wa=(t,e,r)=>{t[e]!==void 0?Array.isArray(t[e])?t[e].push(r):t[e]=[t[e],r]:e.endsWith("[]")?t[e]=[r]:t[e]=r},ba=(t,e,r)=>{let s=t,n=e.split(".");n.forEach((o,i)=>{i===n.length-1?s[o]=r:((!s[o]||typeof s[o]!="object"||Array.isArray(s[o])||s[o]instanceof File)&&(s[o]=Object.create(null)),s=s[o])})};var zr=t=>{let e=t.split("/");return e[0]===""&&e.shift(),e},Bn=t=>{let{groups:e,path:r}=va(t),s=zr(r);return xa(s,e)},va=t=>{let e=[];return t=t.replace(/\{[^}]+\}/g,(r,s)=>{let n=`@${s}`;return e.push([n,r]),n}),{groups:e,path:t}},xa=(t,e)=>{for(let r=e.length-1;r>=0;r--){let[s]=e[r];for(let n=t.length-1;n>=0;n--)if(t[n].includes(s)){t[n]=t[n].replace(s,e[r][1]);break}}return t},Gt={},Pn=(t,e)=>{if(t==="*")return"*";let r=t.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){let s=`${t}#${e}`;return Gt[s]||(r[2]?Gt[s]=e&&e[0]!==":"&&e[0]!=="*"?[s,r[1],new RegExp(`^${r[2]}(?=/${e})`)]:[t,r[1],new RegExp(`^${r[2]}$`)]:Gt[s]=[t,r[1],!0]),Gt[s]}return null},zt=(t,e)=>{try{return e(t)}catch{return t.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return e(r)}catch{return r}})}},Sa=t=>zt(t,decodeURI),kr=t=>{let e=t.url,r=e.indexOf("/",e.charCodeAt(9)===58?13:8),s=r;for(;s<e.length;s++){let n=e.charCodeAt(s);if(n===37){let o=e.indexOf("?",s),i=e.slice(r,o===-1?void 0:o);return Sa(i.includes("%25")?i.replace(/%25/g,"%2525"):i)}else if(n===63)break}return e.slice(r,s)};var Ln=t=>{let e=kr(t);return e.length>1&&e.at(-1)==="/"?e.slice(0,-1):e},Te=(t,e,...r)=>(r.length&&(e=Te(e,...r)),`${t?.[0]==="/"?"":"/"}${t}${e==="/"?"":`${t?.at(-1)==="/"?"":"/"}${e?.[0]==="/"?e.slice(1):e}`}`),kt=t=>{if(t.charCodeAt(t.length-1)!==63||!t.includes(":"))return null;let e=t.split("/"),r=[],s="";return e.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);let o=n.replace("?","");s+="/"+o,r.push(s)}else s+="/"+n}),r.filter((n,o,i)=>i.indexOf(n)===o)},Gr=t=>/[%+]/.test(t)?(t.indexOf("+")!==-1&&(t=t.replace(/\+/g," ")),t.indexOf("%")!==-1?zt(t,Hr):t):t,Dn=(t,e,r)=>{let s;if(!r&&e&&!/[%+]/.test(e)){let i=t.indexOf(`?${e}`,8);for(i===-1&&(i=t.indexOf(`&${e}`,8));i!==-1;){let a=t.charCodeAt(i+e.length+1);if(a===61){let l=i+e.length+2,c=t.indexOf("&",l);return Gr(t.slice(l,c===-1?void 0:c))}else if(a==38||isNaN(a))return"";i=t.indexOf(`&${e}`,i+1)}if(s=/[%+]/.test(t),!s)return}let n={};s??=/[%+]/.test(t);let o=t.indexOf("?",8);for(;o!==-1;){let i=t.indexOf("&",o+1),a=t.indexOf("=",o);a>i&&i!==-1&&(a=-1);let l=t.slice(o+1,a===-1?i===-1?void 0:i:a);if(s&&(l=Gr(l)),o=i,l==="")continue;let c;a===-1?c="":(c=t.slice(a+1,i===-1?void 0:i),s&&(c=Gr(c))),r?(n[l]&&Array.isArray(n[l])||(n[l]=[]),n[l].push(c)):n[l]??=c}return e?n[e]:n},Fn=Dn,Qn=(t,e)=>Dn(t,e,!0),Hr=decodeURIComponent;var Un=t=>zt(t,Hr),Kt=class{raw;#t;#e;routeIndex=0;path;bodyCache={};constructor(t,e="/",r=[[]]){this.raw=t,this.path=e,this.#e=r,this.#t={}}param(t){return t?this.#r(t):this.#o()}#r(t){let e=this.#e[0][this.routeIndex][1][t],r=this.#n(e);return r?/\%/.test(r)?Un(r):r:void 0}#o(){let t={},e=Object.keys(this.#e[0][this.routeIndex][1]);for(let r of e){let s=this.#n(this.#e[0][this.routeIndex][1][r]);s&&typeof s=="string"&&(t[r]=/\%/.test(s)?Un(s):s)}return t}#n(t){return this.#e[1]?this.#e[1][t]:t}query(t){return Fn(this.url,t)}queries(t){return Qn(this.url,t)}header(t){if(t)return this.raw.headers.get(t)??void 0;let e={};return this.raw.headers.forEach((r,s)=>{e[s]=r}),e}async parseBody(t){return this.bodyCache.parsedBody??=await _n(this,t)}#s=t=>{let{bodyCache:e,raw:r}=this,s=e[t];if(s)return s;let n=Object.keys(e)[0];return n?e[n].then(o=>(n==="json"&&(o=JSON.stringify(o)),new Response(o)[t]())):e[t]=r[t]()};json(){return this.#s("text").then(t=>JSON.parse(t))}text(){return this.#s("text")}arrayBuffer(){return this.#s("arrayBuffer")}blob(){return this.#s("blob")}formData(){return this.#s("formData")}addValidatedData(t,e){this.#t[t]=e}valid(t){return this.#t[t]}get url(){return this.raw.url}get method(){return this.raw.method}get[Rn](){return this.#e}get matchedRoutes(){return this.#e[0].map(([[,t]])=>t)}get routePath(){return this.#e[0].map(([[,t]])=>t)[this.routeIndex].path}};var Ht={Stringify:1,BeforeStream:2,Stream:3},Ea=(t,e)=>{let r=new String(t);return r.isEscaped=!0,r.callbacks=e,r};var it=async(t,e,r,s,n)=>{typeof t=="object"&&!(t instanceof String)&&(t instanceof Promise||(t=t.toString()),t instanceof Promise&&(t=await t));let o=t.callbacks;if(!o?.length)return Promise.resolve(t);n?n[0]+=t:n=[t];let i=Promise.all(o.map(a=>a({phase:e,buffer:n,context:s}))).then(a=>Promise.all(a.filter(Boolean).map(l=>it(l,e,!1,s,n))).then(()=>n[0]));return r?Ea(await i,o):i};var Kn="text/plain; charset=UTF-8",Vr=(t,e)=>({"Content-Type":t,...e}),Gn=class{#t;#e;env={};#r;finalized=!1;error;#o;#n;#s;#u;#l;#c;#a;#d;#f;constructor(t,e){this.#t=t,e&&(this.#n=e.executionCtx,this.env=e.env,this.#c=e.notFoundHandler,this.#f=e.path,this.#d=e.matchResult)}get req(){return this.#e??=new Kt(this.#t,this.#f,this.#d),this.#e}get event(){if(this.#n&&"respondWith"in this.#n)return this.#n;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#n)return this.#n;throw Error("This context has no ExecutionContext")}get res(){return this.#s||=new Response(null,{headers:this.#a??=new Headers})}set res(t){if(this.#s&&t){t=new Response(t.body,t);for(let[e,r]of this.#s.headers.entries())if(e!=="content-type")if(e==="set-cookie"){let s=this.#s.headers.getSetCookie();t.headers.delete("set-cookie");for(let n of s)t.headers.append("set-cookie",n)}else t.headers.set(e,r)}this.#s=t,this.finalized=!0}render=(...t)=>(this.#l??=e=>this.html(e),this.#l(...t));setLayout=t=>this.#u=t;getLayout=()=>this.#u;setRenderer=t=>{this.#l=t};header=(t,e,r)=>{this.finalized&&(this.#s=new Response(this.#s.body,this.#s));let s=this.#s?this.#s.headers:this.#a??=new Headers;e===void 0?s.delete(t):r?.append?s.append(t,e):s.set(t,e)};status=t=>{this.#o=t};set=(t,e)=>{this.#r??=new Map,this.#r.set(t,e)};get=t=>this.#r?this.#r.get(t):void 0;get var(){return this.#r?Object.fromEntries(this.#r):{}}#i(t,e,r){let s=this.#s?new Headers(this.#s.headers):this.#a??new Headers;if(typeof e=="object"&&"headers"in e){let o=e.headers instanceof Headers?e.headers:new Headers(e.headers);for(let[i,a]of o)i.toLowerCase()==="set-cookie"?s.append(i,a):s.set(i,a)}if(r)for(let[o,i]of Object.entries(r))if(typeof i=="string")s.set(o,i);else{s.delete(o);for(let a of i)s.append(o,a)}let n=typeof e=="number"?e:e?.status??this.#o;return new Response(t,{status:n,headers:s})}newResponse=(...t)=>this.#i(...t);body=(t,e,r)=>this.#i(t,e,r);text=(t,e,r)=>!this.#a&&!this.#o&&!e&&!r&&!this.finalized?new Response(t):this.#i(t,e,Vr(Kn,r));json=(t,e,r)=>this.#i(JSON.stringify(t),e,Vr("application/json",r));html=(t,e,r)=>{let s=n=>this.#i(n,e,Vr("text/html; charset=UTF-8",r));return typeof t=="object"?it(t,Ht.Stringify,!1,{}).then(s):s(t)};redirect=(t,e)=>{let r=String(t);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,e??302)};notFound=()=>(this.#c??=()=>new Response,this.#c(this))};var B="ALL",zn="all",kn=["get","post","put","delete","options","patch"],Vt="Can not add a route since the matcher is already built.",Wt=class extends Error{};var Hn="__COMPOSED_HANDLER";var Ia=t=>t.text("404 Not Found",404),Vn=(t,e)=>{if("getResponse"in t){let r=t.getResponse();return e.newResponse(r.body,r)}return console.error(t),e.text("Internal Server Error",500)},Wr=class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#t="/";routes=[];constructor(t={}){[...kn,zn].forEach(n=>{this[n]=(o,...i)=>(typeof o=="string"?this.#t=o:this.#o(n,this.#t,o),i.forEach(a=>{this.#o(n,this.#t,a)}),this)}),this.on=(n,o,...i)=>{for(let a of[o].flat()){this.#t=a;for(let l of[n].flat())i.map(c=>{this.#o(l.toUpperCase(),this.#t,c)})}return this},this.use=(n,...o)=>(typeof n=="string"?this.#t=n:(this.#t="*",o.unshift(n)),o.forEach(i=>{this.#o(B,this.#t,i)}),this);let{strict:r,...s}=t;Object.assign(this,s),this.getPath=r??!0?t.getPath??kr:Ln}#e(){let t=new Wr({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,t.#r=this.#r,t.routes=this.routes,t}#r=Ia;errorHandler=Vn;route(t,e){let r=this.basePath(t);return e.routes.map(s=>{let n;e.errorHandler===Vn?n=s.handler:(n=async(o,i)=>(await Kr([],e.errorHandler)(o,()=>s.handler(o,i))).res,n[Hn]=s.handler),r.#o(s.method,s.path,n)}),this}basePath(t){let e=this.#e();return e._basePath=Te(this._basePath,t),e}onError=t=>(this.errorHandler=t,this);notFound=t=>(this.#r=t,this);mount(t,e,r){let s,n;r&&(typeof r=="function"?n=r:(n=r.optionHandler,r.replaceRequest===!1?s=a=>a:s=r.replaceRequest));let o=n?a=>{let l=n(a);return Array.isArray(l)?l:[l]}:a=>{let l;try{l=a.executionCtx}catch{}return[a.env,l]};s||=(()=>{let a=Te(this._basePath,t),l=a==="/"?0:a.length;return c=>{let d=new URL(c.url);return d.pathname=d.pathname.slice(l)||"/",new Request(d,c)}})();let i=async(a,l)=>{let c=await e(s(a.req.raw),...o(a));if(c)return c;await l()};return this.#o(B,Te(t,"*"),i),this}#o(t,e,r){t=t.toUpperCase(),e=Te(this._basePath,e);let s={basePath:this._basePath,path:e,method:t,handler:r};this.router.add(t,e,[r,s]),this.routes.push(s)}#n(t,e){if(t instanceof Error)return this.errorHandler(t,e);throw t}#s(t,e,r,s){if(s==="HEAD")return(async()=>new Response(null,await this.#s(t,e,r,"GET")))();let n=this.getPath(t,{env:r}),o=this.router.match(s,n),i=new Gn(t,{path:n,matchResult:o,env:r,executionCtx:e,notFoundHandler:this.#r});if(o[0].length===1){let l;try{l=o[0][0][0][0](i,async()=>{i.res=await this.#r(i)})}catch(c){return this.#n(c,i)}return l instanceof Promise?l.then(c=>c||(i.finalized?i.res:this.#r(i))).catch(c=>this.#n(c,i)):l??this.#r(i)}let a=Kr(o[0],this.errorHandler,this.#r);return(async()=>{try{let l=await a(i);if(!l.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return l.res}catch(l){return this.#n(l,i)}})()}fetch=(t,...e)=>this.#s(t,e[1],e[0],t.method);request=(t,e,r,s)=>t instanceof Request?this.fetch(e?new Request(t,e):t,r,s):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${Te("/",t)}`,e),r,s));fire=()=>{addEventListener("fetch",t=>{t.respondWith(this.#s(t.request,t,void 0,t.request.method))})}};var Jt="[^/]+",at=".*",lt="(?:|/.*)",Ce=Symbol(),Ta=new Set(".\\+*[^]$()");function Ca(t,e){return t.length===1?e.length===1?t<e?-1:1:-1:e.length===1||t===at||t===lt?1:e===at||e===lt?-1:t===Jt?1:e===Jt?-1:t.length===e.length?t<e?-1:1:e.length-t.length}var Yt=class{#t;#e;#r=Object.create(null);insert(t,e,r,s,n){if(t.length===0){if(this.#t!==void 0)throw Ce;if(n)return;this.#t=e;return}let[o,...i]=t,a=o==="*"?i.length===0?["","",at]:["","",Jt]:o==="/*"?["","",lt]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),l;if(a){let c=a[1],d=a[2]||Jt;if(c&&a[2]&&(d===".*"||(d=d.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(d))))throw Ce;if(l=this.#r[d],!l){if(Object.keys(this.#r).some(m=>m!==at&&m!==lt))throw Ce;if(n)return;l=this.#r[d]=new Yt,c!==""&&(l.#e=s.varIndex++)}!n&&c!==""&&r.push([c,l.#e])}else if(l=this.#r[o],!l){if(Object.keys(this.#r).some(c=>c.length>1&&c!==at&&c!==lt))throw Ce;if(n)return;l=this.#r[o]=new Yt}l.insert(i,e,r,s,n)}buildRegExpStr(){let e=Object.keys(this.#r).sort(Ca).map(r=>{let s=this.#r[r];return(typeof s.#e=="number"?`(${r})@${s.#e}`:Ta.has(r)?`\\${r}`:r)+s.buildRegExpStr()});return typeof this.#t=="number"&&e.unshift(`#${this.#t}`),e.length===0?"":e.length===1?e[0]:"(?:"+e.join("|")+")"}};var Wn=class{#t={varIndex:0};#e=new Yt;insert(t,e,r){let s=[],n=[];for(let i=0;;){let a=!1;if(t=t.replace(/\{[^}]+\}/g,l=>{let c=`@\\${i}`;return n[i]=[c,l],i++,a=!0,c}),!a)break}let o=t.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=n.length-1;i>=0;i--){let[a]=n[i];for(let l=o.length-1;l>=0;l--)if(o[l].indexOf(a)!==-1){o[l]=o[l].replace(a,n[i][1]);break}}return this.#e.insert(o,e,s,this.#t,r),s}buildRegExp(){let t=this.#e.buildRegExpStr();if(t==="")return[/^$/,[],[]];let e=0,r=[],s=[];return t=t.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,o,i)=>o!==void 0?(r[++e]=Number(o),"$()"):(i!==void 0&&(s[Number(i)]=++e),"")),[new RegExp(`^${t}`),r,s]}};var Jn=[],ja=[/^$/,[],Object.create(null)],Yn=Object.create(null);function Xn(t){return Yn[t]??=new RegExp(t==="*"?"":`^${t.replace(/\/\*$|([.\\+*[^\]$()])/g,(e,r)=>r?`\\${r}`:"(?:|/.*)")}$`)}function qa(){Yn=Object.create(null)}function Na(t){let e=new Wn,r=[];if(t.length===0)return ja;let s=t.map(c=>[!/\*|\/:/.test(c[0]),...c]).sort(([c,d],[m,y])=>c?1:m?-1:d.length-y.length),n=Object.create(null);for(let c=0,d=-1,m=s.length;c<m;c++){let[y,S,v]=s[c];y?n[S]=[v.map(([T])=>[T,Object.create(null)]),Jn]:d++;let E;try{E=e.insert(S,d,y)}catch(T){throw T===Ce?new Wt(S):T}y||(r[d]=v.map(([T,A])=>{let q=Object.create(null);for(A-=1;A>=0;A--){let[N,M]=E[A];q[N]=M}return[T,q]}))}let[o,i,a]=e.buildRegExp();for(let c=0,d=r.length;c<d;c++)for(let m=0,y=r[c].length;m<y;m++){let S=r[c][m]?.[1];if(!S)continue;let v=Object.keys(S);for(let E=0,T=v.length;E<T;E++)S[v[E]]=a[S[v[E]]]}let l=[];for(let c in i)l[c]=r[i[c]];return[o,l,n]}function Ke(t,e){if(t){for(let r of Object.keys(t).sort((s,n)=>n.length-s.length))if(Xn(r).test(e))return[...t[r]]}}var Jr=class{name="RegExpRouter";#t;#e;constructor(){this.#t={[B]:Object.create(null)},this.#e={[B]:Object.create(null)}}add(t,e,r){let s=this.#t,n=this.#e;if(!s||!n)throw new Error(Vt);s[t]||[s,n].forEach(a=>{a[t]=Object.create(null),Object.keys(a[B]).forEach(l=>{a[t][l]=[...a[B][l]]})}),e==="/*"&&(e="*");let o=(e.match(/\/:/g)||[]).length;if(/\*$/.test(e)){let a=Xn(e);t===B?Object.keys(s).forEach(l=>{s[l][e]||=Ke(s[l],e)||Ke(s[B],e)||[]}):s[t][e]||=Ke(s[t],e)||Ke(s[B],e)||[],Object.keys(s).forEach(l=>{(t===B||t===l)&&Object.keys(s[l]).forEach(c=>{a.test(c)&&s[l][c].push([r,o])})}),Object.keys(n).forEach(l=>{(t===B||t===l)&&Object.keys(n[l]).forEach(c=>a.test(c)&&n[l][c].push([r,o]))});return}let i=kt(e)||[e];for(let a=0,l=i.length;a<l;a++){let c=i[a];Object.keys(n).forEach(d=>{(t===B||t===d)&&(n[d][c]||=[...Ke(s[d],c)||Ke(s[B],c)||[]],n[d][c].push([r,o-l+a+1]))})}}match(t,e){qa();let r=this.#r();return this.match=(s,n)=>{let o=r[s]||r[B],i=o[2][n];if(i)return i;let a=n.match(o[0]);if(!a)return[[],Jn];let l=a.indexOf("",1);return[o[1][l],a]},this.match(t,e)}#r(){let t=Object.create(null);return Object.keys(this.#e).concat(Object.keys(this.#t)).forEach(e=>{t[e]||=this.#o(e)}),this.#t=this.#e=void 0,t}#o(t){let e=[],r=t===B;return[this.#t,this.#e].forEach(s=>{let n=s[t]?Object.keys(s[t]).map(o=>[o,s[t][o]]):[];n.length!==0?(r||=!0,e.push(...n)):t!==B&&e.push(...Object.keys(s[B]).map(o=>[o,s[B][o]]))}),r?Na(e):null}};var Yr=class{name="SmartRouter";#t=[];#e=[];constructor(t){this.#t=t.routers}add(t,e,r){if(!this.#e)throw new Error(Vt);this.#e.push([t,e,r])}match(t,e){if(!this.#e)throw new Error("Fatal error");let r=this.#t,s=this.#e,n=r.length,o=0,i;for(;o<n;o++){let a=r[o];try{for(let l=0,c=s.length;l<c;l++)a.add(...s[l]);i=a.match(t,e)}catch(l){if(l instanceof Wt)continue;throw l}this.match=a.match.bind(a),this.#t=[a],this.#e=void 0;break}if(o===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(this.#e||this.#t.length!==1)throw new Error("No active router has been determined yet.");return this.#t[0]}};var ct=Object.create(null),Xr=class{#t;#e;#r;#o=0;#n=ct;constructor(t,e,r){if(this.#e=r||Object.create(null),this.#t=[],t&&e){let s=Object.create(null);s[t]={handler:e,possibleKeys:[],score:0},this.#t=[s]}this.#r=[]}insert(t,e,r){this.#o=++this.#o;let s=this,n=Bn(e),o=[];for(let i=0,a=n.length;i<a;i++){let l=n[i],c=n[i+1],d=Pn(l,c),m=Array.isArray(d)?d[0]:l;if(m in s.#e){s=s.#e[m],d&&o.push(d[1]);continue}s.#e[m]=new Xr,d&&(s.#r.push(d),o.push(d[1])),s=s.#e[m]}return s.#t.push({[t]:{handler:r,possibleKeys:o.filter((i,a,l)=>l.indexOf(i)===a),score:this.#o}}),s}#s(t,e,r,s){let n=[];for(let o=0,i=t.#t.length;o<i;o++){let a=t.#t[o],l=a[e]||a[B],c={};if(l!==void 0&&(l.params=Object.create(null),n.push(l),r!==ct||s&&s!==ct))for(let d=0,m=l.possibleKeys.length;d<m;d++){let y=l.possibleKeys[d],S=c[l.score];l.params[y]=s?.[y]&&!S?s[y]:r[y]??s?.[y],c[l.score]=!0}}return n}search(t,e){let r=[];this.#n=ct;let n=[this],o=zr(e),i=[];for(let a=0,l=o.length;a<l;a++){let c=o[a],d=a===l-1,m=[];for(let y=0,S=n.length;y<S;y++){let v=n[y],E=v.#e[c];E&&(E.#n=v.#n,d?(E.#e["*"]&&r.push(...this.#s(E.#e["*"],t,v.#n)),r.push(...this.#s(E,t,v.#n))):m.push(E));for(let T=0,A=v.#r.length;T<A;T++){let q=v.#r[T],N=v.#n===ct?{}:{...v.#n};if(q==="*"){let P=v.#e["*"];P&&(r.push(...this.#s(P,t,v.#n)),P.#n=N,m.push(P));continue}let[M,V,se]=q;if(!c&&!(se instanceof RegExp))continue;let x=v.#e[M],C=o.slice(a).join("/");if(se instanceof RegExp){let P=se.exec(C);if(P){if(N[V]=P[0],r.push(...this.#s(x,t,v.#n,N)),Object.keys(x.#e).length){x.#n=N;let Ue=P[0].match(/\//)?.length??0;(i[Ue]||=[]).push(x)}continue}}(se===!0||se.test(c))&&(N[V]=c,d?(r.push(...this.#s(x,t,N,v.#n)),x.#e["*"]&&r.push(...this.#s(x.#e["*"],t,N,v.#n))):(x.#n=N,m.push(x)))}}n=m.concat(i.shift()??[])}return r.length>1&&r.sort((a,l)=>a.score-l.score),[r.map(({handler:a,params:l})=>[a,l])]}};var Zr=class{name="TrieRouter";#t;constructor(){this.#t=new Xr}add(t,e,r){let s=kt(e);if(s){for(let n=0,o=s.length;n<o;n++)this.#t.insert(t,s[n],r);return}this.#t.insert(t,e,r)}match(t,e){return this.#t.search(t,e)}};var Q=class extends Wr{constructor(t={}){super(t),this.router=t.router??new Yr({routers:[new Jr,new Zr]})}};var Zn=t=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...t},s=(o=>typeof o=="string"?o==="*"?()=>o:i=>o===i?i:null:typeof o=="function"?o:i=>o.includes(i)?i:null)(r.origin),n=(o=>typeof o=="function"?o:Array.isArray(o)?()=>o:()=>[])(r.allowMethods);return async function(i,a){function l(d,m){i.res.headers.set(d,m)}let c=s(i.req.header("origin")||"",i);if(c&&l("Access-Control-Allow-Origin",c),r.origin!=="*"){let d=i.req.header("Vary");d?l("Vary",d):l("Vary","Origin")}if(r.credentials&&l("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&l("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),i.req.method==="OPTIONS"){r.maxAge!=null&&l("Access-Control-Max-Age",r.maxAge.toString());let d=n(i.req.header("origin")||"",i);d.length&&l("Access-Control-Allow-Methods",d.join(","));let m=r.allowHeaders;if(!m?.length){let y=i.req.header("Access-Control-Request-Headers");y&&(m=y.split(/\s*,\s*/))}return m?.length&&(l("Access-Control-Allow-Headers",m.join(",")),i.res.headers.append("Vary","Access-Control-Request-Headers")),i.res.headers.delete("Content-Length"),i.res.headers.delete("Content-Type"),new Response(null,{headers:i.res.headers,status:204,statusText:"No Content"})}await a()}};function $a(){let{process:t,Deno:e}=globalThis;return!(typeof e?.noColor=="boolean"?e.noColor:t!==void 0?"NO_COLOR"in t?.env:!1)}async function eo(){let{navigator:t}=globalThis,e="cloudflare:workers";return!(t!==void 0&&t.userAgent==="Cloudflare-Workers"?await(async()=>{try{return"NO_COLOR"in((await import(e)).env??{})}catch{return!1}})():!$a())}var Ma=t=>{let[e,r]=[",","."];return t.map(n=>n.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+e)).join(r)},Aa=t=>{let e=Date.now()-t;return Ma([e<1e3?e+"ms":Math.round(e/1e3)+"s"])},Oa=async t=>{if(await eo())switch(t/100|0){case 5:return`\x1B[31m${t}\x1B[0m`;case 4:return`\x1B[33m${t}\x1B[0m`;case 3:return`\x1B[36m${t}\x1B[0m`;case 2:return`\x1B[32m${t}\x1B[0m`}return`${t}`};async function to(t,e,r,s,n=0,o){let i=e==="<--"?`${e} ${r} ${s}`:`${e} ${r} ${s} ${await Oa(n)} ${o}`;t(i)}var ro=(t=console.log)=>async function(r,s){let{method:n,url:o}=r.req,i=o.slice(o.indexOf("/",8));await to(t,"<--",n,i);let a=Date.now();await s(),await to(t,"-->",n,i,r.res.status,Aa(a))};var so=async(t,e)=>{let r=Date.now();console.log(`--> ${t.req.method} ${t.req.url}`),await e();let s=Date.now()-r;console.log(`<-- ${t.req.method} ${t.req.url} ${t.res.status} ${s}ms`)};var f=Symbol.for("drizzle:entityKind"),eu=Symbol.for("drizzle:hasOwnEntityKind");function p(t,e){if(!t||typeof t!="object")return!1;if(t instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,f))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let r=t.constructor;if(r)for(;r;){if(f in r&&r[f]===e[f])return!0;r=Object.getPrototypeOf(r)}return!1}var j=class{constructor(e,r){this.table=e,this.config=r,this.name=r.name,this.notNull=r.notNull,this.default=r.default,this.defaultFn=r.defaultFn,this.onUpdateFn=r.onUpdateFn,this.hasDefault=r.hasDefault,this.primary=r.primaryKey,this.isUnique=r.isUnique,this.uniqueName=r.uniqueName,this.uniqueType=r.uniqueType,this.dataType=r.dataType,this.columnType=r.columnType}static[f]="Column";name;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}};var Ge=class{static[f]="ColumnBuilder";config;constructor(e,r,s){this.config={name:e,notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:r,columnType:s}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(e){return this.config.onUpdateFn=e,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}};var ut=Symbol.for("drizzle:Name"),Xt=Symbol.for("drizzle:Schema"),no=Symbol.for("drizzle:Columns"),oo=Symbol.for("drizzle:ExtraConfigColumns"),es=Symbol.for("drizzle:OriginalName"),ts=Symbol.for("drizzle:BaseName"),io=Symbol.for("drizzle:IsAlias"),ao=Symbol.for("drizzle:ExtraConfigBuilder"),au=Symbol.for("drizzle:IsDrizzleTable"),h=class{static[f]="Table";static Symbol={Name:ut,Schema:Xt,OriginalName:es,Columns:no,ExtraConfigColumns:oo,BaseName:ts,IsAlias:io,ExtraConfigBuilder:ao};[ut];[es];[Xt];[no];[oo];[ts];[io]=!1;[ao]=void 0;constructor(e,r,s){this[ut]=this[es]=e,this[Xt]=r,this[ts]=s}};function Se(t){return t[ut]}function je(t){return`${t[Xt]??"public"}.${t[ut]}`}var lo=Symbol.for("drizzle:PgInlineForeignKeys"),we=class extends h{static[f]="PgTable";static Symbol=Object.assign({},h.Symbol,{InlineForeignKeys:lo});[lo]=[];[h.Symbol.ExtraConfigBuilder]=void 0};var Zt=class{static[f]="PgForeignKeyBuilder";reference;_onUpdate="no action";_onDelete="no action";constructor(e,r){this.reference=()=>{let{name:s,columns:n,foreignColumns:o}=e();return{name:s,columns:n,foreignTable:o[0].table,foreignColumns:o}},r&&(this._onUpdate=r.onUpdate,this._onDelete=r.onDelete)}onUpdate(e){return this._onUpdate=e===void 0?"no action":e,this}onDelete(e){return this._onDelete=e===void 0?"no action":e,this}build(e){return new rs(e,this)}},rs=class{constructor(e,r){this.table=e,this.reference=r.reference,this.onUpdate=r._onUpdate,this.onDelete=r._onDelete}static[f]="PgForeignKey";reference;onUpdate;onDelete;getName(){let{name:e,columns:r,foreignColumns:s}=this.reference(),n=r.map(a=>a.name),o=s.map(a=>a.name),i=[this.table[we.Symbol.Name],...n,s[0].table[we.Symbol.Name],...o];return e??`${i.join("_")}_fk`}};function er(t,...e){return t(...e)}function os(t,e){return`${t[we.Symbol.Name]}_${e.join("_")}_unique`}var ss=class{constructor(e,r){this.name=r,this.columns=e}static[f]="PgUniqueConstraintBuilder";columns;nullsNotDistinctConfig=!1;nullsNotDistinct(){return this.nullsNotDistinctConfig=!0,this}build(e){return new ns(e,this.columns,this.nullsNotDistinctConfig,this.name)}},co=class{static[f]="PgUniqueOnConstraintBuilder";name;constructor(e){this.name=e}on(...e){return new ss(e,this.name)}},ns=class{constructor(e,r,s,n){this.table=e,this.columns=r,this.name=n??os(this.table,this.columns.map(o=>o.name)),this.nullsNotDistinct=s}static[f]="PgUniqueConstraint";columns;name;nullsNotDistinct=!1;getName(){return this.name}};function uo(t,e,r){for(let s=e;s<t.length;s++){let n=t[s];if(n==="\\"){s++;continue}if(n==='"')return[t.slice(e,s).replace(/\\/g,""),s+1];if(!r&&(n===","||n==="}"))return[t.slice(e,s).replace(/\\/g,""),s]}return[t.slice(e).replace(/\\/g,""),t.length]}function fo(t,e=0){let r=[],s=e,n=!1;for(;s<t.length;){let o=t[s];if(o===","){(n||s===e)&&r.push(""),n=!0,s++;continue}if(n=!1,o==="\\"){s+=2;continue}if(o==='"'){let[l,c]=uo(t,s+1,!0);r.push(l),s=c;continue}if(o==="}")return[r,s+1];if(o==="{"){let[l,c]=fo(t,s+1);r.push(l),s=c;continue}let[i,a]=uo(t,s,!1);r.push(i),s=a}return[r,s]}function po(t){let[e]=fo(t,1);return e}function is(t){return`{${t.map(e=>Array.isArray(e)?is(e):typeof e=="string"?`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:`${e}`).join(",")}}`}var dt=class extends Ge{foreignKeyConfigs=[];static[f]="PgColumnBuilder";array(e){return new ls(this.config.name,this,e)}references(e,r={}){return this.foreignKeyConfigs.push({ref:e,actions:r}),this}unique(e,r){return this.config.isUnique=!0,this.config.uniqueName=e,this.config.uniqueType=r?.nulls,this}buildForeignKeys(e,r){return this.foreignKeyConfigs.map(({ref:s,actions:n})=>er((o,i)=>{let a=new Zt(()=>{let l=o();return{columns:[e],foreignColumns:[l]}});return i.onUpdate&&a.onUpdate(i.onUpdate),i.onDelete&&a.onDelete(i.onDelete),a.build(r)},s,n))}buildExtraConfigColumn(e){return new as(e,this.config)}},ze=class extends j{constructor(e,r){r.uniqueName||(r.uniqueName=os(e,[r.name])),super(e,r),this.table=e}static[f]="PgColumn"},as=class extends ze{static[f]="ExtraConfigColumn";getSQLType(){return this.getSQLType()}indexConfig={order:this.config.order??"asc",nulls:this.config.nulls??"last",opClass:this.config.opClass};defaultConfig={order:"asc",nulls:"last",opClass:void 0};asc(){return this.indexConfig.order="asc",this}desc(){return this.indexConfig.order="desc",this}nullsFirst(){return this.indexConfig.nulls="first",this}nullsLast(){return this.indexConfig.nulls="last",this}op(e){return this.indexConfig.opClass=e,this}},mo=class{static[f]="IndexedColumn";constructor(e,r,s){this.name=e,this.type=r,this.indexConfig=s}name;type;indexConfig},ls=class extends dt{static[f]="PgArrayBuilder";constructor(e,r,s){super(e,"array","PgArray"),this.config.baseBuilder=r,this.config.size=s}build(e){let r=this.config.baseBuilder.build(e);return new cs(e,this.config,r)}},cs=class t extends ze{constructor(e,r,s,n){super(e,r),this.baseColumn=s,this.range=n,this.size=r.size}size;static[f]="PgArray";getSQLType(){return`${this.baseColumn.getSQLType()}[${typeof this.size=="number"?this.size:""}]`}mapFromDriverValue(e){return typeof e=="string"&&(e=po(e)),e.map(r=>this.baseColumn.mapFromDriverValue(r))}mapToDriverValue(e,r=!1){let s=e.map(n=>n===null?null:p(this.baseColumn,t)?this.baseColumn.mapToDriverValue(n,!0):this.baseColumn.mapToDriverValue(n));return r?s:is(s)}};var ho=Symbol.for("drizzle:isPgEnum");function yo(t){return!!t&&typeof t=="function"&&ho in t&&t[ho]===!0}var go=class extends dt{static[f]="PgEnumColumnBuilder";constructor(e,r){super(e,"string","PgEnumColumn"),this.config.enum=r}build(e){return new us(e,this.config)}},us=class extends ze{static[f]="PgEnumColumn";enum=this.config.enum;enumValues=this.config.enum.enumValues;constructor(e,r){super(e,r),this.enum=r.enum}getSQLType(){return this.enum.enumName}};var U=class{static[f]="Subquery";constructor(e,r,s,n=!1){this._={brand:"Subquery",sql:e,selectedFields:r,alias:s,isWith:n}}},ke=class extends U{static[f]="WithSubquery"};var wo="0.31.4";var ds,fs,bo={startActiveSpan(t,e){return ds?(fs||(fs=ds.trace.getTracer("drizzle-orm",wo)),er((r,s)=>s.startActiveSpan(t,n=>{try{return e(n)}catch(o){throw n.setStatus({code:r.SpanStatusCode.ERROR,message:o instanceof Error?o.message:"Unknown error"}),o}finally{n.end()}}),ds,fs)):e()}};var L=Symbol.for("drizzle:ViewBaseConfig");var vo=class{static[f]="FakePrimitiveParam"};function ps(t){return t!=null&&typeof t.getSQL=="function"}function Ra(t){let e={sql:"",params:[]};for(let r of t)e.sql+=r.sql,e.params.push(...r.params),r.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...r.typings));return e}var D=class{static[f]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new g([this])}},g=class t{constructor(e){this.queryChunks=e}static[f]="SQL";decoder=So;shouldInlineParams=!1;append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return bo.startActiveSpan("drizzle.buildSQL",r=>{let s=this.buildQueryFromSourceParams(this.queryChunks,e);return r?.setAttributes({"drizzle.query.text":s.sql,"drizzle.query.params":JSON.stringify(s.params)}),s})}buildQueryFromSourceParams(e,r){let s=Object.assign({},r,{inlineParams:r.inlineParams||this.shouldInlineParams,paramStartIndex:r.paramStartIndex||{value:0}}),{escapeName:n,escapeParam:o,prepareTyping:i,inlineParams:a,paramStartIndex:l}=s;return Ra(e.map(c=>{if(p(c,D))return{sql:c.value.join(""),params:[]};if(p(c,ft))return{sql:n(c.value),params:[]};if(c===void 0)return{sql:"",params:[]};if(Array.isArray(c)){let d=[new D("(")];for(let[m,y]of c.entries())d.push(y),m<c.length-1&&d.push(new D(", "));return d.push(new D(")")),this.buildQueryFromSourceParams(d,s)}if(p(c,t))return this.buildQueryFromSourceParams(c.queryChunks,{...s,inlineParams:a||c.shouldInlineParams});if(p(c,h)){let d=c[h.Symbol.Schema],m=c[h.Symbol.Name];return{sql:d===void 0?n(m):n(d)+"."+n(m),params:[]}}if(p(c,j))return r.invokeSource==="indexes"?{sql:n(c.name),params:[]}:{sql:n(c.table[h.Symbol.Name])+"."+n(c.name),params:[]};if(p(c,te)){let d=c[L].schema,m=c[L].name;return{sql:d===void 0?n(m):n(d)+"."+n(m),params:[]}}if(p(c,ee)){let d=c.value===null?null:c.encoder.mapToDriverValue(c.value);if(p(d,t))return this.buildQueryFromSourceParams([d],s);if(a)return{sql:this.mapInlineParam(d,s),params:[]};let m;return i&&(m=[i(c.encoder)]),{sql:o(l.value++,d),params:[d],typings:m}}return p(c,qe)?{sql:o(l.value++,c),params:[c],typings:["none"]}:p(c,t.Aliased)&&c.fieldAlias!==void 0?{sql:n(c.fieldAlias),params:[]}:p(c,U)?c._.isWith?{sql:n(c._.alias),params:[]}:this.buildQueryFromSourceParams([new D("("),c._.sql,new D(") "),new ft(c._.alias)],s):yo(c)?c.schema?{sql:n(c.schema)+"."+n(c.enumName),params:[]}:{sql:n(c.enumName),params:[]}:ps(c)?c.shouldOmitSQLParens?.()?this.buildQueryFromSourceParams([c.getSQL()],s):this.buildQueryFromSourceParams([new D("("),c.getSQL(),new D(")")],s):a?{sql:this.mapInlineParam(c,s),params:[]}:{sql:o(l.value++,c),params:[c]}}))}mapInlineParam(e,{escapeString:r}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return r(e);if(typeof e=="object"){let s=e.toString();return r(s==="[object Object]"?JSON.stringify(e):s)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new t.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}if(e){return e?this:void 0}},ft=class{constructor(e){this.value=e}static[f]="Name";brand;getSQL(){return new g([this])}};function xo(t){return typeof t=="object"&&t!==null&&"mapToDriverValue"in t&&typeof t.mapToDriverValue=="function"}var So={mapFromDriverValue:t=>t},Eo={mapToDriverValue:t=>t},zu={...So,...Eo},ee=class{constructor(e,r=Eo){this.value=e,this.encoder=r}static[f]="Param";brand;getSQL(){return new g([this])}};function u(t,...e){let r=[];(e.length>0||t.length>0&&t[0]!=="")&&r.push(new D(t[0]));for(let[s,n]of e.entries())r.push(n,new D(t[s+1]));return new g(r)}(t=>{function e(){return new g([])}t.empty=e;function r(l){return new g(l)}t.fromList=r;function s(l){return new g([new D(l)])}t.raw=s;function n(l,c){let d=[];for(let[m,y]of l.entries())m>0&&c!==void 0&&d.push(c),d.push(y);return new g(d)}t.join=n;function o(l){return new ft(l)}t.identifier=o;function i(l){return new qe(l)}t.placeholder=i;function a(l,c){return new ee(l,c)}t.param=a})(u||(u={}));(t=>{class e{constructor(s,n){this.sql=s,this.fieldAlias=n}static[f]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}t.Aliased=e})(g||(g={}));var qe=class{constructor(e){this.name=e}static[f]="Placeholder";getSQL(){return new g([this])}};function pt(t,e){return t.map(r=>{if(p(r,qe)){if(!(r.name in e))throw new Error(`No value for placeholder "${r.name}" was provided`);return e[r.name]}return r})}var te=class{static[f]="View";[L];constructor({name:e,schema:r,selectedFields:s,query:n}){this[L]={name:e,originalName:e,schema:r,selectedFields:s,query:n,isExisting:!n,isAlias:!1}}getSQL(){return new g([this])}};j.prototype.getSQL=function(){return new g([this])};h.prototype.getSQL=function(){return new g([this])};U.prototype.getSQL=function(){return new g([this])};var Ne=class{constructor(e){this.table=e}static[f]="ColumnAliasProxyHandler";get(e,r){return r==="table"?this.table:e[r]}},He=class{constructor(e,r){this.alias=e,this.replaceOriginalName=r}static[f]="TableAliasProxyHandler";get(e,r){if(r===h.Symbol.IsAlias)return!0;if(r===h.Symbol.Name)return this.alias;if(this.replaceOriginalName&&r===h.Symbol.OriginalName)return this.alias;if(r===L)return{...e[L],name:this.alias,isAlias:!0};if(r===h.Symbol.Columns){let n=e[h.Symbol.Columns];if(!n)return n;let o={};return Object.keys(n).map(i=>{o[i]=new Proxy(n[i],new Ne(new Proxy(e,this)))}),o}let s=e[r];return p(s,j)?new Proxy(s,new Ne(new Proxy(e,this))):s}},Io=class{constructor(e){this.alias=e}static[f]="RelationTableAliasProxyHandler";get(e,r){return r==="sourceTable"?mt(e.sourceTable,this.alias):e[r]}};function mt(t,e){return new Proxy(t,new He(e,!1))}function pe(t,e){return new Proxy(t,new Ne(new Proxy(t.table,new He(e,!1))))}function ms(t,e){return new g.Aliased(ht(t.sql,e),t.fieldAlias)}function ht(t,e){return u.join(t.queryChunks.map(r=>p(r,j)?pe(r,e):p(r,g)?ht(r,e):p(r,g.Aliased)?ms(r,e):r))}var $e=class extends Error{static[f]="DrizzleError";constructor({message:e,cause:r}){super(e),this.name="DrizzleError",this.cause=r}},tr=class extends $e{static[f]="TransactionRollbackError";constructor(){super({message:"Rollback"})}};function Y(t,e){return xo(e)&&!ps(t)&&!p(t,ee)&&!p(t,qe)&&!p(t,j)&&!p(t,h)&&!p(t,te)?new ee(t,e):t}var b=(t,e)=>u`${t} = ${Y(e,t)}`,To=(t,e)=>u`${t} <> ${Y(e,t)}`;function ae(...t){let e=t.filter(r=>r!==void 0);if(e.length!==0)return e.length===1?new g(e):new g([new D("("),u.join(e,new D(" and ")),new D(")")])}function Co(...t){let e=t.filter(r=>r!==void 0);if(e.length!==0)return e.length===1?new g(e):new g([new D("("),u.join(e,new D(" or ")),new D(")")])}function jo(t){return u`not ${t}`}var qo=(t,e)=>u`${t} > ${Y(e,t)}`,No=(t,e)=>u`${t} >= ${Y(e,t)}`,rr=(t,e)=>u`${t} < ${Y(e,t)}`,$o=(t,e)=>u`${t} <= ${Y(e,t)}`;function Mo(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("inArray requires at least one value");return u`${t} in ${e.map(r=>Y(r,t))}`}return u`${t} in ${Y(e,t)}`}function Ao(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("notInArray requires at least one value");return u`${t} not in ${e.map(r=>Y(r,t))}`}return u`${t} not in ${Y(e,t)}`}function Oo(t){return u`${t} is null`}function Ro(t){return u`${t} is not null`}function _o(t){return u`exists ${t}`}function Bo(t){return u`not exists ${t}`}function Po(t,e,r){return u`${t} between ${Y(e,t)} and ${Y(r,t)}`}function Lo(t,e,r){return u`${t} not between ${Y(e,t)} and ${Y(r,t)}`}function Do(t,e){return u`${t} like ${e}`}function Fo(t,e){return u`${t} not like ${e}`}function Qo(t,e){return u`${t} ilike ${e}`}function Uo(t,e){return u`${t} not ilike ${e}`}function sr(t){return u`${t} asc`}function le(t){return u`${t} desc`}var hs=class{static[f]="ConsoleLogWriter";write(e){console.log(e)}},nr=class{static[f]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new hs}logQuery(e,r){let s=r.map(o=>{try{return JSON.stringify(o)}catch{return String(o)}}),n=s.length?` -- params: [${s.join(", ")}]`:"";this.writer.write(`Query: ${e}${n}`)}},or=class{static[f]="NoopLogger";logQuery(){}};var z=class{static[f]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}then(e,r){return this.execute().then(e,r)}};var ir=class{static[f]="PgPrimaryKeyBuilder";columns;name;constructor(e,r){this.columns=e,this.name=r}build(e){return new gs(e,this.columns,this.name)}},gs=class{constructor(e,r,s){this.table=e,this.columns=r,this.name=s}static[f]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[we.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}};var ar=class{constructor(e,r,s){this.sourceTable=e,this.referencedTable=r,this.relationName=s,this.referencedTableName=r[h.Symbol.Name]}static[f]="Relation";referencedTableName;fieldName},ys=class{constructor(e,r){this.table=e,this.config=r}static[f]="Relations"},Ee=class t extends ar{constructor(e,r,s,n){super(e,r,s?.relationName),this.config=s,this.isNullable=n}static[f]="One";withFieldName(e){let r=new t(this.sourceTable,this.referencedTable,this.config,this.isNullable);return r.fieldName=e,r}},gt=class t extends ar{constructor(e,r,s){super(e,r,s?.relationName),this.config=s}static[f]="Many";withFieldName(e){let r=new t(this.sourceTable,this.referencedTable,this.config);return r.fieldName=e,r}};function Ko(){return{and:ae,between:Po,eq:b,exists:_o,gt:qo,gte:No,ilike:Qo,inArray:Mo,isNull:Oo,isNotNull:Ro,like:Do,lt:rr,lte:$o,ne:To,not:jo,notBetween:Lo,notExists:Bo,notLike:Fo,notIlike:Uo,notInArray:Ao,or:Co,sql:u}}function Go(){return{sql:u,asc:sr,desc:le}}function zo(t,e){Object.keys(t).length===1&&"default"in t&&!p(t.default,h)&&(t=t.default);let r={},s={},n={};for(let[o,i]of Object.entries(t))if(p(i,h)){let a=je(i),l=s[a];r[a]=o,n[o]={tsName:o,dbName:i[h.Symbol.Name],schema:i[h.Symbol.Schema],columns:i[h.Symbol.Columns],relations:l?.relations??{},primaryKey:l?.primaryKey??[]};for(let d of Object.values(i[h.Symbol.Columns]))d.primary&&n[o].primaryKey.push(d);let c=i[h.Symbol.ExtraConfigBuilder]?.(i[h.Symbol.ExtraConfigColumns]);if(c)for(let d of Object.values(c))p(d,ir)&&n[o].primaryKey.push(...d.columns)}else if(p(i,ys)){let a=je(i.table),l=r[a],c=i.config(e(i.table)),d;for(let[m,y]of Object.entries(c))if(l){let S=n[l];S.relations[m]=y,d&&S.primaryKey.push(...d)}else a in s||(s[a]={relations:{},primaryKey:d}),s[a].relations[m]=y}return{tables:n,tableNamesMap:r}}function _a(t){return function(r,s){return new Ee(t,r,s,s?.fields.reduce((n,o)=>n&&o.notNull,!0)??!1)}}function Ba(t){return function(r,s){return new gt(t,r,s)}}function ko(t,e,r){if(p(r,Ee)&&r.config)return{fields:r.config.fields,references:r.config.references};let s=e[je(r.referencedTable)];if(!s)throw new Error(`Table "${r.referencedTable[h.Symbol.Name]}" not found in schema`);let n=t[s];if(!n)throw new Error(`Table "${s}" not found in schema`);let o=r.sourceTable,i=e[je(o)];if(!i)throw new Error(`Table "${o[h.Symbol.Name]}" not found in schema`);let a=[];for(let l of Object.values(n.relations))(r.relationName&&r!==l&&l.relationName===r.relationName||!r.relationName&&l.referencedTable===r.sourceTable)&&a.push(l);if(a.length>1)throw r.relationName?new Error(`There are multiple relations with name "${r.relationName}" in table "${s}"`):new Error(`There are multiple relations between "${s}" and "${r.sourceTable[h.Symbol.Name]}". Please specify relation name`);if(a[0]&&p(a[0],Ee)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${i}.${r.fieldName}"`)}function Ho(t){return{one:_a(t),many:Ba(t)}}function lr(t,e,r,s,n=o=>o){let o={};for(let[i,a]of s.entries())if(a.isJson){let l=e.relations[a.tsKey],c=r[i],d=typeof c=="string"?JSON.parse(c):c;o[a.tsKey]=p(l,Ee)?d&&lr(t,t[a.relationTableTsKey],d,a.selection,n):d.map(m=>lr(t,t[a.relationTableTsKey],m,a.selection,n))}else{let l=n(r[i]),c=a.field,d;p(c,j)?d=c:p(c,g)?d=c.decoder:d=c.sql.decoder,o[a.tsKey]=l===null?null:d.mapFromDriverValue(l)}return o}function ws(t,e,r){let s={},n=t.reduce((o,{path:i,field:a},l)=>{let c;p(a,j)?c=a:p(a,g)?c=a.decoder:c=a.sql.decoder;let d=o;for(let[m,y]of i.entries())if(m<i.length-1)y in d||(d[y]={}),d=d[y];else{let S=e[l],v=d[y]=S===null?null:c.mapFromDriverValue(S);if(r&&p(a,j)&&i.length===2){let E=i[0];E in s?typeof s[E]=="string"&&s[E]!==Se(a.table)&&(s[E]=!1):s[E]=v===null?Se(a.table):!1}}return o},{});if(r&&Object.keys(s).length>0)for(let[o,i]of Object.entries(s))typeof i=="string"&&!r[i]&&(n[o]=null);return n}function ne(t,e){return Object.entries(t).reduce((r,[s,n])=>{if(typeof s!="string")return r;let o=e?[...e,s]:[s];return p(n,j)||p(n,g)||p(n,g.Aliased)?r.push({path:o,field:n}):p(n,h)?r.push(...ne(n[h.Symbol.Columns],o)):r.push(...ne(n,o)),r},[])}function bs(t,e){let r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(let[n,o]of r.entries())if(o!==s[n])return!1;return!0}function cr(t,e){let r=Object.entries(e).filter(([,s])=>s!==void 0).map(([s,n])=>p(n,g)?[s,n]:[s,new ee(n,t[h.Symbol.Columns][s])]);if(r.length===0)throw new Error("No values to set");return Object.fromEntries(r)}function Vo(t,e){for(let r of e)for(let s of Object.getOwnPropertyNames(r.prototype))s!=="constructor"&&Object.defineProperty(t.prototype,s,Object.getOwnPropertyDescriptor(r.prototype,s)||Object.create(null))}function Wo(t){return t[h.Symbol.Columns]}function vs(t){return p(t,U)?t._.alias:p(t,te)?t[L].name:p(t,g)?void 0:t[h.Symbol.IsAlias]?t[h.Symbol.Name]:t[h.Symbol.BaseName]}var X=class t{static[f]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,r){if(r==="_")return{...e._,selectedFields:new Proxy(e._.selectedFields,this)};if(r===L)return{...e[L],selectedFields:new Proxy(e[L].selectedFields,this)};if(typeof r=="symbol")return e[r];let n=(p(e,U)?e._.selectedFields:p(e,te)?e[L].selectedFields:e)[r];if(p(n,g.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!n.isSelectionField)return n.sql;let o=n.clone();return o.isSelectionField=!0,o}if(p(n,g)){if(this.config.sqlBehavior==="sql")return n;throw new Error(`You tried to reference "${r}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return p(n,j)?this.config.alias?new Proxy(n,new Ne(new Proxy(n.table,new He(this.config.alias,this.config.replaceOriginalName??!1)))):n:typeof n!="object"||n===null?n:new Proxy(n,new t(this.config))}};var xs=Symbol.for("drizzle:SQLiteInlineForeignKeys"),R=class extends h{static[f]="SQLiteTable";static Symbol=Object.assign({},h.Symbol,{InlineForeignKeys:xs});[h.Symbol.Columns];[xs]=[];[h.Symbol.ExtraConfigBuilder]=void 0};function Pa(t,e,r,s,n=t){let o=new R(t,s,n),i=Object.fromEntries(Object.entries(e).map(([l,c])=>{let d=c,m=d.build(o);return o[xs].push(...d.buildForeignKeys(m,o)),[l,m]})),a=Object.assign(o,i);return a[h.Symbol.Columns]=i,a[h.Symbol.ExtraConfigColumns]=i,r&&(a[R.Symbol.ExtraConfigBuilder]=r),a}var ce=(t,e,r)=>Pa(t,e,r);var yt=class extends z{constructor(e,r,s,n){super(),this.table=e,this.session=r,this.dialect=s,this.config={table:e,withList:n}}static[f]="SQLiteDelete";config;where(e){return this.config.where=e,this}returning(e=this.table[R.Symbol.Columns]){return this.config.returning=ne(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(e){return this._prepare().execute(e)}$dynamic(){return this}};var wt=class{constructor(e,r,s,n){this.table=e,this.session=r,this.dialect=s,this.withList=n}static[f]="SQLiteInsertBuilder";values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");let r=e.map(s=>{let n={},o=this.table[h.Symbol.Columns];for(let i of Object.keys(s)){let a=s[i];n[i]=p(a,g)?a:new ee(a,o[i])}return n});return new Ss(this.table,r,this.session,this.dialect,this.withList)}},Ss=class extends z{constructor(e,r,s,n,o){super(),this.session=s,this.dialect=n,this.config={table:e,values:r,withList:o}}static[f]="SQLiteInsert";config;returning(e=this.config.table[R.Symbol.Columns]){return this.config.returning=ne(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=u`do nothing`;else{let r=Array.isArray(e.target)?u`${e.target}`:u`${[e.target]}`,s=e.where?u` where ${e.where}`:u``;this.config.onConflict=u`${r} do nothing${s}`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');let r=e.where?u` where ${e.where}`:void 0,s=e.targetWhere?u` where ${e.targetWhere}`:void 0,n=e.setWhere?u` where ${e.setWhere}`:void 0,o=Array.isArray(e.target)?u`${e.target}`:u`${[e.target]}`,i=this.dialect.buildUpdateSet(this.config.table,cr(this.config.table,e.set));return this.config.onConflict=u`${o}${s} do update set ${i}${r}${n}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}};var ur=class{static[f]="SQLiteForeignKeyBuilder";reference;_onUpdate;_onDelete;constructor(e,r){this.reference=()=>{let{name:s,columns:n,foreignColumns:o}=e();return{name:s,columns:n,foreignTable:o[0].table,foreignColumns:o}},r&&(this._onUpdate=r.onUpdate,this._onDelete=r.onDelete)}onUpdate(e){return this._onUpdate=e,this}onDelete(e){return this._onDelete=e,this}build(e){return new Es(e,this)}},Es=class{constructor(e,r){this.table=e,this.reference=r.reference,this.onUpdate=r._onUpdate,this.onDelete=r._onDelete}static[f]="SQLiteForeignKey";reference;onUpdate;onDelete;getName(){let{name:e,columns:r,foreignColumns:s}=this.reference(),n=r.map(a=>a.name),o=s.map(a=>a.name),i=[this.table[R.Symbol.Name],...n,s[0].table[R.Symbol.Name],...o];return e??`${i.join("_")}_fk`}};function Cs(t,e){return`${t[R.Symbol.Name]}_${e.join("_")}_unique`}var Is=class{constructor(e,r){this.name=r,this.columns=e}static[f]="SQLiteUniqueConstraintBuilder";columns;build(e){return new Ts(e,this.columns,this.name)}},Jo=class{static[f]="SQLiteUniqueOnConstraintBuilder";name;constructor(e){this.name=e}on(...e){return new Is(e,this.name)}},Ts=class{constructor(e,r,s){this.table=e,this.columns=r,this.name=s??Cs(this.table,this.columns.map(n=>n.name))}static[f]="SQLiteUniqueConstraint";columns;name;getName(){return this.name}};var be=class extends Ge{static[f]="SQLiteColumnBuilder";foreignKeyConfigs=[];references(e,r={}){return this.foreignKeyConfigs.push({ref:e,actions:r}),this}unique(e){return this.config.isUnique=!0,this.config.uniqueName=e,this}buildForeignKeys(e,r){return this.foreignKeyConfigs.map(({ref:s,actions:n})=>((o,i)=>{let a=new ur(()=>{let l=o();return{columns:[e],foreignColumns:[l]}});return i.onUpdate&&a.onUpdate(i.onUpdate),i.onDelete&&a.onDelete(i.onDelete),a.build(r)})(s,n))}},re=class extends j{constructor(e,r){r.uniqueName||(r.uniqueName=Cs(e,[r.name])),super(e,r),this.table=e}static[f]="SQLiteColumn"};var bt=class extends be{static[f]="SQLiteBaseIntegerBuilder";constructor(e,r,s){super(e,r,s),this.config.autoIncrement=!1}primaryKey(e){return e?.autoIncrement&&(this.config.autoIncrement=!0),this.config.hasDefault=!0,super.primaryKey()}},vt=class extends re{static[f]="SQLiteBaseInteger";autoIncrement=this.config.autoIncrement;getSQLType(){return"integer"}},js=class extends bt{static[f]="SQLiteIntegerBuilder";constructor(e){super(e,"number","SQLiteInteger")}build(e){return new qs(e,this.config)}},qs=class extends vt{static[f]="SQLiteInteger"},Ns=class extends bt{static[f]="SQLiteTimestampBuilder";constructor(e,r){super(e,"date","SQLiteTimestamp"),this.config.mode=r}defaultNow(){return this.default(u`(cast((julianday('now') - 2440587.5)*86400000 as integer))`)}build(e){return new $s(e,this.config)}},$s=class extends vt{static[f]="SQLiteTimestamp";mode=this.config.mode;mapFromDriverValue(e){return this.config.mode==="timestamp"?new Date(e*1e3):new Date(e)}mapToDriverValue(e){let r=e.getTime();return this.config.mode==="timestamp"?Math.floor(r/1e3):r}},Ms=class extends bt{static[f]="SQLiteBooleanBuilder";constructor(e,r){super(e,"boolean","SQLiteBoolean"),this.config.mode=r}build(e){return new As(e,this.config)}},As=class extends vt{static[f]="SQLiteBoolean";mode=this.config.mode;mapFromDriverValue(e){return Number(e)===1}mapToDriverValue(e){return e?1:0}};function _(t,e){return e?.mode==="timestamp"||e?.mode==="timestamp_ms"?new Ns(t,e.mode):e?.mode==="boolean"?new Ms(t,e.mode):new js(t)}var Os=class extends be{static[f]="SQLiteNumericBuilder";constructor(e){super(e,"string","SQLiteNumeric")}build(e){return new Rs(e,this.config)}},Rs=class extends re{static[f]="SQLiteNumeric";getSQLType(){return"numeric"}};function dr(t){return new Os(t)}var _s=class extends be{static[f]="SQLiteTextBuilder";constructor(e,r){super(e,"string","SQLiteText"),this.config.enumValues=r.enum,this.config.length=r.length}build(e){return new Bs(e,this.config)}},Bs=class extends re{static[f]="SQLiteText";enumValues=this.config.enumValues;length=this.config.length;constructor(e,r){super(e,r)}getSQLType(){return`text${this.config.length?`(${this.config.length})`:""}`}},Ps=class extends be{static[f]="SQLiteTextJsonBuilder";constructor(e){super(e,"json","SQLiteTextJson")}build(e){return new Ls(e,this.config)}},Ls=class extends re{static[f]="SQLiteTextJson";getSQLType(){return"text"}mapFromDriverValue(e){return JSON.parse(e)}mapToDriverValue(e){return JSON.stringify(e)}};function $(t,e={}){return e.mode==="json"?new Ps(t):new _s(t,e)}var Ve=class extends te{static[f]="SQLiteViewBase"};var fr=class{static[f]="SQLiteDialect";escapeName(e){return`"${e}"`}escapeParam(e){return"?"}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;let r=[u`with `];for(let[s,n]of e.entries())r.push(u`${u.identifier(n._.alias)} as (${n._.sql})`),s<e.length-1&&r.push(u`, `);return r.push(u` `),u.join(r)}buildDeleteQuery({table:e,where:r,returning:s,withList:n}){let o=this.buildWithCTE(n),i=s?u` returning ${this.buildSelection(s,{isSingleTable:!0})}`:void 0,a=r?u` where ${r}`:void 0;return u`${o}delete from ${e}${a}${i}`}buildUpdateSet(e,r){let s=e[h.Symbol.Columns],n=Object.keys(s).filter(i=>r[i]!==void 0||s[i]?.onUpdateFn!==void 0),o=n.length;return u.join(n.flatMap((i,a)=>{let l=s[i],c=r[i]??u.param(l.onUpdateFn(),l),d=u`${u.identifier(l.name)} = ${c}`;return a<o-1?[d,u.raw(", ")]:[d]}))}buildUpdateQuery({table:e,set:r,where:s,returning:n,withList:o}){let i=this.buildWithCTE(o),a=this.buildUpdateSet(e,r),l=n?u` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,c=s?u` where ${s}`:void 0;return u`${i}update ${e} set ${a}${c}${l}`}buildSelection(e,{isSingleTable:r=!1}={}){let s=e.length,n=e.flatMap(({field:o},i)=>{let a=[];if(p(o,g.Aliased)&&o.isSelectionField)a.push(u.identifier(o.fieldAlias));else if(p(o,g.Aliased)||p(o,g)){let l=p(o,g.Aliased)?o.sql:o;r?a.push(new g(l.queryChunks.map(c=>p(c,j)?u.identifier(c.name):c))):a.push(l),p(o,g.Aliased)&&a.push(u` as ${u.identifier(o.fieldAlias)}`)}else if(p(o,j)){let l=o.table[h.Symbol.Name],c=o.name;r?a.push(u.identifier(c)):a.push(u`${u.identifier(l)}.${u.identifier(c)}`)}return i<s-1&&a.push(u`, `),a});return u.join(n)}buildSelectQuery({withList:e,fields:r,fieldsFlat:s,where:n,having:o,table:i,joins:a,orderBy:l,groupBy:c,limit:d,offset:m,distinct:y,setOperators:S}){let v=s??ne(r);for(let G of v)if(p(G.field,j)&&Se(G.field.table)!==(p(i,U)?i._.alias:p(i,Ve)?i[L].name:p(i,g)?void 0:Se(i))&&!(F=>a?.some(({alias:ye})=>ye===(F[h.Symbol.IsAlias]?Se(F):F[h.Symbol.BaseName])))(G.field.table)){let F=Se(G.field.table);throw new Error(`Your "${G.path.join("->")}" field references a column "${F}"."${G.field.name}", but the table "${F}" is not part of the query! Did you forget to join it?`)}let E=!a||a.length===0,T=this.buildWithCTE(e),A=y?u` distinct`:void 0,q=this.buildSelection(v,{isSingleTable:E}),N=p(i,h)&&i[h.Symbol.OriginalName]!==i[h.Symbol.Name]?u`${u.identifier(i[h.Symbol.OriginalName])} ${u.identifier(i[h.Symbol.Name])}`:i,M=[];if(a)for(let[G,F]of a.entries()){G===0&&M.push(u` `);let ye=F.table;if(p(ye,R)){let Qr=ye[R.Symbol.Name],Mn=ye[R.Symbol.Schema],An=ye[R.Symbol.OriginalName],On=Qr===An?void 0:F.alias;M.push(u`${u.raw(F.joinType)} join ${Mn?u`${u.identifier(Mn)}.`:void 0}${u.identifier(An)}${On&&u` ${u.identifier(On)}`} on ${F.on}`)}else M.push(u`${u.raw(F.joinType)} join ${ye} on ${F.on}`);G<a.length-1&&M.push(u` `)}let V=u.join(M),se=n?u` where ${n}`:void 0,x=o?u` having ${o}`:void 0,C=[];if(l)for(let[G,F]of l.entries())C.push(F),G<l.length-1&&C.push(u`, `);let P=[];if(c)for(let[G,F]of c.entries())P.push(F),G<c.length-1&&P.push(u`, `);let Ue=P.length>0?u` group by ${u.join(P)}`:void 0,Dt=C.length>0?u` order by ${u.join(C)}`:void 0,ot=d?u` limit ${d}`:void 0,Ft=m?u` offset ${m}`:void 0,Qt=u`${T}select${A} ${q} from ${N}${V}${se}${Ue}${x}${Dt}${ot}${Ft}`;return S.length>0?this.buildSetOperations(Qt,S):Qt}buildSetOperations(e,r){let[s,...n]=r;if(!s)throw new Error("Cannot pass undefined values to any set operator");return n.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:s}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:s}),n)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:s,rightSelect:n,limit:o,orderBy:i,offset:a}}){let l=u`${e.getSQL()} `,c=u`${n.getSQL()}`,d;if(i&&i.length>0){let v=[];for(let E of i)if(p(E,re))v.push(u.identifier(E.name));else if(p(E,g)){for(let T=0;T<E.queryChunks.length;T++){let A=E.queryChunks[T];p(A,re)&&(E.queryChunks[T]=u.identifier(A.name))}v.push(u`${E}`)}else v.push(u`${E}`);d=u` order by ${u.join(v,u`, `)}`}let m=o?u` limit ${o}`:void 0,y=u.raw(`${r} ${s?"all ":""}`),S=a?u` offset ${a}`:void 0;return u`${l}${y}${c}${d}${m}${S}`}buildInsertQuery({table:e,values:r,onConflict:s,returning:n,withList:o}){let i=[],a=e[h.Symbol.Columns],l=Object.entries(a),c=l.map(([,v])=>u.identifier(v.name));for(let[v,E]of r.entries()){let T=[];for(let[A,q]of l){let N=E[A];if(N===void 0||p(N,ee)&&N.value===void 0){let M;if(q.default!==null&&q.default!==void 0)M=p(q.default,g)?q.default:u.param(q.default,q);else if(q.defaultFn!==void 0){let V=q.defaultFn();M=p(V,g)?V:u.param(V,q)}else if(!q.default&&q.onUpdateFn!==void 0){let V=q.onUpdateFn();M=p(V,g)?V:u.param(V,q)}else M=u`null`;T.push(M)}else T.push(N)}i.push(T),v<r.length-1&&i.push(u`, `)}let d=this.buildWithCTE(o),m=u.join(i),y=n?u` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,S=s?u` on conflict ${s}`:void 0;return u`${d}insert into ${e} ${c} values ${m}${S}${y}`}sqlToQuery(e,r){return e.toQuery({escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,invokeSource:r})}buildRelationalQuery({fullSchema:e,schema:r,tableNamesMap:s,table:n,tableConfig:o,queryConfig:i,tableAlias:a,nestedQueryRelation:l,joinOn:c}){let d=[],m,y,S=[],v,E=[];if(i===!0)d=Object.entries(o.columns).map(([q,N])=>({dbKey:N.name,tsKey:q,field:pe(N,a),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let A=Object.fromEntries(Object.entries(o.columns).map(([x,C])=>[x,pe(C,a)]));if(i.where){let x=typeof i.where=="function"?i.where(A,Ko()):i.where;v=x&&ht(x,a)}let q=[],N=[];if(i.columns){let x=!1;for(let[C,P]of Object.entries(i.columns))P!==void 0&&C in o.columns&&(!x&&P===!0&&(x=!0),N.push(C));N.length>0&&(N=x?N.filter(C=>i.columns?.[C]===!0):Object.keys(o.columns).filter(C=>!N.includes(C)))}else N=Object.keys(o.columns);for(let x of N){let C=o.columns[x];q.push({tsKey:x,value:C})}let M=[];i.with&&(M=Object.entries(i.with).filter(x=>!!x[1]).map(([x,C])=>({tsKey:x,queryConfig:C,relation:o.relations[x]})));let V;if(i.extras){V=typeof i.extras=="function"?i.extras(A,{sql:u}):i.extras;for(let[x,C]of Object.entries(V))q.push({tsKey:x,value:ms(C,a)})}for(let{tsKey:x,value:C}of q)d.push({dbKey:p(C,g.Aliased)?C.fieldAlias:o.columns[x].name,tsKey:x,field:p(C,j)?pe(C,a):C,relationTableTsKey:void 0,isJson:!1,selection:[]});let se=typeof i.orderBy=="function"?i.orderBy(A,Go()):i.orderBy??[];Array.isArray(se)||(se=[se]),S=se.map(x=>p(x,j)?pe(x,a):ht(x,a)),m=i.limit,y=i.offset;for(let{tsKey:x,queryConfig:C,relation:P}of M){let Ue=ko(r,s,P),Dt=je(P.referencedTable),ot=s[Dt],Ft=`${a}_${x}`,Qt=ae(...Ue.fields.map((ye,Qr)=>b(pe(Ue.references[Qr],Ft),pe(ye,a)))),G=this.buildRelationalQuery({fullSchema:e,schema:r,tableNamesMap:s,table:e[ot],tableConfig:r[ot],queryConfig:p(P,Ee)?C===!0?{limit:1}:{...C,limit:1}:C,tableAlias:Ft,joinOn:Qt,nestedQueryRelation:P}),F=u`(${G.sql})`.as(x);d.push({dbKey:x,tsKey:x,field:F,relationTableTsKey:ot,isJson:!0,selection:G.selection})}}if(d.length===0)throw new $e({message:`No fields selected for table "${o.tsName}" ("${a}"). You need to have at least one item in "columns", "with" or "extras". If you need to select all columns, omit the "columns" key or set it to undefined.`});let T;if(v=ae(c,v),l){let A=u`json_array(${u.join(d.map(({field:M})=>p(M,re)?u.identifier(M.name):p(M,g.Aliased)?M.sql:M),u`, `)})`;p(l,gt)&&(A=u`coalesce(json_group_array(${A}), json_array())`);let q=[{dbKey:"data",tsKey:"data",field:A.as("data"),isJson:!0,relationTableTsKey:o.tsName,selection:d}];m!==void 0||y!==void 0||S.length>0?(T=this.buildSelectQuery({table:mt(n,a),fields:{},fieldsFlat:[{path:[],field:u.raw("*")}],where:v,limit:m,offset:y,orderBy:S,setOperators:[]}),v=void 0,m=void 0,y=void 0,S=void 0):T=mt(n,a),T=this.buildSelectQuery({table:p(T,R)?T:new U(T,{},a),fields:{},fieldsFlat:q.map(({field:M})=>({path:[],field:p(M,j)?pe(M,a):M})),joins:E,where:v,limit:m,offset:y,orderBy:S,setOperators:[]})}else T=this.buildSelectQuery({table:mt(n,a),fields:{},fieldsFlat:d.map(({field:A})=>({path:[],field:p(A,j)?pe(A,a):A})),joins:E,where:v,limit:m,offset:y,orderBy:S,setOperators:[]});return{tableTsKey:o.tsName,sql:T,selection:d}}},We=class extends fr{static[f]="SQLiteSyncDialect";migrate(e,r,s){let n=s===void 0||typeof s=="string"?"__drizzle_migrations":s.migrationsTable??"__drizzle_migrations",o=u`
			CREATE TABLE IF NOT EXISTS ${u.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;r.run(o);let a=r.values(u`SELECT id, hash, created_at FROM ${u.identifier(n)} ORDER BY created_at DESC LIMIT 1`)[0]??void 0;r.run(u`BEGIN`);try{for(let l of e)if(!a||Number(a[2])<l.folderMillis){for(let c of l.sql)r.run(u.raw(c));r.run(u`INSERT INTO ${u.identifier(n)} ("hash", "created_at") VALUES(${l.hash}, ${l.folderMillis})`)}r.run(u`COMMIT`)}catch(l){throw r.run(u`ROLLBACK`),l}}},Yo=class extends fr{static[f]="SQLiteAsyncDialect";async migrate(e,r,s){let n=s===void 0||typeof s=="string"?"__drizzle_migrations":s.migrationsTable??"__drizzle_migrations",o=u`
			CREATE TABLE IF NOT EXISTS ${u.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;await r.run(o);let a=(await r.values(u`SELECT id, hash, created_at FROM ${u.identifier(n)} ORDER BY created_at DESC LIMIT 1`))[0]??void 0;await r.transaction(async l=>{for(let c of e)if(!a||Number(a[2])<c.folderMillis){for(let d of c.sql)await l.run(u.raw(d));await l.run(u`INSERT INTO ${u.identifier(n)} ("hash", "created_at") VALUES(${c.hash}, ${c.folderMillis})`)}})}};var pr=class{static[f]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}};var oe=class{static[f]="SQLiteSelectBuilder";fields;session;dialect;withList;distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,this.withList=e.withList,this.distinct=e.distinct}from(e){let r=!!this.fields,s;return this.fields?s=this.fields:p(e,U)?s=Object.fromEntries(Object.keys(e._.selectedFields).map(n=>[n,e[n]])):p(e,Ve)?s=e[L].selectedFields:p(e,g)?s={}:s=Wo(e),new mr({table:e,fields:s,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct})}},Ds=class extends pr{static[f]="SQLiteSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:s,session:n,dialect:o,withList:i,distinct:a}){super(),this.config={withList:i,table:e,fields:{...r},distinct:a,setOperators:[]},this.isPartialSelect=s,this.session=n,this.dialect=o,this._={selectedFields:r},this.tableName=vs(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}createJoin(e){return(r,s)=>{let n=this.tableName,o=vs(r);if(typeof o=="string"&&this.config.joins?.some(i=>i.alias===o))throw new Error(`Alias "${o}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof n=="string"&&(this.config.fields={[n]:this.config.fields}),typeof o=="string"&&!p(r,g))){let i=p(r,U)?r._.selectedFields:p(r,te)?r[L].selectedFields:r[h.Symbol.Columns];this.config.fields[o]=i}if(typeof s=="function"&&(s=s(new Proxy(this.config.fields,new X({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:s,table:r,joinType:e,alias:o}),typeof o=="string")switch(e){case"left":{this.joinsNotNullableMap[o]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([i])=>[i,!1])),this.joinsNotNullableMap[o]=!0;break}case"inner":{this.joinsNotNullableMap[o]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([i])=>[i,!1])),this.joinsNotNullableMap[o]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");createSetOperator(e,r){return s=>{let n=typeof s=="function"?s(La()):s;if(!bs(this.getSelectedFields(),n.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:r,rightSelect:n}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);except=this.createSetOperator("except",!1);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new X({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new X({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){let r=e[0](new Proxy(this.config.fields,new X({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){let r=e[0](new Proxy(this.config.fields,new X({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),s=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=s:this.config.orderBy=s}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new U(this.getSQL(),this.config.fields,e),new X({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new X({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}},mr=class extends Ds{static[f]="SQLiteSelect";_prepare(e=!0){if(!this.session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");let r=ne(this.config.fields),s=this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),r,"all",!0);return s.joinsNotNullableMap=this.joinsNotNullableMap,s}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.all()}};Vo(mr,[z]);function hr(t,e){return(r,s,...n)=>{let o=[s,...n].map(i=>({type:t,isAll:e,rightSelect:i}));for(let i of o)if(!bs(r.getSelectedFields(),i.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return r.addSetOperators(o)}}var La=()=>({union:Da,unionAll:Fa,intersect:Qa,except:Ua}),Da=hr("union",!1),Fa=hr("union",!0),Qa=hr("intersect",!1),Ua=hr("except",!1);var gr=class{static[f]="SQLiteQueryBuilder";dialect;$with(e){let r=this;return{as(s){return typeof s=="function"&&(s=s(r)),new Proxy(new ke(s.getSQL(),s.getSelectedFields(),e,!0),new X({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){let r=this;function s(o){return new oe({fields:o??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function n(o){return new oe({fields:o??void 0,session:void 0,dialect:r.getDialect(),withList:e,distinct:!0})}return{select:s,selectDistinct:n}}select(e){return new oe({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new oe({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}getDialect(){return this.dialect||(this.dialect=new We),this.dialect}};var xt=class{constructor(e,r,s,n){this.table=e,this.session=r,this.dialect=s,this.withList=n}static[f]="SQLiteUpdateBuilder";set(e){return new Fs(this.table,cr(this.table,e),this.session,this.dialect,this.withList)}},Fs=class extends z{constructor(e,r,s,n,o){super(),this.session=s,this.dialect=n,this.config={set:r,table:e,withList:o}}static[f]="SQLiteUpdate";config;where(e){return this.config.where=e,this}returning(e=this.config.table[R.Symbol.Columns]){return this.config.returning=ne(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}};var yr=class{constructor(e,r,s,n,o,i,a,l){this.mode=e,this.fullSchema=r,this.schema=s,this.tableNamesMap=n,this.table=o,this.tableConfig=i,this.dialect=a,this.session=l}static[f]="SQLiteAsyncRelationalQueryBuilder";findMany(e){return this.mode==="sync"?new wr(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many"):new St(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return this.mode==="sync"?new wr(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first"):new St(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}},St=class extends z{constructor(e,r,s,n,o,i,a,l,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=s,this.table=n,this.tableConfig=o,this.dialect=i,this.session=a,this.config=l,this.mode=c}static[f]="SQLiteAsyncRelationalQuery";mode;getSQL(){return this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}).sql}_prepare(e=!1){let{query:r,builtQuery:s}=this._toSQL();return this.session[e?"prepareOneTimeQuery":"prepareQuery"](s,void 0,this.mode==="first"?"get":"all",!0,(n,o)=>{let i=n.map(a=>lr(this.schema,this.tableConfig,a,r.selection,o));return this.mode==="first"?i[0]:i})}prepare(){return this._prepare(!1)}_toSQL(){let e=this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}executeRaw(){return this.mode==="first"?this._prepare(!1).get():this._prepare(!1).all()}async execute(){return this.executeRaw()}},wr=class extends St{static[f]="SQLiteSyncRelationalQuery";sync(){return this.executeRaw()}};var Me=class extends z{constructor(e,r,s,n,o){super(),this.execute=e,this.getSQL=r,this.dialect=n,this.mapBatchResult=o,this.config={action:s}}static[f]="SQLiteRaw";config;getQuery(){return{...this.dialect.sqlToQuery(this.getSQL()),method:this.config.action}}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Je=class{constructor(e,r,s,n){this.resultKind=e,this.dialect=r,this.session=s,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap}:{schema:void 0,fullSchema:{},tableNamesMap:{}},this.query={};let o=this.query;if(this._.schema)for(let[i,a]of Object.entries(this._.schema))o[i]=new yr(e,n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,r,s)}static[f]="BaseSQLiteDatabase";query;$with(e){return{as(r){return typeof r=="function"&&(r=r(new gr)),new Proxy(new ke(r.getSQL(),r.getSelectedFields(),e,!0),new X({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){let r=this;function s(l){return new oe({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e})}function n(l){return new oe({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function o(l){return new xt(l,r.session,r.dialect,e)}function i(l){return new wt(l,r.session,r.dialect,e)}function a(l){return new yt(l,r.session,r.dialect,e)}return{select:s,selectDistinct:n,update:o,insert:i,delete:a}}select(e){return new oe({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new oe({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}update(e){return new xt(e,this.session,this.dialect)}insert(e){return new wt(e,this.session,this.dialect)}delete(e){return new yt(e,this.session,this.dialect)}run(e){let r=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.run(r),()=>r,"run",this.dialect,this.session.extractRawRunValueFromBatchResult.bind(this.session)):this.session.run(r)}all(e){let r=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.all(r),()=>r,"all",this.dialect,this.session.extractRawAllValueFromBatchResult.bind(this.session)):this.session.all(r)}get(e){let r=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.get(r),()=>r,"get",this.dialect,this.session.extractRawGetValueFromBatchResult.bind(this.session)):this.session.get(r)}values(e){let r=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.values(r),()=>r,"values",this.dialect,this.session.extractRawValuesValueFromBatchResult.bind(this.session)):this.session.values(r)}transaction(e,r){return this.session.transaction(e,r)}};function Us(...t){return t[0].columns?new br(t[0].columns,t[0].name):new br(t)}var br=class{static[f]="SQLitePrimaryKeyBuilder";columns;name;constructor(e,r){this.columns=e,this.name=r}build(e){return new Qs(e,this.columns,this.name)}},Qs=class{constructor(e,r,s){this.table=e,this.columns=r,this.name=s}static[f]="SQLitePrimaryKey";columns;name;getName(){return this.name??`${this.table[R.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}};var Ks=class extends z{constructor(e){super(),this.resultCb=e}static[f]="ExecuteResultSync";async execute(){return this.resultCb()}sync(){return this.resultCb()}},vr=class{constructor(e,r,s){this.mode=e,this.executeMethod=r,this.query=s}static[f]="PreparedQuery";joinsNotNullableMap;getQuery(){return this.query}mapRunResult(e,r){return e}mapAllResult(e,r){throw new Error("Not implemented")}mapGetResult(e,r){throw new Error("Not implemented")}execute(e){return this.mode==="async"?this[this.executeMethod](e):new Ks(()=>this[this.executeMethod](e))}mapResult(e,r){switch(this.executeMethod){case"run":return this.mapRunResult(e,r);case"all":return this.mapAllResult(e,r);case"get":return this.mapGetResult(e,r)}}},xr=class{constructor(e){this.dialect=e}static[f]="SQLiteSession";prepareOneTimeQuery(e,r,s,n){return this.prepareQuery(e,r,s,n)}run(e){let r=this.dialect.sqlToQuery(e);try{return this.prepareOneTimeQuery(r,void 0,"run",!1).run()}catch(s){throw new $e({cause:s,message:`Failed to run the query '${r.sql}'`})}}extractRawRunValueFromBatchResult(e){return e}all(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).all()}extractRawAllValueFromBatchResult(e){throw new Error("Not implemented")}get(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).get()}extractRawGetValueFromBatchResult(e){throw new Error("Not implemented")}values(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).values()}extractRawValuesValueFromBatchResult(e){throw new Error("Not implemented")}},Sr=class extends Je{constructor(e,r,s,n,o=0){super(e,r,s,n),this.schema=n,this.nestedIndex=o}static[f]="SQLiteTransaction";rollback(){throw new tr}};var Er=class extends xr{constructor(e,r,s,n={}){super(r),this.client=e,this.schema=s,this.logger=n.logger??new or}static[f]="BetterSQLiteSession";logger;prepareQuery(e,r,s,n,o){let i=this.client.prepare(e.sql);return new zs(i,e,this.logger,r,s,n,o)}transaction(e,r={}){let s=new Gs("sync",this.dialect,this,this.schema);return this.client.transaction(e)[r.behavior??"deferred"](s)}},Gs=class t extends Sr{static[f]="BetterSQLiteTransaction";transaction(e){let r=`sp${this.nestedIndex}`,s=new t("sync",this.dialect,this.session,this.schema,this.nestedIndex+1);this.session.run(u.raw(`savepoint ${r}`));try{let n=e(s);return this.session.run(u.raw(`release savepoint ${r}`)),n}catch(n){throw this.session.run(u.raw(`rollback to savepoint ${r}`)),n}}},zs=class extends vr{constructor(e,r,s,n,o,i,a){super("sync",o,r),this.stmt=e,this.logger=s,this.fields=n,this._isResponseInArrayMode=i,this.customResultMapper=a}static[f]="BetterSQLitePreparedQuery";run(e){let r=pt(this.query.params,e??{});return this.logger.logQuery(this.query.sql,r),this.stmt.run(...r)}all(e){let{fields:r,joinsNotNullableMap:s,query:n,logger:o,stmt:i,customResultMapper:a}=this;if(!r&&!a){let c=pt(n.params,e??{});return o.logQuery(n.sql,c),i.all(...c)}let l=this.values(e);return a?a(l):l.map(c=>ws(r,c,s))}get(e){let r=pt(this.query.params,e??{});this.logger.logQuery(this.query.sql,r);let{fields:s,stmt:n,joinsNotNullableMap:o,customResultMapper:i}=this;if(!s&&!i)return n.get(...r);let a=n.raw().get(...r);if(a)return i?i([a]):ws(s,a,o)}values(e){let r=pt(this.query.params,e??{});return this.logger.logQuery(this.query.sql,r),this.stmt.raw().all(...r)}isResponseInArrayMode(){return this._isResponseInArrayMode}};function Xo(t,e={}){let r=new We,s;e.logger===!0?s=new nr:e.logger!==!1&&(s=e.logger);let n;if(e.schema){let i=zo(e.schema,Ho);n={fullSchema:e.schema,schema:i.tables,tableNamesMap:i.tableNamesMap}}let o=new Er(t,r,n,{logger:s});return new Je("sync",r,o,n)}var Oi=Ut(Ai());var Ys={};ma(Ys,{attachments:()=>de,conversationMembers:()=>ve,conversations:()=>I,folders:()=>ie,messageGroupMessages:()=>J,messageGroups:()=>H,messages:()=>O,participants:()=>Z,sessions:()=>Tt,users:()=>It});var Z=ce("participants",{id:_("id").primaryKey({autoIncrement:!0}),username:$("username").notNull().unique(),role:$("role").notNull().default("member"),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),ie=ce("folders",{id:$("id").primaryKey(),name:$("name").notNull(),description:$("description"),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),I=ce("conversations",{id:$("id").primaryKey(),title:$("title").notNull(),systemMessage:$("system_message").default(""),userId:_("user_id").default(1),enableSystemMessage:dr("enable_system_message").default("1"),folderId:$("folder_id").references(()=>ie.id),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),O=ce("messages",{id:$("id").primaryKey(),conversationId:$("conversation_id").notNull().references(()=>I.id),participantId:_("participant_id").notNull().references(()=>Z.id),content:$("content").notNull(),parentId:$("parent_id"),reasoningContent:$("reasoning_content"),collapsed:dr("collapsed").default("0"),hasError:dr("has_error").default("0"),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),It=ce("users",{id:_("id").primaryKey({autoIncrement:!0}),username:$("username").notNull().unique(),email:$("email").notNull().unique(),fullname:$("fullname").notNull(),passwd:$("passwd").notNull(),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),ve=ce("conversation_members",{conversationId:$("conversation_id").notNull().references(()=>I.id),participantId:_("participant_id").notNull().references(()=>Z.id)},t=>({pk:Us({columns:[t.conversationId,t.participantId]})})),H=ce("message_groups",{id:$("id").primaryKey(),conversationId:$("conversation_id").notNull().references(()=>I.id),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),J=ce("message_group_messages",{messageId:$("message_id").notNull().references(()=>O.id),messageGroupId:$("message_group_id").notNull().references(()=>H.id)},t=>({pk:Us({columns:[t.messageId,t.messageGroupId]})})),de=ce("attachments",{id:$("id").primaryKey(),filename:$("filename").notNull(),mimetype:$("mimetype").notNull(),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)}),Tt=ce("sessions",{id:$("id").primaryKey(),userId:_("user_id").notNull().references(()=>It.id),sessionToken:$("session_token").notNull().unique(),expiresAt:_("expires_at",{mode:"timestamp"}).notNull(),createdAt:_("created_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`),updatedAt:_("updated_at",{mode:"timestamp"}).notNull().default(u`(strftime('%s', 'now'))`)});var yl=new Oi.default("sqlite.db"),w=Xo(yl,{schema:Ys});var Xe=async t=>await w.insert(Z).values(t).returning(),Xs=async t=>await w.select().from(Z).where(b(Z.id,t)).get(),Zs=async t=>await w.select().from(Z).where(b(Z.username,t)).get();var Ri=Ut(require("crypto")),Or=new Uint8Array(256),Ar=Or.length;function en(){return Ar>Or.length-16&&(Ri.default.randomFillSync(Or),Ar=0),Or.slice(Ar,Ar+=16)}var K=[];for(let t=0;t<256;++t)K.push((t+256).toString(16).slice(1));function _i(t,e=0){return K[t[e+0]]+K[t[e+1]]+K[t[e+2]]+K[t[e+3]]+"-"+K[t[e+4]]+K[t[e+5]]+"-"+K[t[e+6]]+K[t[e+7]]+"-"+K[t[e+8]]+K[t[e+9]]+"-"+K[t[e+10]]+K[t[e+11]]+K[t[e+12]]+K[t[e+13]]+K[t[e+14]]+K[t[e+15]]}var Bi=Ut(require("crypto")),tn={randomUUID:Bi.default.randomUUID};function wl(t,e,r){if(tn.randomUUID&&!e&&!t)return tn.randomUUID();t=t||{};let s=t.random||(t.rng||en)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){r=r||0;for(let n=0;n<16;++n)e[r+n]=s[n];return e}return _i(s)}var Re=wl;var Ct=async t=>{let e={...t,id:t.id||Re()};return await w.insert(I).values(e).returning()},fe=async t=>await w.select().from(I).where(b(I.id,t)).get(),rn=async()=>await w.select({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt}).from(I).orderBy(le(I.updatedAt)).all(),Pi=async t=>await w.select({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt}).from(I).where(b(I.userId,t)).orderBy(le(I.updatedAt)).all(),sn=async(t,e)=>{let r={...e,updatedAt:new Date};return await w.update(I).set(r).where(b(I.id,t)).returning({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt})},nn=async t=>(await w.delete(O).where(b(O.conversationId,t)),await w.delete(ve).where(b(ve.conversationId,t)),await w.delete(I).where(b(I.id,t)).returning({id:I.id,title:I.title,createdAt:I.createdAt,updatedAt:I.updatedAt}));var jt=async t=>await w.insert(O).values(t).returning();var on=async t=>await w.select().from(O).where(b(O.id,t)).orderBy(le(O.createdAt)).all(),qt=async t=>{console.log(`Attempting to delete message with ID: ${t}`);let e=await w.delete(O).where(b(O.id,t.toString())).returning();return console.log("Delete message result:",e),e},an=async t=>{console.log(`Attempting to delete message with conversation ID: ${t}`);let e=await w.delete(O).where(b(O.conversationId,t)).returning();return console.log("Delete message result:",e),e},ln=async(t,e)=>{console.log(`Attempting to update message with ID: ${t}`,e);let r=await w.update(O).set(e).where(b(O.id,t)).returning();return console.log("Update message result:",r),r},Nt=async t=>await w.select({id:O.id,content:O.content,username:Z.username,role:Z.role,createdAt:O.createdAt,parentId:O.parentId,collapsed:O.collapsed,groupId:J.messageGroupId,replyCount:u`(SELECT COUNT(*) FROM messages AS replies WHERE replies.parent_id = messages.id)`.as("replyCount")}).from(O).innerJoin(Z,b(O.participantId,Z.id)).leftJoin(J,b(O.id,J.messageId)).where(b(O.conversationId,t)).orderBy(sr(O.createdAt)).all();var cn=async t=>await w.insert(ve).values(t).returning();var Rr=async(t,e)=>!!await w.select().from(ve).where(ae(b(ve.conversationId,t),b(ve.participantId,e))).get();var un=async t=>{let e={...t,id:t.id||Re()};return await w.insert(ie).values(e).returning()},$t=async t=>await w.select().from(ie).where(b(ie.id,t)).get(),dn=async()=>await w.select().from(ie).orderBy(le(ie.updatedAt)).all(),fn=async(t,e)=>{let r={...e,updatedAt:new Date};return await w.update(ie).set(r).where(b(ie.id,t)).returning()},pn=async t=>(await w.delete(I).where(b(I.folderId,t)),await w.delete(ie).where(b(ie.id,t)).returning());var mn=async t=>{let e={...t,id:t.id||Re()},[r]=await w.insert(H).values(e).returning();return r},hn=async()=>await w.select().from(H).all(),he=async t=>await w.select().from(H).where(b(H.id,t)).get(),Ze=async t=>await w.select().from(H).where(b(H.conversationId,t)).all(),gn=async t=>!!await w.select({id:H.id}).from(H).where(b(H.id,t)).get(),yn=async(t,e)=>{let r={...e,updatedAt:new Date};return await w.update(H).set(r).where(b(H.id,t)).returning()},Mt=async t=>(await w.delete(J).where(b(J.messageGroupId,t)),await w.delete(H).where(b(H.id,t)).returning());var At=async t=>await w.insert(J).values(t).returning(),Ot=async t=>await w.select().from(J).where(b(J.messageGroupId,t)).all();var Rt=async(t,e)=>await w.delete(J).where(ae(b(J.messageId,t),b(J.messageGroupId,e))).returning();var _r=async t=>await w.insert(de).values(t).returning(),_t=async t=>await w.select().from(de).where(b(de.id,t)).all(),wn=async()=>await w.select().from(de).orderBy(le(de.createdAt)).all(),bn=async(t,e)=>await w.update(de).set(e).where(b(de.id,t)).returning(),vn=async t=>await w.delete(de).where(b(de.id,t)).returning();var xn=async t=>await w.select().from(It).where(b(It.id,t)).get();var Sn=async t=>{let e=new Date;return await w.select().from(Tt).where(ae(b(Tt.sessionToken,t),rr(Tt.expiresAt,e))).get()};var _e=async(t,e)=>{let r=t.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return t.json({success:!1,error:"Missing or invalid authorization token"},401);let s=r.substring(7);if(!s)return t.json({success:!1,error:"Invalid authorization token"},401);let n=await Sn(s);if(!n)return t.json({success:!1,error:"Invalid or expired session"},401);let o=await xn(n.userId);if(!o)return t.json({success:!1,error:"User not found"},401);t.set("user",{id:o.id,username:o.username}),await e()};var xe=new Q;xe.post("/participants",async t=>{try{let e=await t.req.json(),r=await Xe(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create participant"},400)}});xe.get("/participants/:id",async t=>{try{let e=parseInt(t.req.param("id")),r=await Xs(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Participant not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch participant"},500)}});xe.post("/conversations",_e,async t=>{try{let e=await t.req.json(),r=await Ct(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create conversation"},400)}});xe.get("/conversations",_e,async t=>{try{let e=await rn();return t.json({success:!0,data:e})}catch{return t.json({success:!1,error:"Failed to fetch conversations"},500)}});xe.get("/conversations/:id",_e,async t=>{try{let e=t.req.param("id"),r=await fe(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Conversation not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch conversation"},500)}});xe.post("/conversations/:conversationId/messages",_e,async t=>{try{let e=t.req.param("conversationId"),r=await t.req.json();if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let n=t.get("user");if(!await Rr(e,n.id))return t.json({success:!1,error:"You are not a member of this conversation"},403);let i=await jt({...r,conversationId:e,participantId:n.id});return t.json({success:!0,data:i})}catch{return t.json({success:!1,error:"Failed to create message"},400)}});xe.get("/conversations/:conversationId/messages",_e,async t=>{try{let e=t.req.param("conversationId");if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let s=t.get("user");if(!await Rr(e,s.id))return t.json({success:!1,error:"You are not a member of this conversation"},403);let o=await Nt(e);return t.json({success:!0,data:o})}catch{return t.json({success:!1,error:"Failed to fetch messages"},500)}});xe.post("/conversations/:conversationId/members",_e,async t=>{try{let e=t.req.param("conversationId"),r=await t.req.json();if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let n=t.get("user"),o=await cn({...r,conversationId:e,participantId:n.id});return t.json({success:!0,data:o})}catch{return t.json({success:!1,error:"Failed to add member"},400)}});var Li=xe;var et=new Q;et.post("/",async t=>{try{let e=await t.req.json(),r=await un(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create folder"},400)}});et.get("/",async t=>{try{let e=await dn();return t.json({success:!0,data:e})}catch(e){return console.error("Error fetching folders:",e),t.json({success:!1,error:"Failed to fetch folders"},500)}});et.get("/:id",async t=>{try{let e=t.req.param("id"),r=await $t(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Folder not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch folder"},500)}});et.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if(!await $t(e))return t.json({success:!1,error:"Folder not found"},404);let n=await fn(e,r);return n.length===0?t.json({success:!1,error:"Failed to update folder"},500):t.json({success:!0,data:n[0],message:"Folder updated successfully"})}catch(e){return console.error("Error updating folder:",e),t.json({success:!1,error:"Failed to update folder"},500)}});et.delete("/:id",async t=>{try{let e=t.req.param("id");return await $t(e)?(await pn(e)).length===0?t.json({success:!1,error:"Failed to delete folder"},500):t.json({success:!0,message:"Folder deleted successfully"}):t.json({success:!1,error:"Folder not found"},404)}catch(e){return console.error("Error deleting folder:",e),t.json({success:!1,error:"Failed to delete folder"},500)}});var Di=et;var Be=new Q;Be.post("/",async t=>{try{let e=await t.req.json(),r=await Ct(e);return t.json({success:!0,data:r})}catch{return t.json({success:!1,error:"Failed to create conversation"},400)}});Be.get("/users/:userId",async t=>{try{let e=parseInt(t.req.param("userId")),r=await Pi(e);return t.json({success:!0,data:r})}catch(e){return console.error("Error fetching conversations:",e),t.json({success:!1,error:"Failed to fetch conversations"},500)}});Be.get("/:id",async t=>{try{let e=t.req.param("id"),r=await fe(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Conversation not found"},404)}catch{return t.json({success:!1,error:"Failed to fetch conversation"},500)}});Be.get("/:id/message-groups",async t=>{try{let e=t.req.param("id");if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let s=await Ze(e);return t.json({success:!0,data:s})}catch(e){return console.error("Error fetching message groups:",e),t.json({success:!1,error:"Failed to fetch message groups"},500)}});Be.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if(!await fe(e))return t.json({success:!1,error:"Conversation not found"},404);let n=await sn(e,r);return n.length===0?t.json({success:!1,error:"Failed to update conversation"},500):t.json({success:!0,data:n[0],message:"Conversation updated successfully"})}catch(e){return console.error("Error updating conversation:",e),t.json({success:!1,error:"Failed to update conversation"},500)}});Be.delete("/:id",async t=>{try{let e=t.req.param("id"),r=await fe(e);if(!r)return t.json({success:!1,error:"Conversation not found"},404);let s=await Ze(e);for(let o of s){let i=o.id,a=await Ot(i);for(let l of a){let{messageId:c}=l;await Rt(c,i);try{await qt(c)}catch(d){console.error(d)}}console.log({messageGroupMessages:a}),await Mt(i)}console.log({messageGroups:s});let n=await an(e);return n=await nn(e),n.length===0?t.json({success:!1,error:"Failed to delete conversation"},500):t.json({success:!0,message:"Conversation deleted successfully",data:r})}catch(e){return console.error("Error deleting conversation:",e),t.json({success:!1,error:"Failed to delete conversation"},500)}});var Fi=Be;var Bt=new Q;Bt.post("/conversations/:conversationId",async t=>{try{let e=t.req.param("conversationId"),r=await t.req.json(),s;if(r.username){if(s=await Zs(r.username),!s){let c={username:r.username,role:r.role||"user"};console.log("Create participant",c);let[d]=await Xe(c);s=d}}else{let c={username:r.username||`participant_${Date.now()}`,role:r.role||"user"},[d]=await Xe(c);s=d}console.log("Using participant",s);let{groupId:n,...o}=r,i={id:o.id?.toString()||Math.floor(Math.random()*1e6).toString(),content:o.content,conversationId:e,participantId:s.id,parentId:o.parentId},[a]=await on(i.id);if(!a){let[c]=await jt(i);a=c}if(n&&a){let c=await gn(n);if(console.log({groupExists:c}),c){let d=await At({messageId:a.id,messageGroupId:n});console.log({messageGroupMessage:d})}}let l={...a,groupId:r.groupId||null};return t.json({success:!0,data:[l]})}catch(e){return console.error("Error creating message:",e),t.json({success:!1,error:"Failed to create message"},400)}});Bt.get("/conversations/:conversationId",async t=>{try{let e=t.req.param("conversationId"),r=await Nt(e);return t.json({success:!0,data:r})}catch(e){return console.error("Error fetching messages:",e),t.json({success:!1,error:"Failed to fetch messages"},500)}});Bt.delete("/conversations/:conversationId/:messageId",async t=>{try{let e=t.req.param("messageId");return console.log(`Delete message request - Message ID: ${e}`),(await qt(e)).length===0?(console.log(`Message not found for ID: ${e}`),t.json({success:!1,error:"Message not found"},404)):(console.log(`Message deleted successfully - ID: ${e}`),t.json({success:!0,message:"Message deleted successfully"}))}catch(e){return console.error("Error deleting message:",e),t.json({success:!1,error:"Failed to delete message"},500)}});Bt.put("/conversations/:conversationId/:messageId",async t=>{try{let e=t.req.param("messageId"),r=await t.req.json();console.log(`Update message request - Message ID: ${e}`,r);let{id:s,conversationId:n,participantId:o,...i}=r,{groupId:a}=r,l=await on(r.id);console.log({existing:l});let c=await ln(e,i);return c.length===0?(console.log(`Message not found for ID: ${e}`),t.json({success:!1,error:"Message not found"},404)):(console.log(`Message updated successfully - ID: ${e}`),t.json({success:!0,data:c.map(d=>(d.id===e&&(d.groupId=a),d))}))}catch(e){return console.error("Error updating message:",e),t.json({success:!1,error:"Failed to update message"},500)}});var Qi=Bt;var Pe=new Q;Pe.post("/",async t=>{try{let e=await t.req.json(),{id:r}=e,s=await he(r);return s||(s=await mn(e)),t.json({success:!0,data:s})}catch(e){return console.error("Error creating message group:",e),t.json({success:!1,error:"Failed to create message group"},400)}});Pe.get("/",async t=>{try{let e=await hn();return t.json({success:!0,data:e})}catch(e){return console.error("Error fetching message groups:",e),t.json({success:!1,error:"Failed to fetch message groups"},500)}});Pe.get("/conversation/:conversationId",async t=>{try{let e=t.req.param("conversationId"),r=await Ze(e);return t.json({success:!0,data:r})}catch(e){return console.error("Error fetching message groups by conversation ID:",e),t.json({success:!1,error:"Failed to fetch message groups by conversation ID"},500)}});Pe.get("/:id",async t=>{try{let e=t.req.param("id"),r=await he(e);return r?t.json({success:!0,data:r}):t.json({success:!1,error:"Message group not found"},404)}catch(e){return console.error("Error fetching message group:",e),t.json({success:!1,error:"Failed to fetch message group"},500)}});Pe.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if(!await he(e))return t.json({success:!1,error:"Message group not found"},404);let n=await yn(e,r);return n.length===0?t.json({success:!1,error:"Failed to update message group"},500):t.json({success:!0,data:n[0],message:"Message group updated successfully"})}catch(e){return console.error("Error updating message group:",e),t.json({success:!1,error:"Failed to update message group"},500)}});Pe.delete("/:id",async t=>{try{let e=t.req.param("id");return await he(e)?(await Mt(e)).length===0?t.json({success:!1,error:"Failed to delete message group"},500):t.json({success:!0,message:"Message group deleted successfully"}):t.json({success:!1,error:"Message group not found"},404)}catch(e){return console.error("Error deleting message group:",e),t.json({success:!1,error:"Failed to delete message group"},500)}});var Ui=Pe;var Br=new Q;Br.post("/:messageGroupId",async t=>{try{let e=t.req.param("messageGroupId"),r=await t.req.json();if(!await he(e))return t.json({success:!1,error:"Message group not found"},404);let n=await At({messageId:r.messageId,messageGroupId:e});return t.json({success:!0,data:n})}catch(e){return console.error("Error creating message group message:",e),t.json({success:!1,error:"Failed to create message group message"},400)}});Br.get("/:messageGroupId",async t=>{try{let e=t.req.param("messageGroupId");if(!await he(e))return t.json({success:!1,error:"Message group not found"},404);let s=await Ot(e);return t.json({success:!0,data:s})}catch(e){return console.error("Error fetching message group messages:",e),t.json({success:!1,error:"Failed to fetch message group messages"},500)}});Br.delete("/:messageGroupId/:messageId",async t=>{try{let e=t.req.param("messageGroupId"),r=t.req.param("messageId");return await he(e)?(await Rt(r,e)).length===0?t.json({success:!1,error:"Message group message not found"},404):t.json({success:!0,message:"Message group message deleted successfully"}):t.json({success:!1,error:"Message group not found"},404)}catch(e){return console.error("Error deleting message group message:",e),t.json({success:!1,error:"Failed to delete message group message"},500)}});var Ki=Br;var tt=require("fs"),En=require("path"),Gi=require("crypto"),bl=t=>({"image/jpeg":".jpg","image/png":".png","image/gif":".gif","image/svg+xml":".svg","image/webp":".webp","text/plain":".txt","text/html":".html","text/css":".css","text/csv":".csv","application/json":".json","application/pdf":".pdf","application/zip":".zip","application/x-tar":".tar","application/javascript":".js","application/xml":".xml","application/msword":".doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":".docx","application/vnd.ms-excel":".xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":".xlsx","application/vnd.ms-powerpoint":".ppt","application/vnd.openxmlformats-officedocument.presentationml.presentation":".pptx"})[t]||"",Le=new Q;Le.post("/",async t=>{try{let e=await t.req.json();if(!e.filename)return t.json({success:!1,error:"Filename is required"},400);if(!e.mimetype)return t.json({success:!1,error:"Mimetype is required"},400);let r={id:e.id||Math.floor(Math.random()*1e6).toString(),filename:e.filename,mimetype:e.mimetype},[s]=await _r(r);return t.json({success:!0,data:[s]})}catch(e){return console.error("Error creating attachment:",e),t.json({success:!1,error:"Failed to create attachment"},500)}});Le.post("/download",async t=>{try{let e=await t.req.json();if(!e.url)return t.json({success:!1,error:"URL is required"},400);let r=(0,En.join)(process.cwd(),"file_attachments");(0,tt.existsSync)(r)||(0,tt.mkdirSync)(r,{recursive:!0});let s=(0,Gi.randomUUID)(),n=(0,En.join)(r,s),o=await fetch(e.url);if(!o.ok)return t.json({success:!1,error:"Failed to download file from URL"},400);let i=(0,tt.createWriteStream)(n),a=await o.arrayBuffer(),l=Buffer.from(a);i.write(l),i.end();let c=e.url.split("/").pop()||"downloaded_file",d=e.filename||c,m=o.headers.get("content-type")||"application/octet-stream",y=bl(m);y&&!d.endsWith(y)&&(d=`${d}${y}`);let S={id:s,filename:d,mimetype:m},[v]=await _r(S);return t.json({success:!0,data:[v]})}catch(e){return console.error("Error downloading attachment:",e),t.json({success:!1,error:"Failed to download attachment"},500)}});Le.get("/",async t=>{try{let e=await wn();return t.json({success:!0,data:e})}catch(e){return console.error("Error fetching attachments:",e),t.json({success:!1,error:"Failed to fetch attachments"},500)}});Le.get("/:id",async t=>{try{let e=t.req.param("id"),r=await _t(e);return r.length===0?t.json({success:!1,error:"Attachment not found"},404):t.json({success:!0,data:r})}catch(e){return console.error("Error fetching attachment:",e),t.json({success:!1,error:"Failed to fetch attachment"},500)}});Le.put("/:id",async t=>{try{let e=t.req.param("id"),r=await t.req.json();if((await _t(e)).length===0)return t.json({success:!1,error:"Attachment not found"},404);let{id:n,...o}=r,i=await bn(e,o);return t.json({success:!0,data:i})}catch(e){return console.error("Error updating attachment:",e),t.json({success:!1,error:"Failed to update attachment"},500)}});Le.delete("/:id",async t=>{try{let e=t.req.param("id");if((await _t(e)).length===0)return t.json({success:!1,error:"Attachment not found"},404);let s=await vn(e);return t.json({success:!0,message:"Attachment deleted successfully"})}catch(e){return console.error("Error deleting attachment:",e),t.json({success:!1,error:"Failed to delete attachment"},500)}});var zi=Le;var De=new Q;De.route("/folders",Di);De.route("/conversations",Fi);De.route("/messages",Qi);De.route("/message-groups",Ui);De.route("/message-group-messages",Ki);De.route("/attachments",zi);var ki=De;var In=class{writer;encoder;writable;abortSubscribers=[];responseReadable;aborted=!1;closed=!1;constructor(t,e){this.writable=t,this.writer=t.getWriter(),this.encoder=new TextEncoder;let r=e.getReader();this.abortSubscribers.push(async()=>{await r.cancel()}),this.responseReadable=new ReadableStream({async pull(s){let{done:n,value:o}=await r.read();n?s.close():s.enqueue(o)},cancel:()=>{this.abort()}})}async write(t){try{typeof t=="string"&&(t=this.encoder.encode(t)),await this.writer.write(t)}catch{}return this}async writeln(t){return await this.write(t+`
`),this}sleep(t){return new Promise(e=>setTimeout(e,t))}async close(){try{await this.writer.close()}catch{}this.closed=!0}async pipe(t){this.writer.releaseLock(),await t.pipeTo(this.writable,{preventClose:!0}),this.writer=this.writable.getWriter()}onAbort(t){this.abortSubscribers.push(t)}abort(){this.aborted||(this.aborted=!0,this.abortSubscribers.forEach(t=>t()))}};var Pr=()=>{let t=typeof Bun<"u"?Bun.version:void 0;if(t===void 0)return!1;let e=t.startsWith("1.1")||t.startsWith("1.0")||t.startsWith("0.");return Pr=()=>e,e};var Hi=class extends In{constructor(t,e){super(t,e)}async writeSSE(t){let r=(await it(t.data,Ht.Stringify,!1,{})).split(`
`).map(n=>`data: ${n}`).join(`
`),s=[t.event&&`event: ${t.event}`,r,t.id&&`id: ${t.id}`,t.retry&&`retry: ${t.retry}`].filter(Boolean).join(`
`)+`

`;await this.write(s)}},vl=async(t,e,r)=>{try{await e(t)}catch(s){s instanceof Error&&r?(await r(s,t),await t.writeSSE({event:"error",data:s.message})):console.error(s)}finally{t.close()}},xl=new WeakMap,Tn=(t,e,r)=>{let{readable:s,writable:n}=new TransformStream,o=new Hi(n,s);return Pr()&&t.req.raw.signal.addEventListener("abort",()=>{o.closed||o.abort()}),xl.set(o.responseReadable,t),t.header("Transfer-Encoding","chunked"),t.header("Content-Type","text/event-stream"),t.header("Cache-Control","no-cache"),t.header("Connection","keep-alive"),vl(o,e,r),t.newResponse(o.responseReadable)};function El(t){return Array.isArray(t.prompt)}async function Il(t,e,r,s){return s.header("Content-Type","text/event-stream"),s.header("Cache-Control","no-cache"),s.header("Connection","keep-alive"),Tn(s,async n=>{if(t){let o=1;for await(let i of t)await n.write(i)}})}async function Tl(t,e,r,s){let n={id:"chatcmpl-"+Date.now(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:e};for await(let o of t)t=o;return r?n.choices=t.choices.map((o,i)=>({index:i,role:o.message.role,text:o.message.content,finish_reason:"stop"})):n.choices=t.choices.map((o,i)=>({index:i,message:{role:o.message.role,content:o.message.content},finish_reason:"stop"})),s.json(n)}async function*Cl(t){let e=1,r=`Hello world is another
  message that used to be the starter 
  programmmer to start learning`;if(t.stream){let s={id:`chatcmpl-${Date.now()}`,model:t.model,object:"chat.completion.chunk",index:e,finish_reason:null,created:Date.now(),choices:[{delta:{content:r}}]},n=r.split(`
`),o=new TextEncoder,i=0;for(;i<n.length;)yield o.encode(`data: ${JSON.stringify({id:`chatcmpl-${Date.now()}`,model:t.model,object:"chat.completion.chunk",index:i,finish_reason:null,created:Date.now(),choices:[{delta:{content:n[i]}}],done:!0})}

`),i+=1;yield o.encode(`data: ${JSON.stringify({id:`chatcmpl-${Date.now()}`,model:t.model,object:"chat.completion.chunk",index:i,finish_reason:"done",created:Date.now(),choices:[{delta:{content:""}}],done:!0})}

data: [DONE]

`)}else yield{choices:[{message:{role:"assistant",content:r}}]}}async function Vi(t,e){typeof t.stream!="boolean"&&(t.stream=!0),console.log(t.stream);let r=await Cl(t);console.log({response:r});let s=t.stream,n=El(t),o=t.model;return s?await Il(r,o,n,e):await Tl(r,o,n,e)}var ge=new Q;ge.use("*",ro());ge.use("*",so);ge.use("*",Zn());ge.route("/api",Li);ge.route("/api/llm",ki);ge.get("/",t=>t.json({success:!0,message:"Chat Backend API is running!",timestamp:new Date().toISOString()}));ge.post("/v1/chat/completions",async t=>{let e=await t.req.json();return await Vi(e,t)});ge.notFound(t=>t.json({success:!1,error:"Route not found"},404));ge.onError((t,e)=>(console.error("Error:",t),e.json({success:!1,error:"Internal server error"},500)));var Wi=ge;var Yi=require("http"),Xi=require("http2"),Lr=require("http2"),Cn=require("stream"),sa=Ut(require("crypto"),1),Fe=class extends Error{constructor(t,e){super(t,e),this.name="RequestError"}},jl=t=>t instanceof Fe?t:new Fe(t.message,{cause:t}),ql=global.Request,Pt=class extends ql{constructor(t,e){typeof t=="object"&&nt in t&&(t=t[nt]()),typeof e?.body?.getReader<"u"&&(e.duplex??="half"),super(t,e)}},Zi=Symbol("wrapBodyStream"),Nl=(t,e,r,s)=>{let n=[],o=r.rawHeaders;for(let a=0;a<o.length;a+=2){let{[a]:l,[a+1]:c}=o;l.charCodeAt(0)!==58&&n.push([l,c])}let i={method:t,headers:n,signal:s.signal};if(t==="TRACE"){i.method="GET";let a=new Pt(e,i);return Object.defineProperty(a,"method",{get(){return"TRACE"}}),a}if(!(t==="GET"||t==="HEAD"))if("rawBody"in r&&r.rawBody instanceof Buffer)i.body=new ReadableStream({start(a){a.enqueue(r.rawBody),a.close()}});else if(r[Zi]){let a;i.body=new ReadableStream({async pull(l){try{a||=Cn.Readable.toWeb(r).getReader();let{done:c,value:d}=await a.read();c?l.close():l.enqueue(d)}catch(c){l.error(c)}}})}else i.body=Cn.Readable.toWeb(r);return new Pt(e,i)},nt=Symbol("getRequestCache"),$l=Symbol("requestCache"),jn=Symbol("incomingKey"),Dr=Symbol("urlKey"),st=Symbol("abortControllerKey"),Ml=Symbol("getAbortController"),Fr={get method(){return this[jn].method||"GET"},get url(){return this[Dr]},[Ml](){return this[nt](),this[st]},[nt](){return this[st]||=new AbortController,this[$l]||=Nl(this.method,this[Dr],this[jn],this[st])}};["body","bodyUsed","cache","credentials","destination","headers","integrity","mode","redirect","referrer","referrerPolicy","signal","keepalive"].forEach(t=>{Object.defineProperty(Fr,t,{get(){return this[nt]()[t]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(t=>{Object.defineProperty(Fr,t,{value:function(){return this[nt]()[t]()}})});Object.setPrototypeOf(Fr,Pt.prototype);var Al=(t,e)=>{let r=Object.create(Fr);r[jn]=t;let s=t.url||"";if(s[0]!=="/"&&(s.startsWith("http://")||s.startsWith("https://"))){if(t instanceof Lr.Http2ServerRequest)throw new Fe("Absolute URL for :path is not allowed in HTTP/2");try{let a=new URL(s);r[Dr]=a.href}catch(a){throw new Fe("Invalid absolute URL",{cause:a})}return r}let n=(t instanceof Lr.Http2ServerRequest?t.authority:t.headers.host)||e;if(!n)throw new Fe("Missing host header");let o;if(t instanceof Lr.Http2ServerRequest){if(o=t.scheme,!(o==="http"||o==="https"))throw new Fe("Unsupported scheme")}else o=t.socket&&t.socket.encrypted?"https":"http";let i=new URL(`${o}://${n}${s}`);if(i.hostname.length!==n.length&&i.hostname!==n.replace(/:\d+$/,""))throw new Fe("Invalid host header");return r[Dr]=i.href,r},Ji=Symbol("responseCache"),rt=Symbol("getResponseCache"),Qe=Symbol("cache"),Nn=global.Response,Lt=class ea{#t;#e;[rt](){return delete this[Qe],this[Ji]||=new Nn(this.#t,this.#e)}constructor(e,r){let s;if(this.#t=e,r instanceof ea){let n=r[Ji];if(n){this.#e=n,this[rt]();return}else this.#e=r.#e,s=new Headers(r.#e.headers)}else this.#e=r;(typeof e=="string"||typeof e?.getReader<"u"||e instanceof Blob||e instanceof Uint8Array)&&(s||=r?.headers||{"content-type":"text/plain; charset=UTF-8"},this[Qe]=[r?.status||200,e,s])}get headers(){let e=this[Qe];return e?(e[2]instanceof Headers||(e[2]=new Headers(e[2])),e[2]):this[rt]().headers}get status(){return this[Qe]?.[0]??this[rt]().status}get ok(){let e=this.status;return e>=200&&e<300}};["body","bodyUsed","redirected","statusText","trailers","type","url"].forEach(t=>{Object.defineProperty(Lt.prototype,t,{get(){return this[rt]()[t]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(t=>{Object.defineProperty(Lt.prototype,t,{value:function(){return this[rt]()[t]()}})});Object.setPrototypeOf(Lt,Nn);Object.setPrototypeOf(Lt.prototype,Nn.prototype);async function Ol(t){return Promise.race([t,Promise.resolve().then(()=>Promise.resolve(void 0))])}function ta(t,e,r){let s=()=>{};return e.on("error",s),(r??t.read()).then(i,n),t.closed.finally(()=>{e.off("error",s)});function n(a){a&&e.destroy(a)}function o(){t.read().then(i,n)}function i({done:a,value:l}){try{if(a)e.end();else if(!e.write(l))e.once("drain",o);else return t.read().then(i,n)}catch(c){n(c)}}}function Rl(t,e){if(t.locked)throw new TypeError("ReadableStream is locked.");return e.destroyed?void 0:ta(t.getReader(),e)}var ra=t=>{let e={};t instanceof Headers||(t=new Headers(t??void 0));let r=[];for(let[s,n]of t)s==="set-cookie"?r.push(n):e[s]=n;return r.length>0&&(e["set-cookie"]=r),e["content-type"]??="text/plain; charset=UTF-8",e},_l="x-hono-already-sent",Bl=global.fetch;typeof global.crypto>"u"&&(global.crypto=sa.default);global.fetch=(t,e)=>(e={compress:!1,...e},Bl(t,e));var $n=Symbol("outgoingEnded"),Pl=()=>new Response(null,{status:400}),na=t=>new Response(null,{status:t instanceof Error&&(t.name==="TimeoutError"||t.constructor.name==="TimeoutError")?504:500}),qn=(t,e)=>{let r=t instanceof Error?t:new Error("unknown error",{cause:t});r.code==="ERR_STREAM_PREMATURE_CLOSE"?console.info("The user aborted a request."):(console.error(t),e.headersSent||e.writeHead(500,{"Content-Type":"text/plain"}),e.end(`Error: ${r.message}`),e.destroy(r))},oa=t=>{"flushHeaders"in t&&t.writable&&t.flushHeaders()},ia=async(t,e)=>{let[r,s,n]=t[Qe];n instanceof Headers&&(n=ra(n)),typeof s=="string"?n["Content-Length"]=Buffer.byteLength(s):s instanceof Uint8Array?n["Content-Length"]=s.byteLength:s instanceof Blob&&(n["Content-Length"]=s.size),e.writeHead(r,n),typeof s=="string"||s instanceof Uint8Array?e.end(s):s instanceof Blob?e.end(new Uint8Array(await s.arrayBuffer())):(oa(e),await Rl(s,e)?.catch(o=>qn(o,e))),e[$n]?.()},Ll=async(t,e,r={})=>{if(t instanceof Promise)if(r.errorHandler)try{t=await t}catch(n){let o=await r.errorHandler(n);if(!o)return;t=o}else t=await t.catch(na);if(Qe in t)return ia(t,e);let s=ra(t.headers);if(t.body){let n=t.body.getReader(),o=[],i=!1,a,l=2;for(let c=0;c<l;c++){a||=n.read();let d=await Ol(a).catch(m=>{console.error(m),i=!0});if(!d){if(c===1&&s["transfer-encoding"]!=="chunked"){await new Promise(m=>setTimeout(m)),l=3;continue}break}if(a=void 0,d.value&&o.push(d.value),d.done){i=!0;break}}i&&!("content-length"in s)&&(s["content-length"]=o.reduce((c,d)=>c+d.length,0)),e.writeHead(t.status,s),o.forEach(c=>{e.write(c)}),i?e.end():(o.length===0&&oa(e),await ta(n,e,a))}else s[_l]||(e.writeHead(t.status,s),e.end());e[$n]?.()},Dl=(t,e={})=>{let r=e.autoCleanupIncoming??!0;return e.overrideGlobalObjects!==!1&&global.Request!==Pt&&(Object.defineProperty(global,"Request",{value:Pt}),Object.defineProperty(global,"Response",{value:Lt})),async(s,n)=>{let o,i;try{i=Al(s,e.hostname);let a=!r||s.method==="GET"||s.method==="HEAD";if(a||(s[Zi]=!0,s.on("end",()=>{a=!0}),s instanceof Xi.Http2ServerRequest&&(n[$n]=()=>{a||setTimeout(()=>{a||setTimeout(()=>{s.destroy(),n.destroy()})})})),n.on("close",()=>{i[st]&&(s.errored?i[st].abort(s.errored.toString()):n.writableFinished||i[st].abort("Client connection prematurely closed.")),a||setTimeout(()=>{a||setTimeout(()=>{s.destroy()})})}),o=t(i,{incoming:s,outgoing:n}),Qe in o)return ia(o,n)}catch(a){if(o)return qn(a,n);if(e.errorHandler){if(o=await e.errorHandler(i?a:jl(a)),!o)return}else i?o=na(a):o=Pl()}try{return await Ll(o,n,e)}catch(a){return qn(a,n)}}},Fl=t=>{let e=t.fetch,r=Dl(e,{hostname:t.hostname,overrideGlobalObjects:t.overrideGlobalObjects,autoCleanupIncoming:t.autoCleanupIncoming});return(t.createServer||Yi.createServer)(t.serverOptions||{},r)},aa=(t,e)=>{let r=Fl(t);return r.listen(t?.port??3e3,t.hostname,()=>{let s=r.address();e&&e(s)}),r};var la=parseInt(process.env.PORT||"5007");console.log(`Server is running on port ${la}`);aa({fetch:Wi.fetch,port:la});
